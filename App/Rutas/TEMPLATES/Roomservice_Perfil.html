<style>
    /* ===== Estilos generales del pago ===== */
    #vista-pago {
        background: #ffffff;
        padding: 30px 40px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-top: 10px;
        margin-left: 30px;
        margin-right: 30px;
        font-family: 'Poppins', sans-serif;
        color: #333;
    }

    /* T√≠tulos */
    #vista-pago h2,
    #vista-pago h3 {
        text-align: left;
        color: #2b2b2b;
        margin-bottom: 15px;
    }

    #vista-pago h2 {
        font-size: 22px;
        border-bottom: 2px solid #28a745;
        display: inline-block;
        padding-bottom: 5px;
    }

    #vista-pago h3 {
        font-size: 18px;
        margin-top: 25px;
    }

    /* ===== Formularios ===== */
    .formulario-pago {
        margin-bottom: 10px;
    }

    .fila {
        display: flex;
        gap: 15px;
        margin-bottom: 12px;
    }

    .fila input {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .fila input:focus {
        border-color: #28a745;
        box-shadow: 0 0 5px rgba(40, 167, 69, 0.3);
        outline: none;
    }

    /* ===== M√©todo de pago ===== */
    .metodo-pago {
        display: flex;
        gap: 30px;
        margin-bottom: 15px;
        font-weight: 500;
    }

    .metodo-pago label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

    .metodo-pago input[type="radio"] {
        accent-color: #28a745;
    }

    /* ===== Tabla resumen ===== */
    .tabla-resumen {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        margin-bottom: 20px;
        font-size: 14px;
    }

    .tabla-resumen th {
        background: #f0f0f0;
        text-align: left;
        padding: 8px;
        font-weight: 600;
    }

    .tabla-resumen td {
        padding: 8px;
        border-bottom: 1px solid #3498db;
    }

    /* ===== Botones ===== */
    .botones-pago {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }

    .botones-pago button {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .botones-pago button:first-child {
        background: #f0f0f0;
        color: #333;
    }

    .botones-pago button:first-child:hover {
        background: #ddd;
    }

    .pagar-btn {
        background: #28a745;
        color: #fff;
        box-shadow: 0 3px 8px rgba(40, 167, 69, 0.3);
    }

    .pagar-btn:hover {
        background: #218838;
    }

    #vista-productos,
    #vista-pago {
        transition: opacity 0.4s ease;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
    }

    .modal-contenido {
        background: #fff;
        border-radius: 12px;
        padding: 25px;
        width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .formulario-pago .fila {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .formulario-pago input {
        flex: 1;
        padding: 8px;
    }

    .metodo-pago {
        display: flex;
        gap: 30px;
        margin-bottom: 15px;
    }

    .tabla-resumen {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .tabla-resumen th,
    .tabla-resumen td {
        border-bottom: 1px solid #ddd;
        padding: 8px;
    }

    .botones-modal {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 15px;
    }

    .volver-btn {
        background: #ccc;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
    }

    .pagar-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
    }




    .reserva-item {
        background-color: #f9f9f9;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }

    .reserva-item:hover {
        transform: scale(1.02);
    }

    #resultados-reservas p {
        font-size: 15px;
        text-align: center;
        color: #555;


    }

    .cantidad-cell {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .cantidad-cell button {
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        width: 25px;
        height: 25px;
        font-weight: bold;
        cursor: pointer;
    }

    .cantidad-cell button:hover {
        background-color: #2980b9;
    }

    .cantidad {
        min-width: 20px;
        text-align: center;
    }


    .search-filters-section {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        flex-wrap: wrap;
    }

    .search-section {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
        min-width: 300px;
    }

    .search-label {
        font-weight: 600;
        color: #2c3e50;
        white-space: nowrap;
    }

    .search-form {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
    }

    .search-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
        min-width: 200px;
    }

    .search-input:focus {
        outline: none;
        border-color: #28a745;
    }

    .search-button {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .search-button:hover {
        background: #218838;
    }

    .filters-section {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filter-label {
        font-weight: 600;
        color: #2c3e50;
        white-space: nowrap;
    }

    .filter-form {
        display: flex;
        align-items: center;
    }

    .rol-select {
        padding: 12px 16px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        background: white;
        font-size: 14px;
        cursor: pointer;
        transition: border-color 0.3s ease;
        min-width: 150px;
    }

    .rol-select:focus {
        outline: none;
        border-color: #28a745;
    }

    .actions-section {
        margin-left: auto;
    }

    .create-button {
        background: #28a745;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.3s ease;
        white-space: nowrap;
        border: none;
        cursor: pointer;
    }

    .create-button:hover {
        background: #218838;
        color: white;
        text-decoration: none;
    }

    /* Tabla de empleados */
    .table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 30px;
    }

    /* üîπ Estilo del bot√≥n cuadrado */
    .btn-cuadrado {
        width: 25px;
        height: 25px;
        border: 2px solid #28a745;
        border-radius: 4px;
        background-color: white;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-cuadrado.seleccionado {
        background-color: #28a745;
    }

    .productos-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .productos-table thead {
        background: #2c3e50;
        color: white;

    }

    .productos-table th {
        padding: 16px 20px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
        align-items: center;
        text-align: center;
    }

    /* Estilos espec√≠ficos para encabezados de columna */


    .productos-table tbody tr {
        border-bottom: 1px solid #e9ecef;
        transition: background-color 0.3s ease;
        align-items: center;
        text-align: center;
    }

    .productos-table tbody tr:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }

    .productos-table tbody tr:last-child {
        border-bottom: none;
    }

    .productos-table td {
        padding: 16px 20px;
        vertical-align: middle;
    }

    cantidad-input .productos-table td cantidad-input {
        padding: 16px 20px;
        vertical-align: middle;
    }

    .phone-cell {
        font-weight: 500;
        color: #495057;
    }

    .name-cell {
        font-weight: 600;
        color: #2c3e50;
    }

    .shift-cell {
        text-align: center !important;
        vertical-align: middle;
    }

    .shift-badge {
        background: #e3f2fd;
        color: #1976d2;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
        text-align: center;
    }

    .actions-cell {
        text-align: right !important;
        padding-right: 25px !important;
    }

    .action-buttons {
        display: flex !important;
        gap: 8px;
        justify-content: flex-end !important;
    }

    .action-btn {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }



    .edit-btn {
        background: #ffc107;
        color: #212529;
    }

    .edit-btn:hover {
        background: #e0a800;
        color: #212529;
        text-decoration: none;
        transform: scale(1.1);
    }

    .delete-btn {
        background: #dc3545;
        color: white;
        border: none;
    }

    .delete-btn:hover {
        background: #c82333;
        color: white;
        text-decoration: none;
        transform: scale(1.1);
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group input,
    .form-group select {
        padding: var(--spacing-md);
        border: 1px solid var(--border-light);
        border-radius: var(--border-radius);
        font-size: var(--spacing-md);
        color: var(--text-primary);
        background-color: var(--bg-primary);
        transition: var(--transition);
    }

    .form-group input:focus,
    .form-group select:focus {
        border-color: var(--primary-green);
        box-shadow: 0 0 0 3px rgba(50, 131, 54, 0.15);
    }


    .radio-group {
        display: flex;
        gap: 20px;
        align-items: center;
        margin-bottom: 20px;
    }

    .radio-group label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 14px;
    }

    .radio-group input[type="radio"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        font-size: 14px;
    }

    .summary-row.total {
        border-top: 2px solid #eee;
        padding-top: 15px;
        margin-top: 20px;
        font-weight: 600;
        font-size: 16px;
    }

    .pay-button {
        width: 100%;
        border: none;
        border-radius: 25px;
        padding: 15px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        background-color: var(--primary-green);
        margin-top: 20px;
        color: white;
    }

    .pay-button:hover {
        background-color: #4CAF50;
    }




    @media (max-width: 768px) {
        .main-content {
            grid-template-columns: 1fr;
        }

        .form-row {
            grid-template-columns: 1fr;
        }
    }
</style>
<link rel="stylesheet" href="../../Static/CSS/style.css">
<link rel="stylesheet" href="../../Static/CSS/home.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">


<div id="vista-productos">
    <div class="search-filters-section">
        <!-- üîç Buscar reserva -->
        <div class="search-section">
            <label for="numero-comprobante" class="search-label">Ingresa el n√∫mero de comprobante</label>
            <div class="search-form">
                <input type="text" id="numero-comprobante" class="search-input" placeholder="Ejemplo: B001-000123">
                <button type="button" class="search-button" onclick="buscarReserva()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>

        <!-- üìã Aqu√≠ se mostrar√°n los resultados -->

    </div>

    <div id="resultados-reservas" class="reservas-lista" style="margin-top: 20px; margin-bottom: 20px;"></div>

    <!-- üßæ Secci√≥n de servicio -->
    <div class="search-filters-section" style="align-items: flex-end;">

        <!-- üè® Fechas y habitaci√≥n -->
        <div class="filters-section" style="flex-wrap: wrap; gap: 20px;">
            <div>
                <label for="fecha-entrada" class="filter-label">Fecha entrada</label>
                <input type="date" id="fecha-entrada" class="rol-select" readonly>
            </div>
            <div>
                <label for="fecha-salida" class="filter-label">Fecha salida</label>
                <input type="date" id="fecha-salida" class="rol-select" readonly>
            </div>
            <div>
                <label for="hora-entrada" class="filter-label">Hora entrada</label>
                <input type="time" id="hora-entrada" class="rol-select" readonly>
            </div>
            <div>
                <label for="hora-salida" class="filter-label">Hora salida</label>
                <input type="time" id="hora-salida" class="rol-select" readonly>
            </div>
            <div>
                <label for="habitaciones" class="filter-label">Habitaciones</label>
                <select id="habitaciones" class="rol-select">
                    <option value="">Seleccione</option>
                </select>
            </div>
        </div>
        <div>
            <label for="producto" class="filter-label">Productos a llevar</label>
            <div class="filter-form" style="display:flex; gap:10px;">
                <select id="producto" class="rol-select">
                    <option value="">Seleccione</option>
                    {% for amenidad in amenidades %}
                    <option value="{{ amenidad[0] }}">{{ amenidad[1] }}</option>
                    {% endfor %}
                </select>
                <button class="action-btn calendar-btn" onclick="agregarProducto()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- üßÆ Tabla de productos -->
    <div class="table-container">
        <table class="productos-table" id="tabla-productos">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Total</th>
                    <th>ACCIONES</th>
                </tr>
            </thead>
            <tbody id="productos-body">
                <!-- Fila vac√≠a inicial -->
                <tr id="fila-vacia">
                    <td colspan="5" style="text-align:center; color:#888;">
                        üõí Empiece a insertar productos
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- üí∞ Total y bot√≥n solicitar -->
    <div style="display: flex; justify-content: flex-end; align-items: center; gap: 20px; margin-top: 10px;">
        <div id="total-general-container" style="text-align:right; margin-top:10px; font-weight:bold;">
            Total general: S/ <span id="total-general">0.00</span>
        </div>

        <button class="create-button" style="background:#28a745;" onclick="mostrarPago()">
            Solicitar
        </button>
    </div>

</div>


<div id="vista-pago" style="display:none;">
    <h2>DATOS PARA PAGO FINAL</h2>

    <div id="formNatural">
        <div class="form-row">
            <div class="form-group">
                <label>Apellido paterno</label>
                <input type="text" name="ape_paterno" pattern="^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√± ]{3,50}">
            </div>
            <div class="form-group">
                <label>Apellido materno</label>
                <input type="text" name="ape_materno" pattern="^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√± ]{3,50}">
            </div>

        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Nombres</label>
                <input type="text" name="nombres" pattern="^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√± ]{3,50}">
            </div>

            <div class="form-group">
                <label>Pa√≠s</label>
                <select id="pais_select" name="pais_id">
                    <option value="">-- Seleccione pa√≠s --</option>
                    {% for country in countries %}
                    <option value="{{ country[0] }}">{{ country[1] }}</option>
                    {% endfor %}
                    <!-- si tienes la lista desde el backend, reemplaza estas opciones dinamicamente -->
                </select>
            </div>

        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Tel√©fono</label>
                <input type="tel" name="telefono" maxlength="9" pattern="^9[0-9]{8}$">
            </div>
            <div class="form-group">
                <label>Tipo de documento</label>
                <select id="tipo_doc_id" name="tipo_doc_id">
                    <option value="">-- Seleccione tipo --</option>
                    {% for doc in tipo_doc %}
                    <option value="{{ doc[0] }}">{{ doc[1] }}</option>
                    {% endfor %}
                    <!-- si tienes la lista desde el backend, reemplaza estas opciones dinamicamente -->
                </select>
            </div>
            <div class="form-group">
                <label>Nro. de documento</label>
                <input type="text" name="nro_doc">
            </div>
        </div>


    </div>

    <h3>M√âTODO DE PAGO</h3>
    <div class="radio-group" style="margin-bottom: 20px;">
        {% for metodo in metodos_pago %}
        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
            <input type="radio" name="metodo_pago_id" value="{{ metodo[0] }}" data-nombre="{{ metodo[1]|lower }}" {% if
                loop.first %}checked{% endif %}>


            {{ metodo[1] }}
        </label>
        {% endfor %}
    </div>

    <!-- Campos adicionales seg√∫n m√©todo -->
    <div id="tarjeta-fields" class="form-row hidden" style="flex-direction: column; gap: 10px;">
        <div class="form-group">
            <label>Nro. de tarjeta</label>
            <input type="text" name="num_tarjeta" maxlength="19" oninput="formatCardNumber(this)" placeholder="1234 5678 9012 3456" class="form-control">
        </div>
        <div class="form-group">
            <label>C√≥digo de seguridad</label>
            <input type="text" name="codigo_seguridad" maxlength="3" placeholder="123" class="form-control">
        </div>
    </div>

    <div id="efectivo-fields" class="form-row hidden" style="flex-direction: column; gap: 10px;">
        <div class="form-group">
            <label>Monto entregado</label>
            <input type="number" name="monto_efectivo" placeholder="0.00" step="0.01" class="form-control">
        </div>
    </div>

    <div id="monedero-fields" class="form-row hidden" style="flex-direction: column; gap: 10px;">
        <div class="form-group">
            <label>N√∫mero de tel√©fono</label>
            <input type="text" name="telefono_monedero" maxlength="9" placeholder="987654321" class="form-control">
        </div>
        <div class="form-group">
            <label>Clave del monedero</label>
            <input type="password" name="clave_monedero" maxlength="3" placeholder="***" class="form-control">
        </div>
    </div>

    <style>
        .hidden {
            display: none;
        }
    </style>

    <label>
        <input type="radio" name="tipo_comprobante" id="tipo_comprobante" value="B" checked>
        Boleta
    </label>
    <label for="" style="margin-left: 15px;"></label>
    <label>
        <input type="radio" name="tipo_comprobante" id="tipo_comprobante" value="F">
        Factura
    </label>

    <h3>Resumen de pago</h3>
    <table id="tabla-resumen" class="tabla-resumen">
        <thead>
            <tr>
                <th>Productos</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr>
                <td style="text-align:right; font-weight:bold;">Total:</td>
                <td id="resumen-total" style="font-weight:bold;">S/ 0.00</td>
            </tr>
        </tfoot>
    </table>

    <div class="botones-pago">
        <button onclick="volverProductos()">‚Üê Volver</button>
        <button class="pagar-btn" onclick="procesarPagoRoomService()">Pagar</button>
    </div>
</div>
<script>
    async function buscarReserva() {
        const numeroComprobante = document.getElementById('numero-comprobante').value.trim();

        if (!numeroComprobante) {
            alert("‚ö†Ô∏è Por favor, ingresa un n√∫mero de comprobante.");
            return;
        }

        try {
            const response = await fetch(`/Roomservice/buscar_reserva/${numeroComprobante}`);
            const data = await response.json();

            if (!data) {
                alert('‚ùå No se encontr√≥ ninguna reserva con ese comprobante.');
                limpiarCampos();
                return;
            }

            // Llenar los campos del formulario
            document.getElementById('fecha-entrada').value = data.fecha_ingreso;
            document.getElementById('fecha-salida').value = data.fecha_salida;
            document.getElementById('hora-entrada').value = data.hora_ingreso;
            document.getElementById('hora-salida').value = data.hora_salida;

            // Llenar el combo de habitaciones
            // Llenar el combo de habitaciones
            const select = document.getElementById('habitaciones');
            select.innerHTML = '<option value="">Seleccione</option>';
            if (data.habitaciones && data.habitaciones.length > 0) {
                data.habitaciones.forEach(h => {
                    const option = document.createElement('option');
                    option.value = h.reserva_habitacion_id;  // ‚ö° Guardamos el ID real
                    option.textContent = `Habitaci√≥n ${h.numero}`;
                    select.appendChild(option);
                });
            }

        } catch (err) {
            console.error("Error al buscar reserva:", err);
            alert("‚ùå Ocurri√≥ un error al buscar la reserva.");
        }
    }

    function limpiarCampos() {
        document.getElementById('fecha-entrada').value = '';
        document.getElementById('fecha-salida').value = '';
        document.getElementById('hora-entrada').value = '';
        document.getElementById('hora-salida').value = '';
        const select = document.getElementById('habitaciones');
        select.innerHTML = '<option value="">Seleccione</option>';
    }
</script>
<script type="application/json" id="amenidades-data">
    {{ amenidades | tojson }}
</script>
<script>
    const tablaBody = document.getElementById("productos-body");
    const amenidades = JSON.parse(document.getElementById('amenidades-data').textContent);

    function agregarProducto() {
        const select = document.getElementById('producto');
        const productoId = select.value;

        if (!productoId) {
            alert('Por favor, seleccione un producto.');
            return;
        }

        // Buscar el producto en la lista de amenidades
        const producto = amenidades.find(p => p[0] == productoId);

        if (!producto) {
            alert('Producto no encontrado.');
            return;
        }

        const nombre = producto[1];
        const precio = parseFloat(producto[2]);

        // Eliminar la fila vac√≠a si existe
        const filaVacia = document.getElementById("fila-vacia");
        if (filaVacia) filaVacia.remove();

        // Crear fila nueva
        const fila = document.createElement('tr');
        fila.setAttribute('data-amenidad-id', productoId);
        fila.innerHTML = `
            <td class="nombre-prod">${nombre}</td>
            <td class="cantidad-cell">
                <button class="btn-menos">‚àí</button>
                <span class="cantidad-prod">1</span>
                <button class="btn-mas">+</button>
            </td>
            <td class="subtotal-prod">${precio.toFixed(2)}</td>
            <td class="total-prod">${precio.toFixed(2)}</td>
            <td class="actions-cell">
                <div class="action-buttons" style="align-items:center;">
                    <button class="action-btn delete-btn" onclick="eliminarFila(this)">
                        <i class="fas fa-ban"></i>
                    </button>
                </div>
            </td>
            `;

        tablaBody.appendChild(fila);

        // üîπ Recalcula el total general despu√©s de agregar producto
        actualizarTotalGeneral();

        // Reinicia el combo
        select.value = '';
    }

    // Delegaci√≥n de eventos sobre la tabla
    document.getElementById("tabla-productos").addEventListener("click", function (e) {
        const fila = e.target.closest("tr");
        if (!fila) return;

        // Bot√≥n +
        if (e.target.classList.contains("btn-mas")) {
            const cantidadSpan = fila.querySelector(".cantidad-prod");
            let cantidad = parseInt(cantidadSpan.textContent);
            cantidad++;
            cantidadSpan.textContent = cantidad;
            actualizarTotales(fila);
        }

        // Bot√≥n ‚àí
        if (e.target.classList.contains("btn-menos")) {
            const cantidadSpan = fila.querySelector(".cantidad-prod");
            let cantidad = parseInt(cantidadSpan.textContent);
            if (cantidad > 1) {
                cantidad--;
                cantidadSpan.textContent = cantidad;
                actualizarTotales(fila);
            }
        }
    });

    // üîπ Recalcular total general
    function actualizarTotalGeneral() {
        const totales = document.querySelectorAll('.total-prod');
        let suma = 0;
        totales.forEach(td => {
            suma += parseFloat(td.textContent) || 0;
        });
        document.getElementById('total-general').textContent = suma.toFixed(2);
    }

    // üîπ Actualizar totales por fila
    function actualizarTotales(fila) {
        const cantidad = parseInt(fila.querySelector('.cantidad-prod').textContent);
        const precioUnitario = parseFloat(fila.querySelector('.subtotal-prod').textContent);
        const nuevoTotal = cantidad * precioUnitario;
        fila.querySelector('.total-prod').textContent = nuevoTotal.toFixed(2);

        // Actualiza el total general cada vez que se recalcula un producto
        actualizarTotalGeneral();
    }

    // üîπ Eliminar fila
    function eliminarFila(btn) {
        const fila = btn.closest('tr');
        fila.remove();
        verificarTablaVacia();
        actualizarTotalGeneral(); // tambi√©n actualiza al eliminar
    }

    // üîπ Verificar si la tabla est√° vac√≠a
    function verificarTablaVacia() {
        if (tablaBody.children.length === 0) {
            tablaBody.innerHTML = `
                <tr id="fila-vacia">
                    <td colspan="5" style="text-align:center; color:gray;">
                        Empiece a insertar productos
                    </td>
                </tr>`;
            document.getElementById('total-general').textContent = '0.00';
        }
    }
</script>


<script>
    function mostrarPago() {
        const vistaProductos = document.getElementById("vista-productos");
        const vistaPago = document.getElementById("vista-pago");

        // Obtener los productos actuales
        const filas = document.querySelectorAll("#tabla-productos tbody tr");
        const resumenBody = document.querySelector("#tabla-resumen tbody");
        resumenBody.innerHTML = "";

        filas.forEach(fila => {
            const nombre = fila.querySelector("td")?.textContent;
            const total = fila.querySelector(".total-prod")?.textContent;
            if (nombre && total) {
                const nuevaFila = document.createElement("tr");
                nuevaFila.innerHTML = `<td>${nombre}</td><td>S/ ${total}</td>`;
                resumenBody.appendChild(nuevaFila);
            }
        });

        // Actualiza el total general
        const totalGeneral = document.getElementById("total-general").textContent;
        document.getElementById("resumen-total").textContent = "S/ " + totalGeneral;

        // Oculta la vista de productos y muestra la de pago
        vistaProductos.style.display = "none";
        vistaPago.style.display = "block";
    }

    function volverProductos() {
        document.getElementById("vista-pago").style.display = "none";
        document.getElementById("vista-productos").style.display = "block";
    }

</script>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const radios = document.querySelectorAll('input[name="metodo_pago_id"]');
        const tarjetaFields = document.getElementById('tarjeta-fields');
        const efectivoFields = document.getElementById('efectivo-fields');
        const monederoFields = document.getElementById('monedero-fields');

        function mostrarCampos(nombreMetodo) {
            // Ocultamos todos los campos
            tarjetaFields.classList.add('hidden');
            efectivoFields.classList.add('hidden');
            monederoFields.classList.add('hidden');

            // Mostramos el que corresponde
            if (nombreMetodo === 'tarjeta') tarjetaFields.classList.remove('hidden');
            else if (nombreMetodo === 'efectivo') efectivoFields.classList.remove('hidden');
            else if (nombreMetodo === 'yape' || nombreMetodo === 'monedero virtual') monederoFields.classList.remove('hidden');
        }

        // Escuchamos los cambios
        radios.forEach(radio => {
            radio.addEventListener('change', () => {
                const nombre = radio.dataset.nombre;
                mostrarCampos(nombre);
            });
        });

        // Si ya hay uno marcado por defecto
        const checked = document.querySelector('input[name="metodo_pago_id"]:checked');
        if (checked) mostrarCampos(checked.dataset.nombre);
    });
</script>

<script>
    function procesarPagoRoomService() {
        // 1Ô∏è‚É£ Validaciones b√°sicas
        const reservaHabitacionId = document.getElementById('habitaciones').value;
        const metodo_pago_id = document.querySelector('input[name="metodo_pago_id"]:checked')?.value;
        const tipo_comprobante = document.querySelector('input[name="tipo_comprobante"]:checked')?.value;
        const total_general = parseFloat(document.getElementById('total-general').textContent || 0);

        if (!reservaHabitacionId) {
            alert("‚ö†Ô∏è Selecciona una habitaci√≥n antes de continuar.");
            return;
        }
        if (!metodo_pago_id) {
            alert("‚ö†Ô∏è Selecciona un m√©todo de pago.");
            return;
        }
        if (!tipo_comprobante) {
            alert("‚ö†Ô∏è Selecciona el tipo de comprobante (Boleta o Factura).");
            return;
        }

        // 2Ô∏è‚É£ Capturar los datos del cliente desde los inputs
        const cliente_data = {
            tipo_doc_id: document.querySelector('select[name="tipo_doc_id"]').value,
            nro_doc: document.querySelector('input[name="nro_doc"]').value,
            pais_id: document.querySelector('select[name="pais_id"]').value,
            telefono: document.querySelector('input[name="telefono"]').value,
            nombres: document.querySelector('input[name="nombres"]').value,
            ape_paterno: document.querySelector('input[name="ape_paterno"]').value,
            ape_materno: document.querySelector('input[name="ape_materno"]').value
        };

        // 3Ô∏è‚É£ Capturar los productos de la tabla
        const productos = [];
        const filas = document.querySelectorAll("#productos-body tr");
        filas.forEach(fila => {
            if (fila.id !== "fila-vacia") {
                const amenidad_id = fila.dataset.amenidadId;  // ‚Üê aseg√∫rate de guardarlo al agregar productos
                const nombre = fila.querySelector(".nombre-prod").textContent.trim();
                const cantidad = parseInt(fila.querySelector(".cantidad-prod").textContent);
                const subtotal = parseFloat(fila.querySelector(".subtotal-prod").textContent);
                const total = parseFloat(fila.querySelector(".total-prod").textContent);

                productos.push({
                    amenidad_id,
                    nombre,
                    cantidad,
                    subtotal,
                    total
                });
            }
        });

        // 4Ô∏è‚É£ Construir el objeto completo que espera el backend
        const data = {
            tipo_cliente: 'N', // Natural por ahora
            cliente: cliente_data,
            metodo_pago_id,
            tipo_comprobante,
            total_general,
            productos,
            reserva_habitacion_id: reservaHabitacionId
        };

        console.log("üì¶ Enviando datos al backend:", data);

        // 5Ô∏è‚É£ Enviar al backend v√≠a fetch
        fetch('/Roomservice/procesar_pago_roomservice', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(resp => {
        if (resp.success) {
            // ‚úÖ Mostrar mensaje bonito
            alert(`‚úÖ ${resp.message}\nComprobante: ${resp.comprobante}`);

            // üïí Esperar un poco y luego redirigir
            setTimeout(() => {
                if (resp.redirect_url) {
                    window.top.location.href = resp.redirect_url;
                } else {
                    // Si no hay redirect_url, recarga la p√°gina
                    location.reload();
                }
            }, 1200);
        } else {
            alert("‚ùå Error: " + resp.error);
        }
    })
    .catch(err => {
        console.error(err);
        alert("‚ö†Ô∏è Error al enviar los datos al servidor.");
    });
    }
</script>

<script>
    function formatCardNumber(input) {
        // Elimina todo lo que no sea d√≠gito
        let value = input.value.replace(/\D/g, '');

        // Agrupa en bloques de 4 d√≠gitos y une con guiones
        value = value.match(/.{1,4}/g)?.join('-') || '';

        // Limita a 19 caracteres (16 d√≠gitos + 3 guiones)
        input.value = value.slice(0, 19);
    }
</script>