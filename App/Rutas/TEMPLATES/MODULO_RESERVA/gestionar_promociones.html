{% extends "/MODULO_RESERVA/Crud_reserva.html" %}

{% block promociones_content %}
<div class="section-content" id="promociones">
                <h2 class="section-title">Gestionar Promociones</h2>

                <div class="alert alert-success" id="alert-promo-success" style="display: none;"></div>
                <div class="alert alert-error" id="alert-promo-error" style="display: none;"></div>

                <div class="form-promocion"
                    style="background: #f9f9f9; padding: 25px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #328336;">
                    
                    <h3 style="color: #328336; margin-top: 0;">
                        <i class="fas fa-plus-circle"></i> Crear Nueva Promoción
                    </h3>

                    <form id="form-promocion" style="margin-bottom: 0;">
                        
                        <div class="form-grid" style="margin-bottom: 25px;">
                            <div class="form-group">
                                <label for="promo-tipo">Tipo de Promoción *</label>
                                <select id="promo-tipo" name="tipo_promocion_id" required>
                                    <option value="">Cargando tipos...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="promo-porcentaje">Porcentaje de Descuento (%) *</label>
                                <input type="number" id="promo-porcentaje" name="porcentaje" placeholder="Ej: 15" min="1"
                                    max="100" required>
                            </div>

                            <div class="form-group">
                                <label for="promo-fecha-inicio">Fecha de Inicio *</label>
                                <input type="date" id="promo-fecha-inicio" name="fecha_inicio" required>
                            </div>

                            <div class="form-group">
                                <label for="promo-fecha-fin">Fecha de Fin *</label>
                                <input type="date" id="promo-fecha-fin" name="fecha_fin" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="promo-descripcion">Descripción Breve *</label>
                            <input type="text" id="promo-descripcion" name="descripcion"
                                placeholder="Ej: Descuento de fin de semana" required>
                        </div>

                        <div class="form-actions" style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #f0f0f0;">
                            <button type="submit" class="btn btn-primary" id="btn-guardar-promo">
                                <i class="fas fa-save"></i> Guardar Promoción
                            </button>
                        </div>
                    </form>
                </div>

                <h3 style="color: #333; border-bottom: 2px solid #ddd; padding-bottom: 10px;">Promociones Existentes</h3>
                <div class="table-container">
                    <table class="empleados-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Descripción</th>
                                <th>Descuento</th>
                                <th>Vigencia</th>
                                <th>Estado</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-promociones-body">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px;">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
</div>
<script>
    // ### INICIO DE CÓDIGO NUEVO: Lógica para Promociones ###
    // Cargar los tipos de promoción para el combo del formulario
    async function cargarTiposPromocion() {
        const select = document.getElementById('promo-tipo');
        if (!select) return; // Salir si no se encuentra el combo

        try {
            const response = await fetch('/promociones/tipos');
            const data = await response.json();
            if (data.success) {
                select.innerHTML = '<option value="" disabled selected>Seleccione un tipo...</option>';
                data.tipos.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.id_tipo_promocion;
                    option.textContent = tipo.nombre;
                    select.appendChild(option);
             });
            } else {
                 select.innerHTML = '<option value="">Error al cargar</option>';
            }
        } catch (e) {
            console.error("Error cargando tipos de promo:", e);
            select.innerHTML = '<option value="">Error de red</option>';
        }
    }

    // Cargar la lista de promociones existentes (VERSIÓN CORREGIDA)
    async function cargarPromociones() {
        const tbody = document.getElementById('tabla-promociones-body');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Cargando...</td></tr>';

        try {
            const response = await fetch('/promociones/todas');
            const data = await response.json();

            if (data.success && data.promociones.length > 0) {
                tbody.innerHTML = ''; // Limpiar el "Cargando..."
                
                data.promociones.forEach(promo => {
                    const tr = document.createElement('tr'); // 1. Crear la fila

                    // --- SOLUCIÓN: Crear celda por celda (método seguro) ---

                    // Celda ID
                    const tdId = document.createElement('td');
                    tdId.textContent = promo.id_promocion;
                    tr.appendChild(tdId);

                    // Celda Descripción
                    const tdDesc = document.createElement('td');
                    tdDesc.textContent = promo.descripcion;
                    tr.appendChild(tdDesc);

                    // Celda Descuento
                    const tdPorcentaje = document.createElement('td');
                    tdPorcentaje.textContent = `${promo.porcentaje}%`;
                    tr.appendChild(tdPorcentaje);

                    // Celda Vigencia
                    const tdVigencia = document.createElement('td');
                    /* NOTA: Tus fechas vienen mal desde el backend (muestran "%d/%m/%Y").
                       El JS las mostrará, pero idealmente deberías arreglar 
                       el formato de fecha en tu código de Python/Flask antes de enviarlo.
                    */
                    tdVigencia.textContent = `${promo.fecha_inicio} al ${promo.fecha_fin}`;
                    tr.appendChild(tdVigencia);

                    // Celda Estado
                    const tdEstado = document.createElement('td');
                    const estadoClass = promo.estado == 1 ? 'estado-Activa' : 'estado-Inactiva';
                    // Usamos innerHTML aquí solo para el <span>, lo cual es seguro.
                    tdEstado.innerHTML = `<span class="${estadoClass}">${promo.nombre_estado}</span>`; 
                    tr.appendChild(tdEstado);

                    // Celda Acción (esta sí puede usar innerHTML por la complejidad del form)
                    const tdAccion = document.createElement('td');
                    tdAccion.innerHTML = `
                        <form id="form-estado-promo-${promo.id_promocion}" onsubmit="event.preventDefault(); cambiarEstadoPromocion(${promo.id_promocion});" style="display:inline-block;">
                            <input type="hidden" name="estado" value="${promo.estado == 1 ? '0' : '1'}">
                            <button type="submit" class="btn-modal ${promo.estado == 1 ? 'btn-modal-secondary' : 'btn-modal-primary'}" style="padding: 5px 10px; font-size: 12px;">
                                ${promo.estado == 1 ? 'Desactivar' : 'Activar'}
                            </button>
                        </form>
                    `;
                    tr.appendChild(tdAccion);

                    // --- Fin del método seguro ---

                    tbody.appendChild(tr); // 2. Añadir la fila completada a la tabla
                });

            } else if (data.success) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No hay promociones creadas.</td></tr>';
            } else {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px; color: red;">${data.message}</td></tr>`;
            }
        } catch (e) {
            console.error("Error cargando promociones:", e);
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: red;">Error de red al cargar promociones.</td></tr>';
        }
    }

     // Guardar (crear) una nueva promoción
     async function guardarPromocion(event) {
         event.preventDefault(); // Evita que la página se recargue
         const form = document.getElementById('form-promocion');
         const btn = document.getElementById('btn-guardar-promo');
         const formData = new FormData(form);

         btn.disabled = true;
         btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

         try {
            const response = await fetch('/promociones/crear', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                mostrarAlertaPromo(data.message, 'success');
                form.reset();
                cargarPromociones(); // Recargar la lista de promociones
            } else {
                mostrarAlertaPromo(data.message, 'error');
            }
        } catch (e) {
             console.error("Error al crear promoción:", e);
            mostrarAlertaPromo('Error de red al crear la promoción.', 'error');
        } finally {
            btn.disabled = false;
             btn.innerHTML = '<i class="fas fa-save"></i> Guardar Promoción';
         }
     }
     // Cambiar el estado de una promoción (activar/desactivar)
    async function cambiarEstadoPromocion(promocionId) {
        const form = document.getElementById(`form-estado-promo-${promocionId}`);
        const formData = new FormData(form);
        
        try {
            const response = await fetch(`/promociones/${promocionId}/cambiar_estado`, {
                // ¡AQUÍ YA NO ESTÁ EL ERROR!
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                mostrarAlertaPromo(data.message, 'success');
                cargarPromociones(); // Recargar la tabla
            } else {
                mostrarAlertaPromo(data.message, 'error');
            }
        } catch (e) {
            console.error("Error al cambiar estado:", e);
            mostrarAlertaPromo('Error de red al cambiar estado.', 'error');
        }
    }

    // Mostrar alertas de promociones
     function mostrarAlertaPromo(mensaje, tipo) {
         const alertSuccess = document.getElementById('alert-promo-success');
        const alertError = document.getElementById('alert-promo-error');
       
        alertSuccess.style.display = 'none';
        alertError.style.display = 'none';

         if (tipo === 'success') {
            alertSuccess.textContent = mensaje;
             alertSuccess.style.display = 'block';
         } else {
            alertError.textContent = mensaje;
            alertError.style.display = 'block';
         }
     }

    // Inicializar cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
        // Asignar el evento de submit al formulario de promociones
        const formPromocion = document.getElementById('form-promocion');
        if (formPromocion) {
            formPromocion.addEventListener('submit', guardarPromocion);
        }
        
        // Cargar tipos de promoción y promociones al cargar la página
        cargarTiposPromocion();
        cargarPromociones();
    });
</script>

{% endblock %}
