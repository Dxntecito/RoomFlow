{% extends "/MODULO_INCIDENCIA/Crud_Incidencia.html" %}

{% block incidences_content %}
<!-- Secci√≥n: Gestionar Incidencias -->
            <div class="section-content" id="incidencias">
                <!-- Alertas de incidencias -->
                <div class="alert alert-success" id="alert-incidencia-success" style="display: none;">
                    <i class="fas fa-check-circle"></i> <span id="incidencia-success-message"></span>
                </div>

                <div class="alert alert-error" id="alert-incidencia-error" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i> <span id="incidencia-error-message"></span>
                </div>

                <!-- Panel principal de incidencias -->
                <div id="panel-incidencias">
                    <!-- Encabezado con t√≠tulo y b√∫squeda -->
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <h2 style="margin: 0; color: #328336;">
                            <i class="fas fa-exclamation-triangle"></i> Incidencias Pendientes
                        </h2>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="buscar-incidencias" placeholder="Buscar incidencias..."
                                style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; width: 250px;">
                            <button class="btn btn-primary" onclick="buscarIncidencias()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Tabla de incidencias -->
                    <div
                        style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #328336; color: white;">
                                <tr>
                                    <th style="padding: 15px; text-align: left; font-weight: 600;">Fecha de Env√≠o</th>
                                    <th style="padding: 15px; text-align: left; font-weight: 600;">Fecha de Resoluci√≥n
                                    </th>
                                    <th style="padding: 15px; text-align: left; font-weight: 600;">T√≠tulo</th>
                                    <th style="padding: 15px; text-align: left; font-weight: 600;">Estado</th>
                                    <th style="padding: 15px; text-align: center; font-weight: 600;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-incidencias">
                                <tr>
                                    <td colspan="5" style="padding: 40px; text-align: center; color: #999;">
                                        <i class="fas fa-spinner fa-spin"
                                            style="font-size: 24px; margin-bottom: 10px;"></i>
                                        <p>Cargando incidencias...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Nota: Las incidencias se crean desde el perfil del cliente -->
                    <div style="text-align: center; margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; color: #1976d2;">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Nota:</strong> Las incidencias son creadas por los clientes. Aqu√≠ puedes responder y resolver las incidencias pendientes.
                    </div>
                </div>

                <!-- Formulario de nueva/editar incidencia -->
                <div id="formulario-incidencia"
                    style="display: none; margin-bottom: 30px; padding: 30px; background: #f8f9fa; border-radius: 10px; position: relative; z-index: 1000; border: 2px solid #328336;">
                    <h3 style="margin-bottom: 25px; color: #328336;">
                        <i class="fas fa-reply"></i>
                        <span id="form-titulo">Responder Incidencia</span>
                    </h3>

                    <form id="form-nueva-incidencia" enctype="multipart/form-data">
                        <input type="hidden" id="incidencia_id_edit" name="incidencia_id" value="">

                        <!-- Datos de Incidencia (Solo lectura) -->
                        <h4
                            style="color: #328336; margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid #328336; padding-bottom: 10px;">
                            Informaci√≥n de la Incidencia
                        </h4>

                        <div class="form-group" style="margin-bottom: 20px;">
                            <label for="incidencia-titulo">T√≠tulo</label>
                            <input type="text" id="incidencia-titulo" name="titulo" class="form-control" readonly
                                maxlength="255"
                                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; background: #f5f5f5;">
                        </div>

                        <div class="form-group" style="margin-bottom: 20px;">
                            <label for="incidencia-descripcion">Descripci√≥n</label>
                            <textarea id="incidencia-descripcion" name="descripcion" class="form-control" readonly
                                rows="4"
                                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical; background: #f5f5f5;"></textarea>
                        </div>

                        <div class="form-grid"
                            style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="incidencia-tipo">Tipo de Incidencia</label>
                                <select id="incidencia-tipo" name="tipo_incidencia_id" class="form-control" disabled
                            ¬† ¬† ¬†       style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; background: #f5f5f5;">
                            ¬† ¬† ¬† ¬†     <option value="">Cargando tipos...</option>
                            ¬† ¬† ¬† ¬†     </select>
                            </div>

                            <div class="form-group">
                                <label for="incidencia-cliente">Cliente</label>
                                <input type="text" id="incidencia-cliente" name="cliente_nombre" class="form-control" readonly
                                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; background: #f5f5f5;">
                            </div>
                        </div>

                        <!-- Imagen de evidencia si existe -->
                        <div class="form-group" id="evidencia-container" style="margin-bottom: 20px; display: none;">
                            <label>Evidencia (Imagen)</label>
                            <div style="margin-top: 10px; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center;">
                                <img id="incidencia-imagen" src="" alt="Evidencia" 
                                    style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            </div>
                        </div>

                        <!-- Respuesta y Resoluci√≥n (Siempre visible para empleados/admin) -->
                        <div id="seccion-evaluacion" style="margin-top: 30px; display: block;">
                            <h4
                                style="color: #328336; margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid #328336; padding-bottom: 10px;">
                                <i class="fas fa-reply"></i> Responder y Resolver Incidencia
                            </h4>

                            <!-- Estado de la incidencia -->
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #328336;">
                                    Estado de la Incidencia
                                </label>
                                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                        <input type="radio" name="estado_incidencia" value="3" id="estado-proceso"
                                            style="margin: 0;">
                                        <span style="color: #ffc107; font-weight: 600;">
                                            <i class="fas fa-clock"></i> En Proceso
                                        </span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                        <input type="radio" name="estado_incidencia" value="1" id="estado-aprobado"
                                            style="margin: 0;">
                                        <span style="color: #28a745; font-weight: 600;">
                                            <i class="fas fa-check-circle"></i> Aprobado
                                        </span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                        <input type="radio" name="estado_incidencia" value="2" id="estado-rechazado"
                                            style="margin: 0;">
                                        <span style="color: #dc3545; font-weight: 600;">
                                            <i class="fas fa-times-circle"></i> Rechazado
                                        </span>
                                    </label>
                                </div>
                            </div>

                            <!-- Respuesta del hotel -->
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label for="incidencia-respuesta"
                                    style="display: block; margin-bottom: 10px; font-weight: 600; color: #328336;">
                                    <i class="fas fa-reply"></i> Respuesta del Hotel *
                                </label>
                                <textarea id="incidencia-respuesta" name="respuesta" class="form-control" rows="4" required
                                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical;"
                                    placeholder="Escriba la respuesta del hotel..."></textarea>
                                <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                    <i class="fas fa-info-circle"></i> Esta respuesta ser√° visible para el cliente
                                </small>
                            </div>
                        </div>

                        <div class="form-actions"
                            style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px; padding-top: 25px; border-top: 2px solid #e0e0e0;">
                            <button type="button" class="btn btn-secondary" onclick="volverALista()">
                                <i class="fas fa-arrow-left"></i> Volver
                            </button>
                            <button type="submit" class="btn btn-primary" id="btn-guardar-incidencia">
                                <i class="fas fa-check"></i> Responder y Resolver
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <script>
                 // ============================================
    // FUNCIONES PARA GESTIONAR INCIDENCIAS
    // ============================================

    let tiposIncidencia = [];
    let incidenciaActual = null;
    let todasLasIncidencias = [];
    let esAdministrador = false; // Variable para detectar si es administrador

    // Cargar tipos de incidencia al inicio
    async function cargarTiposIncidencia() {
        try {
            const response = await fetch('/incidentes/tipos');
            const data = await response.json();

            if (data.success) {
                tiposIncidencia = data.tipos;
                const select = document.getElementById('incidencia-tipo');
                select.innerHTML = '<option value="">Seleccione...</option>';

                tiposIncidencia.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.id_tipo;
                    option.textContent = tipo.nombre;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error al cargar tipos de incidencia:', error);
        }
    }

    // Cargar incidencias pendientes para empleados/administradores
    async function cargarIncidencias() {
        try {
            // Detectar si es administrador o empleado (rol_id = 1 o 2)
            const rolId = parseInt('{{ session.get("rol_id", 0) }}');
            esAdministrador = (rolId === 1 || rolId === 2);

            console.log('üîç Debug cargarIncidencias:');
            console.log('- rolId:', rolId);
            console.log('- esAdministrador:', esAdministrador);

            // En el m√≥dulo de incidencias, solo cargar pendientes
            const url = '/incidentes/pendientes';
            console.log('- URL a consultar:', url);

            const response = await fetch(url);
            const data = await response.json();

            console.log('- Respuesta del servidor:', data);

            if (data.success) {
                todasLasIncidencias = data.incidencias;
                mostrarTablaIncidencias(data.incidencias);
            } else {
                mostrarErrorTabla(data.message || 'Error al cargar incidencias');
            }
        } catch (error) {
            console.error('Error al cargar incidencias:', error);
            mostrarErrorTabla('Error al cargar las incidencias');
        }
    }

    // Mostrar tabla de incidencias
    function mostrarTablaIncidencias(incidencias) {
        const tbody = document.getElementById('tabla-incidencias');

        if (incidencias.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="padding: 40px; text-align: center; color: #999; ">
                        <div class="no-incidencias">
                        <i class="fas fa-inbox" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
                        <h4 style="color: #666; margin-bottom: 10px;">No hay incidencias pendientes</h4>
                        <p>Todas las incidencias han sido resueltas</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        let html = '';
        incidencias.forEach(inc => {
            // Determinar color del estado
            let estadoColor = '#ffc107';
            let estadoIcon = 'fa-clock';
            let estadoTexto = 'En proceso';

            if (inc.estado === 1) {
                estadoColor = '#28a745';
                estadoIcon = 'fa-check-circle';
                estadoTexto = 'Aprobado';
            } else if (inc.estado === 2) {
                estadoColor = '#dc3545';
                estadoIcon = 'fa-times-circle';
                estadoTexto = 'Rechazado';
            }

            html += `
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 15px;">${inc.fecha_envio || '-'}</td>
                    <td style="padding: 15px;">${inc.fecha_resolucion || '-'}</td>
                    <td style="padding: 15px; font-weight: 600;">${inc.titulo || inc.nombre_incidencia || '-'}</td>
                    <td style="padding: 15px;">
                        <span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${estadoColor}20; color: ${estadoColor};">
                            <i class="fas ${estadoIcon}"></i> ${estadoTexto}
                        </span>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <button onclick="responderIncidencia(${inc.incidencia_id})" style="background: #28a745; color: white; border: none; border-radius: 8px; padding: 8px 16px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 5px; font-weight: 600;" title="Responder incidencia">
                            <i class="fas fa-reply"></i> Responder
                        </button>
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    }

    // Mostrar error en tabla
    function mostrarErrorTabla(mensaje) {
        const tbody = document.getElementById('tabla-incidencias');
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="padding: 40px; text-align: center; color: #dc3545;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 32px;"></i>
                    <p style="margin-top: 15px;">${mensaje}</p>
                </td>
            </tr>
        `;
    }

    // Buscar incidencias
    function buscarIncidencias() {
        const termino = document.getElementById('buscar-incidencias').value.toLowerCase();
        const incidenciasFiltradas = todasLasIncidencias.filter(inc =>
            inc.titulo.toLowerCase().includes(termino) ||
            inc.descripcion.toLowerCase().includes(termino) ||
            inc.tipo_incidencia.toLowerCase().includes(termino)
        );
        mostrarTablaIncidencias(incidenciasFiltradas);
    }

    // Mostrar lista de incidencias
    function mostrarListaIncidencias(incidencias) {
        const contenedor = document.getElementById('contenedor-incidencias');

        let html = '<div style="display: grid; gap: 20px;">';

        incidencias.forEach(inc => {
            // Determinar color seg√∫n estado
            let estadoColor = '#ffc107'; // En proceso (amarillo)
            let estadoIcon = 'fa-clock';

            if (inc.estado === 1) {
                estadoColor = '#28a745'; // Aprobado (verde)
                estadoIcon = 'fa-check-circle';
            } else if (inc.estado === 2) {
                estadoColor = '#dc3545'; // Rechazado (rojo)
                estadoIcon = 'fa-times-circle';
            }

            html += `
                <div style="background: white; border: 2px solid #e0e0e0; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s; cursor: pointer;" onclick="verDetalleIncidencia(${inc.incidencia_id})">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 10px 0; color: #333; font-size: 18px;">
                                <i class="fas fa-file-alt" style="color: #328336;"></i> 
                                ${inc.titulo}
                            </h4>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 13px; color: #666;">
                                <span><i class="fas fa-tag"></i> ${inc.tipo_incidencia}</span>
                                <span><i class="fas fa-calendar"></i> ${inc.fecha_envio}</span>
                                ${inc.numero_comprobante ? `<span><i class="fas fa-receipt"></i> ${inc.numero_comprobante}</span>` : ''}
                            </div>
                        </div>
                        <div style="padding: 8px 16px; background: ${estadoColor}; color: white; border-radius: 20px; font-weight: 600; font-size: 13px; white-space: nowrap;">
                            <i class="fas ${estadoIcon}"></i> ${inc.estado_texto}
                        </div>
                    </div>
                    
                    <p style="margin: 0; color: #666; line-height: 1.6;">${inc.descripcion.substring(0, 150)}${inc.descripcion.length > 150 ? '...' : ''}</p>
                    
                    ${inc.respuesta ? `
                        <div style="margin-top: 15px; padding: 15px; background: #e8f5e9; border-left: 4px solid #28a745; border-radius: 5px;">
                            <strong style="color: #155724; display: block; margin-bottom: 5px;">
                                <i class="fas fa-reply"></i> Respuesta del hotel:
                            </strong>
                            <p style="margin: 0; color: #155724;">${inc.respuesta}</p>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="event.stopPropagation(); editarIncidencia(${inc.incidencia_id})" class="btn-secondary" style="padding: 8px 16px; background: #ffc107; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 13px;">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button onclick="event.stopPropagation(); eliminarIncidenciaConfirm(${inc.incidencia_id})" class="btn-secondary" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 13px;">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        contenedor.innerHTML = html;
    }

    // Funci√≥n para responder a una incidencia (reemplaza mostrarFormularioIncidencia)
    async function responderIncidencia(incidenciaId) {
        await editarIncidencia(incidenciaId);
    }

    // Ver incidencia (solo lectura)
    async function verIncidencia(incidenciaId) {
        try {
            const response = await fetch(`/incidentes/${incidenciaId}`);
            const data = await response.json();

            if (data.success) {
                const inc = data.incidencia;

                // Ocultar panel principal
                document.getElementById('panel-incidencias').style.display = 'none';

                // Mostrar formulario
                document.getElementById('formulario-incidencia').style.display = 'block';

                // Configurar para ver
                incidenciaActual = inc;
                document.getElementById('form-titulo').textContent = 'Ver Incidencia';

                // Llenar campos (solo lectura)
                document.getElementById('incidencia-titulo').value = inc.titulo;
                document.getElementById('incidencia-descripcion').value = inc.descripcion;
                document.getElementById('incidencia-tipo').value = inc.tipo_incidencia_id;
                document.getElementById('incidencia-comprobante').value = inc.numero_comprobante || '';
                document.getElementById('incidencia-respuesta').value = inc.respuesta || '';

                // Hacer campos de solo lectura
                document.getElementById('incidencia-titulo').readOnly = true;
                document.getElementById('incidencia-descripcion').readOnly = true;
                document.getElementById('incidencia-tipo').disabled = true;
                document.getElementById('incidencia-comprobante').readOnly = true;
                document.getElementById('incidencia-evidencia').disabled = true;

                // Mostrar estado actual
                actualizarEstadoVisual(inc.estado);

                // Ocultar bot√≥n guardar
                document.getElementById('btn-guardar-incidencia').style.display = 'none';

            } else {
                mostrarAlertaIncidencia('Error al cargar la incidencia', 'error');
            }
        } catch (error) {
            console.error('Error al cargar incidencia:', error);
            mostrarAlertaIncidencia('Error al cargar la incidencia', 'error');
        }
    }

    // Responder/Editar incidencia (solo para empleados/admin en el m√≥dulo)
    async function editarIncidencia(incidenciaId) {
        console.log('üöÄ Iniciando respuesta a incidencia ID:', incidenciaId);

        try {
            // Obtener datos de la incidencia
            const response = await fetch(`/incidentes/${incidenciaId}`);
            const data = await response.json();

            if (!data.success) {
                mostrarAlertaIncidencia('Error al cargar la incidencia', 'error');
                return;
            }

            const inc = data.incidencia;
            console.log('‚úÖ Incidencia cargada:', inc);

            // Ocultar panel de lista y mostrar formulario
            document.getElementById('panel-incidencias').style.display = 'none';
            document.getElementById('formulario-incidencia').style.display = 'block';

            // Configurar t√≠tulo y ID
            document.getElementById('form-titulo').textContent = 'Responder Incidencia';
            document.getElementById('incidencia_id_edit').value = inc.incidencia_id;
            incidenciaActual = inc;

            // Llenar campos b√°sicos (solo lectura)
            document.getElementById('incidencia-titulo').value = inc.titulo || '';
            document.getElementById('incidencia-descripcion').value = inc.descripcion || '';
            document.getElementById('incidencia-cliente').value = inc.cliente_nombre || '';

            // Cargar tipos de incidencia primero
            await cargarTiposIncidencia();
            
            // Despu√©s de cargar los tipos, establecer el valor seleccionado
            const tipoSelect = document.getElementById('incidencia-tipo');
            if (tipoSelect && inc.tipo_incidencia_id) {
                tipoSelect.value = inc.tipo_incidencia_id;
                // Si el tipo_incidencia viene del servidor, tambi√©n mostrarlo
                if (inc.tipo_incidencia) {
                    // Asegurarse de que la opci√≥n existe, si no, agregarla
                    const optionExists = Array.from(tipoSelect.options).some(opt => opt.value == inc.tipo_incidencia_id);
                    if (!optionExists && inc.tipo_incidencia_id) {
                        const option = document.createElement('option');
                        option.value = inc.tipo_incidencia_id;
                        option.textContent = inc.tipo_incidencia;
                        tipoSelect.appendChild(option);
                    }
                    tipoSelect.value = inc.tipo_incidencia_id;
                }
            }

            // Mostrar imagen si existe
            const evidenciaContainer = document.getElementById('evidencia-container');
            const imagenElement = document.getElementById('incidencia-imagen');
            if (inc.imagen) {
                imagenElement.src = `data:image/jpeg;base64,${inc.imagen}`;
                evidenciaContainer.style.display = 'block';
            } else {
                evidenciaContainer.style.display = 'none';
            }

            // Mostrar secci√≥n de evaluaci√≥n (siempre visible para responder)
            const seccionEvaluacion = document.getElementById('seccion-evaluacion');
            if (seccionEvaluacion) {
                seccionEvaluacion.style.display = 'block';
            }

            // Configurar estado actual (por defecto en proceso si no est√° resuelta)
            const estadoActual = inc.estado || 3;
            const radioEstado = document.querySelector(`input[name="estado_incidencia"][value="${estadoActual}"]`);
            if (radioEstado) {
                radioEstado.checked = true;
            } else {
                // Si no hay estado, marcar "En proceso" por defecto
                const radioProceso = document.querySelector('input[name="estado_incidencia"][value="3"]');
                if (radioProceso) radioProceso.checked = true;
            }

            // Llenar respuesta del hotel (editable)
            const campoRespuesta = document.getElementById('incidencia-respuesta');
            if (campoRespuesta) {
                campoRespuesta.value = inc.respuesta || '';
                campoRespuesta.readOnly = false;
                campoRespuesta.required = true;
            }

            // Mostrar bot√≥n guardar
            document.getElementById('btn-guardar-incidencia').style.display = 'inline-block';

            console.log('‚úÖ Formulario de respuesta configurado correctamente');

        } catch (error) {
            console.error('‚ùå Error al cargar incidencia:', error);
            mostrarAlertaIncidencia('Error al cargar la incidencia: ' + error.message, 'error');
        }
    }

    // Volver a la lista
    function volverALista() {
        document.getElementById('formulario-incidencia').style.display = 'none';
        document.getElementById('panel-incidencias').style.display = 'block';

        // Limpiar formulario
        document.getElementById('form-nueva-incidencia').reset();
        incidenciaActual = null;
    }

    // Cancelar formulario
    function cancelarFormularioIncidencia() {
        document.getElementById('formulario-incidencia').style.display = 'none';
        document.getElementById('form-nueva-incidencia').reset();
        incidenciaActual = null;
    }

    // Funci√≥n de debug
    function debugFormulario() {
        console.log('üîç === DEBUG FORMULARIO ===');

        const formulario = document.getElementById('formulario-incidencia');
        console.log('Formulario:', formulario);
        console.log('Display actual:', formulario ? formulario.style.display : 'NO ENCONTRADO');

        if (formulario) {
            formulario.style.setProperty('display', 'block', 'important');
            formulario.style.border = '3px solid red';
            console.log('‚úÖ Formulario forzado a mostrar con borde rojo');
        } else {
            console.error('‚ùå Formulario no encontrado');
        }

        // Verificar otros elementos
        console.log('T√≠tulo:', document.getElementById('form-titulo'));
        console.log('Form:', document.getElementById('form-nueva-incidencia'));
        console.log('ID Edit:', document.getElementById('incidencia_id_edit'));
    }

    // Funci√≥n para mostrar controles de estado para administradores
    function mostrarControlesEstadoAdmin(estadoActual, respuestaActual = '') {
        console.log('üîß mostrarControlesEstadoAdmin llamada:');
        console.log('- estadoActual:', estadoActual);
        console.log('- respuestaActual:', respuestaActual);

        const seccionEvaluacion = document.getElementById('seccion-evaluacion');
        console.log('- seccionEvaluacion encontrada:', !!seccionEvaluacion);
        console.log('- seccionEvaluacion elemento:', seccionEvaluacion);

        if (seccionEvaluacion) {
            // Mostrar la secci√≥n de evaluaci√≥n
            seccionEvaluacion.style.display = 'block';

            // Crear controles de estado para administrador
            const controlesHTML = `
                <h4 style="color: #328336; margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid #328336; padding-bottom: 10px;">
                    <i class="fas fa-cogs"></i> Evaluaci√≥n (Administrador)
                </h4>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #328336;">
                        <i class="fas fa-cogs"></i> Estado de la Incidencia
                    </label>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.3s;">
                            <input type="radio" name="estado_incidencia" value="3" ${estadoActual == 3 ? 'checked' : ''} style="margin: 0;">
                            <span style="color: #ffc107; font-weight: 600;">
                                <i class="fas fa-clock"></i> En Proceso
                            </span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.3s;">
                            <input type="radio" name="estado_incidencia" value="1" ${estadoActual == 1 ? 'checked' : ''} style="margin: 0;">
                            <span style="color: #28a745; font-weight: 600;">
                                <i class="fas fa-check-circle"></i> Aprobado
                            </span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.3s;">
                            <input type="radio" name="estado_incidencia" value="2" ${estadoActual == 2 ? 'checked' : ''} style="margin: 0;">
                            <span style="color: #dc3545; font-weight: 600;">
                                <i class="fas fa-times-circle"></i> Rechazado
                            </span>
                        </label>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label for="incidencia-respuesta-admin" style="display: block; margin-bottom: 10px; font-weight: 600; color: #328336;">
                        <i class="fas fa-reply"></i> Respuesta del Hotel
                    </label>
                    <textarea id="incidencia-respuesta-admin" name="respuesta" class="form-control" rows="4" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical;" placeholder="Escriba la respuesta del hotel...">${respuestaActual || ''}</textarea>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        <i class="fas fa-info-circle"></i> Esta respuesta ser√° visible para el cliente
                    </small>
                </div>
            `;

            // Reemplazar el contenido de la secci√≥n de evaluaci√≥n
            seccionEvaluacion.innerHTML = controlesHTML;
            console.log('‚úÖ Controles de estado creados y mostrados');
            console.log('üîç HTML aplicado:', seccionEvaluacion.innerHTML.substring(0, 200) + '...');

            // Agregar estilos din√°micos a los radio buttons
            const radioButtons = seccionEvaluacion.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function () {
                    // Actualizar estilos visuales
                    radioButtons.forEach(rb => {
                        const label = rb.closest('label');
                        if (rb.checked) {
                            if (rb.value == '1') {
                                label.style.borderColor = '#28a745';
                                label.style.backgroundColor = '#d4edda';
                            } else if (rb.value == '2') {
                                label.style.borderColor = '#dc3545';
                                label.style.backgroundColor = '#f8d7da';
                            } else {
                                label.style.borderColor = '#ffc107';
                                label.style.backgroundColor = '#fff3cd';
                            }
                        } else {
                            label.style.borderColor = '#e0e0e0';
                            label.style.backgroundColor = 'transparent';
                        }
                    });
                });

                // Aplicar estilos iniciales
                if (radio.checked) {
                    const label = radio.closest('label');
                    if (radio.value == '1') {
                        label.style.borderColor = '#28a745';
                        label.style.backgroundColor = '#d4edda';
                    } else if (radio.value == '2') {
                        label.style.borderColor = '#dc3545';
                        label.style.backgroundColor = '#f8d7da';
                    } else {
                        label.style.borderColor = '#ffc107';
                        label.style.backgroundColor = '#fff3cd';
                    }
                }
            });
        }
    }

    // Funci√≥n para actualizar el estado visual (solo lectura)
    function actualizarEstadoVisual(estado) {
        const seccionEvaluacion = document.getElementById('seccion-evaluacion');
        if (seccionEvaluacion) {
            // Mostrar la secci√≥n de evaluaci√≥n
            seccionEvaluacion.style.display = 'block';

            // Crear contenido de solo lectura
            const contenidoHTML = `
                <h4 style="color: #328336; margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid #328336; padding-bottom: 10px;">
                    <i class="fas fa-info-circle"></i> Evaluaci√≥n
                </h4>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>Estado Actual</label>
                    <div id="estado-actual" style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e0e0e0; text-align: center; font-weight: 600; font-size: 16px;">
                        ${estado === 1 ? '<i class="fas fa-check-circle"></i> Aprobado' :
                    estado === 2 ? '<i class="fas fa-times-circle"></i> Rechazado' :
                        '<i class="fas fa-clock"></i> En proceso'}
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="incidencia-respuesta">Respuesta del Hotel</label>
                    <textarea id="incidencia-respuesta" name="respuesta" class="form-control" rows="4" readonly style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical; background: #f8f9fa;" placeholder="A√∫n no hay respuesta del hotel..."></textarea>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        <i class="fas fa-info-circle"></i> Esta respuesta ser√° proporcionada por el personal del hotel
                    </small>
                </div>
            `;

            seccionEvaluacion.innerHTML = contenidoHTML;

            // Aplicar estilos al estado
            const estadoActual = document.getElementById('estado-actual');
            if (estadoActual) {
                let estadoColor = '';
                let backgroundColor = '';

                if (estado === 1) {
                    estadoColor = '#28a745';
                    backgroundColor = '#d4edda';
                } else if (estado === 2) {
                    estadoColor = '#dc3545';
                    backgroundColor = '#f8d7da';
                } else {
                    estadoColor = '#ffc107';
                    backgroundColor = '#fff3cd';
                }

                estadoActual.style.color = estadoColor;
                estadoActual.style.borderColor = estadoColor;
                estadoActual.style.backgroundColor = backgroundColor;
            }
        }
    }

    // Ver detalle de incidencia
    async function verDetalleIncidencia(incidenciaId) {
        try {
            const response = await fetch(`/incidentes/${incidenciaId}`);
            const data = await response.json();

            if (data.success) {
                const inc = data.incidencia;

                // Mostrar modal o expandir detalle
                let detalleHTML = `
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 800px; margin: 20px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
                            <h3 style="margin: 0; color: #328336;">
                                <i class="fas fa-file-alt"></i> Detalle de Incidencia
                            </h3>
                            <button onclick="cerrarDetalleIncidencia()" style="background: none; border: none; font-size: 24px; color: #999; cursor: pointer;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div style="display: grid; gap: 20px;">
                            <div>
                                <strong style="color: #328336; display: block; margin-bottom: 5px;">T√≠tulo:</strong>
                                <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">${inc.titulo}</p>
                            </div>
                            
                            <div>
                                <strong style="color: #328336; display: block; margin-bottom: 5px;">Descripci√≥n:</strong>
                                <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 5px; line-height: 1.6;">${inc.descripcion}</p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                <div>
                                    <strong style="color: #328336; display: block; margin-bottom: 5px;">Tipo:</strong>
                                    <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">${inc.tipo_incidencia}</p>
                                </div>
                                <div>
                                    <strong style="color: #328336; display: block; margin-bottom: 5px;">Estado:</strong>
                                    <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">${inc.estado_texto}</p>
                                </div>
                            </div>
                            
                            ${inc.numero_comprobante ? `
                                <div>
                                    <strong style="color: #328336; display: block; margin-bottom: 5px;">Comprobante:</strong>
                                    <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">${inc.numero_comprobante}</p>
                                </div>
                            ` : ''}
                            
                            ${inc.imagen ? `
                                <div>
                                    <strong style="color: #328336; display: block; margin-bottom: 5px;">Evidencia:</strong>
                                    <img src="data:image/jpeg;base64,${inc.imagen}" style="max-width: 100%; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                </div>
                            ` : ''}
                            
                            ${inc.respuesta ? `
                                <div style="padding: 20px; background: #e8f5e9; border-left: 4px solid #28a745; border-radius: 10px;">
                                    <strong style="color: #155724; display: block; margin-bottom: 10px; font-size: 16px;">
                                        <i class="fas fa-reply"></i> Respuesta del hotel:
                                    </strong>
                                    <p style="margin: 0; color: #155724; line-height: 1.6;">${inc.respuesta}</p>
                                </div>
                            ` : ''}
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                                <button onclick="cerrarDetalleIncidencia()" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // Crear overlay y mostrar detalle
                const overlay = document.createElement('div');
                overlay.id = 'detalle-overlay';
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; padding: 20px;';
                overlay.innerHTML = detalleHTML;
                overlay.onclick = function (e) {
                    if (e.target === overlay) {
                        cerrarDetalleIncidencia();
                    }
                };
                document.body.appendChild(overlay);
            }
        } catch (error) {
            console.error('Error al cargar detalle:', error);
            mostrarAlertaIncidencia('Error al cargar el detalle de la incidencia', 'error');
        }
    }

    function cerrarDetalleIncidencia() {
        const overlay = document.getElementById('detalle-overlay');
        if (overlay) {
            overlay.remove();
        }
    }

    // Funci√≥n editarIncidencia duplicada eliminada - usar la versi√≥n principal

    // Eliminar incidencia con confirmaci√≥n
    function eliminarIncidenciaConfirm(incidenciaId) {
        if (confirm('¬øEst√° seguro de eliminar esta incidencia? Esta acci√≥n no se puede deshacer.')) {
            eliminarIncidencia(incidenciaId);
        }
    }

    // Eliminar incidencia
    async function eliminarIncidencia(incidenciaId) {
        try {
            const response = await fetch(`/incidentes/eliminar/${incidenciaId}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                mostrarAlertaIncidencia('Incidencia eliminada exitosamente', 'success');
                cargarIncidencias();
            } else {
                mostrarAlertaIncidencia(data.message || 'Error al eliminar incidencia', 'error');
            }
        } catch (error) {
            console.error('Error al eliminar incidencia:', error);
            mostrarAlertaIncidencia('Error al eliminar la incidencia', 'error');
        }
    }

    // Guardar incidencia (crear o actualizar)
    document.getElementById('form-nueva-incidencia').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const incidenciaId = document.getElementById('incidencia_id_edit').value;
        const btnGuardar = document.getElementById('btn-guardar-incidencia');

        console.log('üíæ Preparando guardado - ID incidencia:', incidenciaId);

        // Obtener el estado seleccionado (requerido)
        const estadoSeleccionado = document.querySelector('input[name="estado_incidencia"]:checked');
        if (!estadoSeleccionado) {
            mostrarAlertaIncidencia('Debe seleccionar un estado para la incidencia', 'error');
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = '<i class="fas fa-check"></i> Responder y Resolver';
            return;
        }
        formData.set('estado', estadoSeleccionado.value);
        console.log('üìä Estado a guardar:', estadoSeleccionado.value);

        // Obtener la respuesta del hotel (requerida)
        const campoRespuesta = document.getElementById('incidencia-respuesta');
        if (!campoRespuesta || !campoRespuesta.value.trim()) {
            mostrarAlertaIncidencia('Debe escribir una respuesta para la incidencia', 'error');
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = '<i class="fas fa-check"></i> Responder y Resolver';
            return;
        }
        formData.set('respuesta', campoRespuesta.value);
        console.log('üí¨ Respuesta a guardar:', campoRespuesta.value.substring(0, 50) + '...');

        btnGuardar.disabled = true;
        btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

        try {
            // En el m√≥dulo, siempre se responde a una incidencia existente
            if (!incidenciaId) {
                mostrarAlertaIncidencia('Debe seleccionar una incidencia para responder', 'error');
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = '<i class="fas fa-check"></i> Responder y Resolver';
                return;
            }

            // Usar la ruta de responder
            const url = `/incidentes/${incidenciaId}/responder`;
            const method = 'POST';

            const response = await fetch(url, {
                method: method,
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                mostrarAlertaIncidencia(data.message || 'Incidencia respondida y resuelta exitosamente', 'success');
                volverALista();
                cargarIncidencias();
            } else {
                mostrarAlertaIncidencia(data.message || 'Error al responder la incidencia', 'error');
            }
        } catch (error) {
            console.error('Error al guardar incidencia:', error);
            mostrarAlertaIncidencia('Error al guardar la incidencia', 'error');
        } finally {
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = '<i class="fas fa-save"></i> Guardar';
        }
    });

    // Mostrar alertas de incidencias
    function mostrarAlertaIncidencia(mensaje, tipo) {
        const alertSuccess = document.getElementById('alert-incidencia-success');
        const alertError = document.getElementById('alert-incidencia-error');
        const successMsg = document.getElementById('incidencia-success-message');
        const errorMsg = document.getElementById('incidencia-error-message');

        // Ocultar todas las alertas
        alertSuccess.style.display = 'none';
        alertError.style.display = 'none';

        if (tipo === 'success') {
            successMsg.textContent = mensaje;
            alertSuccess.style.display = 'block';
            setTimeout(() => {
                alertSuccess.style.display = 'none';
            }, 5000);
        } else {
            errorMsg.textContent = mensaje;
            alertError.style.display = 'block';
            setTimeout(() => {
                alertError.style.display = 'none';
            }, 5000);
        }

        // Scroll a la alerta
        document.getElementById('incidencias').scrollIntoView({ behavior: 'smooth' });
    }

    // Inicializar incidencias cuando se abre la secci√≥n
    const menuIncidencias = document.querySelector('[data-section="incidencias"]');
    if (menuIncidencias) {
        menuIncidencias.addEventListener('click', function () {
            setTimeout(() => {
                cargarIncidencias();
            }, 100);
        });
    }

    // Agregar b√∫squeda en tiempo real
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ Script de incidencias cargado correctamente');
        const buscarInput = document.getElementById('buscar-incidencias');
        if (buscarInput) {
            buscarInput.addEventListener('input', function () {
                buscarIncidencias();
            });
        }
    });

    // Agregar event listener alternativo para el bot√≥n de nueva incidencia
    document.addEventListener('DOMContentLoaded', function () {
        const btnNuevaIncidencia = document.querySelector('button[onclick="mostrarFormularioIncidencia()"]');
        if (btnNuevaIncidencia) {
            btnNuevaIncidencia.addEventListener('click', function (e) {
                e.preventDefault();
                console.log('Bot√≥n de nueva incidencia clickeado');
                mostrarFormularioIncidencia();
            });
        } else {
            console.error('No se encontr√≥ el bot√≥n de nueva incidencia');
        }
    });
    cargarIncidencias();
    </script>
{% endblock %}
