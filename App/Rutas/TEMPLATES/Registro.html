{% extends "Master.html" %}

{% block stiles %}
<style>
    /* Estilos para el formulario de registro */
    .registro-container {
        min-height: calc(100vh - 200px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 140px 20px 40px 20px;
        background: linear-gradient(135deg, #328336 0%, #64CC4F 100%);
    }

    .registro-box {
        background: white;
        border-radius: 20px;
        padding: 50px 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 600px;
        width: 100%;
        animation: fadeInUp 0.5s ease;
    }

    .registro-box select {
        width: 100%;
        padding: 14px 18px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 15px;
        transition: all 0.3s ease;
        box-sizing: border-box;
        background: white;
        cursor: pointer;
    }

    .registro-box select:focus {
        outline: none;
        border-color: #328336;
        box-shadow: 0 0 0 3px rgba(50, 131, 54, 0.1);
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .registro-header {
        text-align: center;
        margin-bottom: 35px;
    }

    .registro-header h2 {
        color: #333;
        font-size: 32px;
        margin-bottom: 10px;
        font-weight: 700;
    }

    .registro-header p {
        color: #666;
        font-size: 16px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        color: #333;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .form-group input {
        width: 100%;
        padding: 14px 18px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 15px;
        transition: all 0.3s ease;
        box-sizing: border-box;
    }

    .form-group input:focus {
        outline: none;
        border-color: #328336;
        box-shadow: 0 0 0 3px rgba(50, 131, 54, 0.1);
    }

    .form-group input::placeholder {
        color: #aaa;
    }

    .form-group input.input-error,
    .registro-box select.input-error {
        border-color: #c33;
        box-shadow: 0 0 0 3px rgba(204, 51, 51, 0.1);
    }

    .form-group .validation-message {
        font-size: 12px;
        margin-top: 5px;
        display: none;
    }

    .form-group .validation-message.error {
        color: #c33;
        display: block;
    }

    .form-group .validation-message.success {
        color: #3c3;
        display: block;
    }

    .password-requirements {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-top: 10px;
        font-size: 12px;
    }

    .password-requirements h4 {
        margin: 0 0 8px 0;
        color: #333;
        font-size: 13px;
    }

    .password-requirements ul {
        margin: 0;
        padding-left: 20px;
        color: #666;
    }

    .password-requirements li {
        margin: 3px 0;
    }

    .btn-registro {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #328336 0%, #64CC4F 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 25px;
    }

    .btn-registro:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(50, 131, 54, 0.4);
    }

    .btn-registro:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .registro-footer {
        text-align: center;
        margin-top: 25px;
        padding-top: 25px;
        border-top: 1px solid #e0e0e0;
    }

    .registro-footer p {
        color: #666;
        font-size: 14px;
    }

    .registro-footer a {
        color: #328336;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.3s ease;
    }

    .registro-footer a:hover {
        color: #64CC4F;
    }

    /* Mensajes flash */
    .alert {
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-size: 14px;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .alert-error {
        background-color: #fee;
        color: #c33;
        border-left: 4px solid #c33;
    }

    .alert-success {
        background-color: #efe;
        color: #3c3;
        border-left: 4px solid #3c3;
    }

    .password-toggle {
        position: relative;
    }

    .password-toggle input {
        padding-right: 45px;
    }

    .password-toggle .toggle-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #666;
        transition: color 0.3s ease;
    }

    .password-toggle .toggle-icon:hover {
        color: #328336;
    }

    /* Estilos para checkbox de términos */
    .form-group input[type="checkbox"] {
        width: auto;
        margin-right: 8px;
        cursor: pointer;
        accent-color: #328336;
    }

    .form-group input[type="checkbox"].input-error {
        outline: 2px solid #c33;
        outline-offset: 2px;
    }

    .form-group label a {
        color: #328336;
        text-decoration: underline;
        font-weight: 600;
    }

    .form-group label a:hover {
        color: #64CC4F;
    }

    /* Estilos específicos para el contenedor de términos */
    .terminos-container {
        transition: all 0.3s ease;
    }

    .terminos-container:hover {
        background: #f0f4f0 !important;
        border-color: #328336 !important;
    }

    .terminos-container label {
        padding: 0;
    }

    /* Asegurar que el checkbox esté bien alineado */
    .terminos-container input[type="checkbox"] {
        margin-top: 2px !important;
    }
</style>
{% endblock %}

{% set return_url = return_url or request.args.get('return_url') %}
{% block content %}
{% set form_data = form_data or {} %}
{% set errors = errors or {} %}
<div class="registro-container">
    <div class="registro-box">
        <div class="registro-header">
            <h2>Crear Cuenta</h2>
            <p>Únete a nosotros hoy</p>
        </div>

        <!-- Mensajes Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('usuarios.Registro') }}" id="registroForm">
            <input type="hidden" name="return_url" value="{{ return_url or '' }}">
            <!-- Datos de Cuenta -->
            <h3 style="color: #333; margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid #328336; padding-bottom: 10px;">
                <i class="fas fa-user-lock"></i> Datos de Cuenta
            </h3>

            <div class="form-group">
                <label for="usuario">Usuario *</label>
                <input 
                    type="text" 
                    id="usuario" 
                    name="usuario" 
                    placeholder="Elige un nombre de usuario" 
                    required
                    minlength="3"
                    maxlength="50"
                    autocomplete="username"
                    value="{{ form_data.get('usuario', '') }}"
                    class="{{ 'input-error' if errors.get('usuario') else '' }}"
                >
                <div class="validation-message {{ 'error' if errors.get('usuario') }}" id="usuario-message">{{ errors.get('usuario', '') }}</div>
            </div>

            <div class="form-group">
                <label for="email">Correo Electrónico *</label>
                <input 
                    type="email" 
                    id="email" 
                    name="email" 
                    placeholder="tu@email.com" 
                    required
                    autocomplete="email"
                    value="{{ form_data.get('email', '') }}"
                    class="{{ 'input-error' if errors.get('email') else '' }}"
                >
                <div class="validation-message {{ 'error' if errors.get('email') }}" id="email-message">{{ errors.get('email', '') }}</div>
            </div>

            <div class="form-group">
                <label for="contrasena">Contraseña *</label>
                <div class="password-toggle">
                    <input 
                        type="password" 
                        id="contrasena" 
                        name="contrasena" 
                        placeholder="Crea una contraseña segura" 
                        required
                        minlength="6"
                        autocomplete="new-password"
                        class="{{ 'input-error' if errors.get('contrasena') else '' }}"
                    >
                    <i class="fas fa-eye toggle-icon" id="togglePassword"></i>
                </div>
                <div class="validation-message {{ 'error' if errors.get('contrasena') }}" id="contrasena-message">{{ errors.get('contrasena', '') }}</div>
                <div class="password-requirements">
                    <h4>Requisitos de contraseña:</h4>
                    <ul>
                        <li>Mínimo 6 caracteres</li>
                        <li>Se recomienda usar mayúsculas, minúsculas y números</li>
                    </ul>
                </div>
            </div>

            <div class="form-group">
                <label for="confirmar_contrasena">Confirmar Contraseña *</label>
                <div class="password-toggle">
                    <input 
                        type="password" 
                        id="confirmar_contrasena" 
                        name="confirmar_contrasena" 
                        placeholder="Confirma tu contraseña" 
                        required
                        autocomplete="new-password"
                        class="{{ 'input-error' if errors.get('confirmar_contrasena') else '' }}"
                    >
                    <i class="fas fa-eye toggle-icon" id="toggleConfirmPassword"></i>
                </div>
                <div class="validation-message {{ 'error' if errors.get('confirmar_contrasena') }}" id="confirm-message">{{ errors.get('confirmar_contrasena', '') }}</div>
            </div>

            <!-- Datos Personales -->
            <h3 style="color: #333; margin: 30px 0 20px 0; font-size: 18px; border-bottom: 2px solid #328336; padding-bottom: 10px;">
                <i class="fas fa-id-card"></i> Datos Personales
            </h3>

            <div class="form-group">
                <label for="nombres">Nombres *</label>
                <input 
                    type="text" 
                    id="nombres" 
                    name="nombres" 
                    placeholder="Tus nombres" 
                    required
                    maxlength="50"
                    value="{{ form_data.get('nombres', '') }}"
                    class="{{ 'input-error' if errors.get('nombres') else '' }}"
                >
                <div class="validation-message {{ 'error' if errors.get('nombres') }}" id="nombres-message">{{ errors.get('nombres', '') }}</div>
            </div>

            <div class="form-group">
                <label for="apellido_paterno">Apellido Paterno *</label>
                <input 
                    type="text" 
                    id="apellido_paterno" 
                    name="apellido_paterno" 
                    placeholder="Tu apellido paterno" 
                    required
                    maxlength="50"
                    value="{{ form_data.get('apellido_paterno', '') }}"
                    class="{{ 'input-error' if errors.get('apellido_paterno') else '' }}"
                >
                <div class="validation-message {{ 'error' if errors.get('apellido_paterno') }}" id="apellido-paterno-message">{{ errors.get('apellido_paterno', '') }}</div>
            </div>

            <div class="form-group">
                <label for="apellido_materno">Apellido Materno *</label>
                <input 
                    type="text" 
                    id="apellido_materno" 
                    name="apellido_materno" 
                    placeholder="Tu apellido materno" 
                    required
                    maxlength="50"
                    value="{{ form_data.get('apellido_materno', '') }}"
                    class="{{ 'input-error' if errors.get('apellido_materno') else '' }}"
                >
                <div class="validation-message {{ 'error' if errors.get('apellido_materno') }}" id="apellido-materno-message">{{ errors.get('apellido_materno', '') }}</div>
            </div>

            <div class="form-group">
                <label for="tipo_documento_id">Tipo de Documento *</label>
                <select id="tipo_documento_id" name="tipo_documento_id" required class="{{ 'input-error' if errors.get('tipo_documento_id') else '' }}">
                    <option value="1" {{ 'selected' if form_data.get('tipo_documento_id', '1') == '1' else '' }}>DNI</option>
                    <option value="2" {{ 'selected' if form_data.get('tipo_documento_id', '1') == '2' else '' }}>Pasaporte</option>
                    <option value="3" {{ 'selected' if form_data.get('tipo_documento_id', '1') == '3' else '' }}>Carnet de Extranjería</option>
                    <option value="4" {{ 'selected' if form_data.get('tipo_documento_id', '1') == '4' else '' }}>RUC</option>
                </select>
            </div>

            <div class="form-group">
                <label for="num_documento">Número de Documento *</label>
                <input 
                    type="text" 
                    id="num_documento" 
                    name="num_documento" 
                    placeholder="Ingresa tu número de documento" 
                    required
                    maxlength="20"
                    value="{{ form_data.get('num_documento', '') }}"
                    class="{{ 'input-error' if errors.get('num_documento') else '' }}"
                >
                <div class="validation-message {{ 'error' if errors.get('num_documento') }}" id="num-documento-message">{{ errors.get('num_documento', '') }}</div>
            </div>

            <div class="form-group">
                <label for="sexo">Sexo *</label>
                <select id="sexo" name="sexo" required class="{{ 'input-error' if errors.get('sexo') else '' }}">
                    <option value="M" {{ 'selected' if form_data.get('sexo', 'M') == 'M' else '' }}>Masculino</option>
                    <option value="F" {{ 'selected' if form_data.get('sexo', 'M') == 'F' else '' }}>Femenino</option>
                </select>
            </div>

            <div class="form-group">
                <label for="telefono">Teléfono</label>
                <input 
                    type="tel" 
                    id="telefono" 
                    name="telefono" 
                    placeholder="999999999" 
                    maxlength="9"
                    pattern="[0-9]{9}"
                    value="{{ form_data.get('telefono', '') }}"
                    class="{{ 'input-error' if errors.get('telefono') else '' }}"
                >
                <div class="validation-message {{ 'error' if errors.get('telefono') }}" id="telefono-message">{{ errors.get('telefono', '') }}</div>
            </div>

            {% if errors.get('general') %}
            <div class="alert alert-error">{{ errors.get('general') }}</div>
            {% endif %}

            <!-- Checkbox de Términos y Condiciones -->
            <div class="form-group terminos-container" style="margin-top: 30px; margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 1px solid #e0e0e0;">
                <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer; font-weight: normal; margin: 0;">
                    <input 
                        type="checkbox" 
                        id="aceptar_terminos" 
                        name="aceptar_terminos" 
                        value="1" 
                        required
                        style="width: auto; margin-top: 2px; cursor: pointer; flex-shrink: 0;"
                        class="{{ 'input-error' if errors.get('aceptar_terminos') else '' }}"
                    >
                    <span style="font-size: 14px; line-height: 1.6; color: #333;">
                        Acepto los <a href="#" onclick="mostrarTerminos(); return false;" style="color: #328336; text-decoration: underline; font-weight: 600;">términos y condiciones</a> de uso del servicio
                    </span>
                </label>
                <div class="validation-message {{ 'error' if errors.get('aceptar_terminos') }}" id="terminos-message" style="display: {{ 'block' if errors.get('aceptar_terminos') else 'none' }}; margin-top: 8px; margin-left: 0;">
                    {{ errors.get('aceptar_terminos', '') }}
                </div>
            </div>

            <button type="submit" class="btn-registro" id="btnSubmit">
                <i class="fas fa-user-plus"></i> Crear Cuenta
            </button>
        </form>

        <div class="registro-footer">
            <p>¿Ya tienes una cuenta? <a href="{{ url_for('usuarios.Login', return_url=return_url) }}">Inicia sesión aquí</a></p>
        </div>
    </div>
</div>

<script>
    // Toggle password visibility
    document.getElementById('togglePassword').addEventListener('click', function() {
        const passwordInput = document.getElementById('contrasena');
        const icon = this;
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });

    document.getElementById('toggleConfirmPassword').addEventListener('click', function() {
        const passwordInput = document.getElementById('confirmar_contrasena');
        const icon = this;
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });

    // Validación en tiempo real de contraseñas
    const passwordInput = document.getElementById('contrasena');
    const confirmPasswordInput = document.getElementById('confirmar_contrasena');
    const confirmMessage = document.getElementById('confirm-message');

    confirmPasswordInput.addEventListener('input', function() {
        if (confirmPasswordInput.value === '') {
            confirmMessage.style.display = 'none';
        } else if (confirmPasswordInput.value === passwordInput.value) {
            confirmMessage.textContent = '✓ Las contraseñas coinciden';
            confirmMessage.className = 'validation-message success';
        } else {
            confirmMessage.textContent = '✗ Las contraseñas no coinciden';
            confirmMessage.className = 'validation-message error';
        }
    });

    passwordInput.addEventListener('input', function() {
        if (confirmPasswordInput.value !== '') {
            if (confirmPasswordInput.value === passwordInput.value) {
                confirmMessage.textContent = '✓ Las contraseñas coinciden';
                confirmMessage.className = 'validation-message success';
            } else {
                confirmMessage.textContent = '✗ Las contraseñas no coinciden';
                confirmMessage.className = 'validation-message error';
            }
        }
    });

    // Auto-hide alerts after 5 seconds
    setTimeout(() => {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            alert.style.transition = 'opacity 0.5s ease';
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 500);
        });
    }, 5000);

    // Validación de términos y condiciones
    const terminosCheckbox = document.getElementById('aceptar_terminos');
    const terminosMessage = document.getElementById('terminos-message');
    const formulario = document.querySelector('form');

    if (terminosCheckbox && formulario) {
        // Validar al hacer submit
        formulario.addEventListener('submit', function(e) {
            if (!terminosCheckbox.checked) {
                e.preventDefault();
                terminosMessage.textContent = 'Debes aceptar los términos y condiciones para continuar';
                terminosMessage.className = 'validation-message error';
                terminosMessage.style.display = 'block';
                terminosCheckbox.classList.add('input-error');
                terminosCheckbox.focus();
                return false;
            }
        });

        // Limpiar error al marcar el checkbox
        terminosCheckbox.addEventListener('change', function() {
            if (this.checked) {
                terminosMessage.style.display = 'none';
                this.classList.remove('input-error');
            }
        });
    }

    // Función para mostrar términos (debe estar disponible desde Master.html)
    if (typeof mostrarTerminos === 'undefined') {
        window.mostrarTerminos = function() {
            alert('Por favor, revisa los términos y condiciones en el footer de la página.');
        };
    }
</script>

<!-- Script de validaciones completas -->
<script src="{{ url_for('static', filename='JS/registro_validations.js') }}"></script>
{% endblock %}

