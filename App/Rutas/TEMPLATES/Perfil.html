{% extends "Master.html" %}

{% block stiles %}
<style>
    .perfil-container {
        min-height: calc(100vh - 80px);
        padding: 140px 20px 60px 20px;
        background: #f5f5f5;
    }

    .perfil-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        gap: 30px;
    }

    /* Menú lateral */
    .perfil-sidebar {
        width: 280px;
        background: white;
        border-radius: 15px;
        padding: 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        height: fit-content;
        position: sticky;
        top: 140px;
    }

    .sidebar-header {
        padding: 25px 20px;
        border-bottom: 2px solid #328336;
        background: linear-gradient(135deg, #328336 0%, #64CC4F 100%);
        border-radius: 15px 15px 0 0;
    }

    .sidebar-header h3 {
        margin: 0;
        color: white;
        font-size: 20px;
        font-weight: 700;
    }

    .sidebar-menu {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .sidebar-menu li {
        border-bottom: 1px solid #f0f0f0;
    }

    .sidebar-menu li:last-child {
        border-bottom: none;
    }

    .sidebar-menu button,
    .sidebar-menu a {
        width: 100%;
        padding: 18px 20px;
        border: none;
        background: white;
        text-align: left;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 15px;
        color: #333;
        font-weight: 500;
    }

    .sidebar-menu button i,
    .sidebar-menu a i {
        width: 24px;
        color: #328336;
        font-size: 18px;
    }

    .sidebar-menu button:hover,
    .sidebar-menu a:hover {
        background: #f8f9fa;
        padding-left: 30px;
        color: #328336;
    }

    .sidebar-menu button.active {
        background: #e8f5e9;
        color: #328336;
        border-left: 4px solid #328336;
        font-weight: 600;
    }

    /* Contenido principal */
    .perfil-main {
        flex: 1;
        background: white;
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .section-content {
        display: none;
    }

    .section-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .section-title {
        font-size: 28px;
        font-weight: 700;
        color: #333;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 3px solid #328336;
    }

    /* Formulario de datos */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 25px;
        margin-bottom: 30px;
    }

    .form-group {
        margin-bottom: 0;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 15px;
        transition: all 0.3s ease;
        background: #f8f9fa;
        box-sizing: border-box;
    }

    .form-group .form-control {
    box-sizing: border-box; 
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #328336;
        background: white;
        box-shadow: 0 0 0 3px rgba(50, 131, 54, 0.1);
    }

    .form-group input:disabled,
    .form-group select:disabled {
        background: #f8f9fa;
        color: #666;
        cursor: not-allowed;
    }

    .form-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 30px;
        border-top: 2px solid #f0f0f0;
    }

    .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #328336 0%, #64CC4F 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(50, 131, 54, 0.3);
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }

    .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }

    .btn-danger:hover {
        background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    /* Alertas */
    .alert {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
        animation: slideDown 0.3s ease;
    }

    .alert.show {
        display: block;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
    }

    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
    }

    /* Estilos para botones de estado de incidencias */
    .btn-estado {
        transition: all 0.3s ease;
        border: 2px solid;
        background: white;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        padding: 12px;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn-estado:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-estado.active {
        color: white;
        font-weight: 700;
    }

    .btn-estado[data-estado="1"] {
        border-color: #28a745;
        color: #28a745;
    }

    .btn-estado[data-estado="1"]:hover,
    .btn-estado[data-estado="1"].active {
        background: #28a745;
        color: white;
    }

    .btn-estado[data-estado="2"] {
        border-color: #dc3545;
        color: #dc3545;
    }

    .btn-estado[data-estado="2"]:hover,
    .btn-estado[data-estado="2"].active {
        background: #dc3545;
        color: white;
    }

    .btn-estado[data-estado="3"] {
        border-color: #ffc107;
        color: #ffc107;
    }

    .btn-estado[data-estado="3"]:hover,
    .btn-estado[data-estado="3"].active {
        background: #ffc107;
        color: white;
    }

    /* Secciones vacías */
    .empty-section {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }

    .empty-section i {
        font-size: 64px;
        color: #ddd;
        margin-bottom: 20px;
    }

    .empty-section h3 {
        color: #666;
        margin-bottom: 10px;
    }

    .empty-section p {
        color: #999;
    }

    /* Estilos para el módulo de empleados */
    .search-filters-section {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        flex-wrap: wrap;
    }

    .search-section {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
        min-width: 300px;
    }

    .search-label {
        font-weight: 600;
        color: #2c3e50;
        white-space: nowrap;
    }

    .search-form {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
    }

    .search-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
        min-width: 200px;
    }

    .search-input:focus {
        outline: none;
        border-color: #28a745;
    }

    .search-button {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .search-button:hover {
        background: #218838;
    }

    .filters-section {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filter-label {
        font-weight: 600;
        color: #2c3e50;
        white-space: nowrap;
    }

    .filter-form {
        display: flex;
        align-items: center;
    }

    .rol-select {
        padding: 12px 16px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        background: white;
        font-size: 14px;
        cursor: pointer;
        transition: border-color 0.3s ease;
        min-width: 150px;
    }

    .rol-select:focus {
        outline: none;
        border-color: #28a745;
    }

    .actions-section {
        margin-left: auto;
    }

    .create-button {
        background: #28a745;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.3s ease;
        white-space: nowrap;
        border: none;
        cursor: pointer;
    }

    .create-button:hover {
        background: #218838;
        color: white;
        text-decoration: none;
    }

    /* Tabla de empleados */
    .table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 30px;
    }

    .empleados-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .empleados-table thead {
        background: #2c3e50;
        color: white;
    }

    .empleados-table th {
        padding: 16px 20px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
    }

    /* Estilos específicos para encabezados de columna */
    .empleados-table th:nth-child(3) {
        text-align: center;
    }

    .empleados-table th:nth-child(4) {
        text-align: right;
        padding-right: 55px;
    }

    .empleados-table tbody tr {
        border-bottom: 1px solid #e9ecef;
        transition: background-color 0.3s ease;
    }

    .empleados-table tbody tr:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }

    .empleados-table tbody tr:last-child {
        border-bottom: none;
    }

    .empleados-table td {
        padding: 16px 20px;
        vertical-align: middle;
    }

    .phone-cell {
        font-weight: 500;
        color: #495057;
    }

    .name-cell {
        font-weight: 600;
        color: #2c3e50;
    }

    .shift-cell {
        text-align: center !important;
        vertical-align: middle;
    }

    .shift-badge {
        background: #e3f2fd;
        color: #1976d2;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
        text-align: center;
    }

    .actions-cell {
        text-align: right !important;
        padding-right: 25px !important;
    }

    .action-buttons {
        display: flex !important;
        gap: 8px;
        justify-content: flex-end !important;
    }

    .action-btn {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }

    .calendar-btn {
        background: #28a745;
        color: white;
    }

    .calendar-btn:hover {
        background: #218838;
        color: white;
        text-decoration: none;
        transform: scale(1.1);
    }

    .calendar-btn.disabled {
        background: #6c757d !important;
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    .calendar-btn.disabled:hover {
        background: #6c757d !important;
        transform: none;
    }

    .edit-btn {
        background: #ffc107;
        color: #212529;
    }

    .edit-btn:hover {
        background: #e0a800;
        color: #212529;
        text-decoration: none;
        transform: scale(1.1);
    }

    .delete-btn {
        background: #dc3545;
        color: white;
        border: none;
    }

    .delete-btn:hover {
        background: #c82333;
        color: white;
        text-decoration: none;
        transform: scale(1.1);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .perfil-content {
            flex-direction: column;
        }

        .perfil-sidebar {
            width: 100%;
            position: static;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .search-filters-section {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }

        .search-section,
        .filters-section {
            flex: none;
            min-width: auto;
        }

        .actions-section {
            margin-left: 0;
        }

        .create-button {
            justify-content: center;
        }
    }

    /* Estilos para modales */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s ease;
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 15px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
    }

    .modal-title {
        font-size: 24px;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6c757d;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: #f8f9fa;
        color: #dc3545;
    }

    .modal-body {
        margin-bottom: 25px;
    }

    .modal-footer {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
    }

    .btn-modal {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-modal-primary {
        background: #28a745;
        color: white;
    }

    .btn-modal-primary:hover {
        background: #218838;
    }

    .btn-modal-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-modal-secondary:hover {
        background: #5a6268;
    }

    .employee-details {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    .detail-group {
        display: flex;
        flex-direction: column;
    }

    .detail-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
        font-size: 14px;
    }

    .detail-value {
        color: #495057;
        font-size: 16px;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }

    .estado-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .estado-activo {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .estado-inactivo {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Estilos para notificaciones toast */
    #notification-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 350px;
        max-width: 400px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 0;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    }

    #notification-toast.show {
        opacity: 1;
        transform: translateX(0);
    }

    #notification-toast.success {
        border-left: 4px solid #28a745;
    }

    #notification-toast.error {
        border-left: 4px solid #dc3545;
    }

    .notification-toast-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 20px;
        color: #999;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .notification-toast-close:hover {
        background: #f8f9fa;
        color: #333;
    }

    .notification-toast-header {
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .notification-toast-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    #notification-toast.success .notification-toast-icon {
        background: #d4edda;
        color: #28a745;
    }

    #notification-toast.error .notification-toast-icon {
        background: #f8d7da;
        color: #dc3545;
    }

    .notification-toast-body {
        flex: 1;
    }

    .notification-toast-title {
        margin: 0 0 5px 0;
        font-size: 16px;
        font-weight: 600;
        color: #333;
    }

    .notification-toast-message {
        margin: 0;
        font-size: 14px;
        color: #666;
    }

    /* Estilos para el modal de confirmación */
    .modal-confirm {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .modal-confirm.show {
        opacity: 1;
    }

    .modal-confirm-content {
        background: white;
        border-radius: 15px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        text-align: center;
        animation: slideIn 0.3s ease;
    }

    .modal-confirm-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #fff3cd;
        color: #856404;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
        margin: 0 auto 20px;
    }

    .modal-confirm-title {
        font-size: 24px;
        font-weight: 700;
        color: #2c3e50;
        margin: 0 0 10px 0;
    }

    .modal-confirm-message {
        font-size: 16px;
        color: #666;
        margin: 0 0 25px 0;
        line-height: 1.5;
    }

    .modal-confirm-message small {
        display: block;
        margin-top: 10px;
        font-size: 14px;
        color: #999;
    }

    .modal-confirm-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
    }

    .btn-confirm {
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-confirm-danger {
        background: #dc3545;
        color: white;
    }

    .btn-confirm-danger:hover {
        background: #c82333;
        transform: translateY(-2px);
    }

    .btn-confirm-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-confirm-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }

    /* Esto fuerza a la tabla a obedecer los anchos que definamos */
    #promociones .empleados-table {
        table-layout: fixed; 
    }

    /* Centramos el texto de todas las cabeceras y celdas, excepto la Descripción */
    #promociones .empleados-table th,
    #promociones .empleados-table td {
        text-align: center;
        vertical-align: middle; /* Asegura que el texto esté centrado verticalmente */
    }

    /* Dejamos la Descripción alineada a la izquierda */
    #promociones .empleados-table th:nth-child(2),
    #promociones .empleados-table td:nth-child(2) {
        text-align: left;
        word-break: break-word; /* Permite que descripciones largas se partan en varias líneas */
    }

    /* --- Definición de anchos de columna --- */

    #promociones .empleados-table th:nth-child(1), /* ID */
    #promociones .empleados-table td:nth-child(1) {
        width: 50px; 
    }

    #promociones .empleados-table th:nth-child(2), /* Descripción */
    #promociones .empleados-table td:nth-child(2) {
        width: auto; /* 'auto' hará que esta columna ocupe el espacio sobrante */
    }

    #promociones .empleados-table th:nth-child(3), /* Descuento */
    #promociones .empleados-table td:nth-child(3) {
        width: 100px;
    }

    #promociones .empleados-table th:nth-child(4), /* Vigencia */
    #promociones .empleados-table td:nth-child(4) {
        width: 190px; /* Ancho para que entren las dos fechas */
    }

    #promociones .empleados-table th:nth-child(5), /* Estado */
    #promociones .empleados-table td:nth-child(5) {
        width: 90px;
    }

    #promociones .empleados-table th:nth-child(6), /* Acción */
    #promociones .empleados-table td:nth-child(6) {
        width: 110px;
    }
    /* === FIN: Código para arreglar anchos de tabla === */

    </style>

{% endblock %}

{% block content %}
<div class="perfil-container">
    <div class="perfil-content">
        <!-- Menú lateral -->
        <aside class="perfil-sidebar">
            <div class="sidebar-header">
                <h3>Mi Perfil</h3>
            </div>
            <ul class="sidebar-menu">
                <li>
                    <button class="menu-btn active" data-section="mis-datos">
                        <i class="fas fa-user"></i>
                        <span>Mis Datos</span>
                    </button>
                </li>
                <li>
                    <button class="menu-btn" data-section="incidencias">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Gestionar Incidencias</span>
                    </button>
                </li>
                <li>
                    <button class="menu-btn" data-section="room-service">
                        <i class="fas fa-concierge-bell"></i>
                        <span>Room Service</span>
                    </button>
                </li>
                {% if session.get('rol_id') == 1 %}
                <li>
                    <button class="menu-btn" data-section="empleados">
                        <i class="fas fa-users"></i>
                        <span>Gestionar Empleados</span>
                    </button>
                </li>
                <li>
                    <button class="menu-btn" data-section="promociones">
                        <i class="fas fa-tags"></i>
                        <span>Gestionar Promociones</span>
                    </button>
                </li>
                {% endif %}
            </ul>
        </aside>

        <!-- Contenido principal -->
        <main class="perfil-main">
            <!-- Sección: Mis Datos -->
            <div class="section-content active" id="mis-datos">
                <h2 class="section-title">Mis Datos Personales</h2>

                <div class="alert alert-success" id="alert-success">
                    <i class="fas fa-check-circle"></i> Datos actualizados correctamente
                </div>

                <div class="alert alert-error" id="alert-error">
                    <i class="fas fa-exclamation-circle"></i> <span id="error-message"></span>
                </div>

                <form id="form-perfil">
                    <div class="form-grid">
                        <!-- Campos comunes -->
                        <div class="form-group">
                            <label for="email">Correo Electrónico *</label>
                            <input type="email" id="email" name="email" value="{{ perfil.email }}" 
                                {% if perfil.tipo_perfil == 'empleado' %}disabled{% else %}disabled{% endif %} required>
                        </div>

                        {% if perfil.tipo_perfil == 'empleado' %}
                        <!-- Campos específicos para EMPLEADO -->
                        <div class="form-group">
                            <label for="cod_empleado">Código de Empleado</label>
                            <input type="text" id="cod_empleado" name="cod_empleado" 
                                value="{{ perfil.cod_empleado }}" disabled readonly>
                        </div>

                        <div class="form-group">
                            <label for="num_documento">DNI *</label>
                            <input type="text" id="num_documento" name="num_documento"
                                value="{{ perfil.num_documento }}" disabled required maxlength="8">
                        </div>

                        <div class="form-group">
                            <label for="nombres">Nombres *</label>
                            <input type="text" id="nombres" name="nombres" value="{{ perfil.nombres }}" disabled
                                required maxlength="50">
                        </div>

                        <div class="form-group">
                            <label for="apellido_paterno">Apellido Paterno *</label>
                            <input type="text" id="apellido_paterno" name="apellido_paterno"
                                value="{{ perfil.apellido_paterno }}" disabled required maxlength="50">
                        </div>

                        <div class="form-group">
                            <label for="apellido_materno">Apellido Materno *</label>
                            <input type="text" id="apellido_materno" name="apellido_materno"
                                value="{{ perfil.apellido_materno }}" disabled required maxlength="50">
                        </div>

                        <div class="form-group">
                            <label for="sexo">Sexo *</label>
                            <select id="sexo" name="sexo" disabled required>
                                <option value="M" {% if perfil.sexo=='M' %}selected{% endif %}>Masculino</option>
                                <option value="F" {% if perfil.sexo=='F' %}selected{% endif %}>Femenino</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="telefono">Teléfono/Móvil *</label>
                            <input type="tel" id="telefono" name="telefono" value="{{ perfil.telefono }}" disabled
                                required maxlength="9" pattern="[0-9]{9}">
                        </div>

                        <div class="form-group">
                            <label for="tipo_empleado">Tipo de Empleado</label>
                            <input type="text" id="tipo_empleado" value="{{ perfil.tipo_empleado }}" 
                                disabled readonly>
                        </div>

                        <div class="form-group">
                            <label for="estado_empleado">Estado</label>
                            <input type="text" id="estado_empleado" value="{{ perfil.estado_empleado }}" 
                                disabled readonly>
                        </div>

                        {% else %}
                        <!-- Campos específicos para CLIENTE -->
                        <div class="form-group">
                            <label for="tipo_documento_id">Tipo de Documento *</label>
                            <select id="tipo_documento_id" name="tipo_documento_id" disabled required>
                                {% for tipo in tipos_documento %}
                                <option value="{{ tipo.tipo_doc_id }}" {% if perfil.tipo_documento_id==tipo.tipo_doc_id
                                    %}selected{% endif %}>
                                    {{ tipo.nombre_tipo_doc }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="num_documento">Número de Documento *</label>
                            <input type="text" id="num_documento" name="num_documento"
                                value="{{ perfil.num_documento }}" disabled required maxlength="20">
                        </div>

                        <div class="form-group">
                            <label for="nombres">Nombres *</label>
                            <input type="text" id="nombres" name="nombres" value="{{ perfil.nombres }}" disabled
                                required maxlength="50">
                        </div>

                        <div class="form-group">
                            <label for="apellido_paterno">Apellido Paterno *</label>
                            <input type="text" id="apellido_paterno" name="apellido_paterno"
                                value="{{ perfil.apellido_paterno }}" disabled required maxlength="50">
                        </div>

                        <div class="form-group">
                            <label for="apellido_materno">Apellido Materno *</label>
                            <input type="text" id="apellido_materno" name="apellido_materno"
                                value="{{ perfil.apellido_materno }}" disabled required maxlength="50">
                        </div>

                        <div class="form-group">
                            <label for="telefono">Teléfono</label>
                            <input type="tel" id="telefono" name="telefono" value="{{ perfil.telefono }}" disabled
                                maxlength="9" pattern="[0-9]{9}">
                        </div>

                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="direccion">Dirección</label>
                            <input type="text" id="direccion" name="direccion" value="{{ perfil.direccion }}" 
                                disabled maxlength="255">
                        </div>
                        {% endif %}
                    </div>

                    <div class="form-actions">
                        {% if perfil.tipo_perfil == 'empleado' %}
                        <!-- Los empleados solo pueden ver sus datos, no editarlos -->
                        <div style="padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px; margin-bottom: 15px; width: 100%;">
                            <i class="fas fa-info-circle" style="color: #856404;"></i>
                            <strong>Nota:</strong> Los datos de empleados solo pueden ser modificados por un administrador desde la sección de Gestionar Empleados.
                        </div>
                        {% else %}
                        <!-- Los clientes pueden editar sus datos -->
                        <button type="button" class="btn btn-primary" id="btn-editar">
                            <i class="fas fa-edit"></i> Editar Datos
                        </button>
                        <button type="button" class="btn btn-secondary" id="btn-cancelar" style="display: none;">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" id="btn-guardar" style="display: none;">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                        {% endif %}
                        
                        <button type="button" class="btn btn-danger" id="btn-eliminar-cuenta" 
                            style="margin-left: auto;">
                            <i class="fas fa-trash-alt"></i> Eliminar Cuenta
                        </button>
                    </div>
                </form>
            </div>

            <!-- Sección: Gestionar Incidencias -->
            <div class="section-content" id="incidencias">
                <!-- Alertas de incidencias -->
                <div class="alert alert-success" id="alert-incidencia-success" style="display: none;">
                    <i class="fas fa-check-circle"></i> <span id="incidencia-success-message"></span>
                </div>

                <div class="alert alert-error" id="alert-incidencia-error" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i> <span id="incidencia-error-message"></span>
                </div>

                <!-- Panel principal de incidencias -->
                <div id="panel-incidencias">
                    <!-- Encabezado con título y búsqueda -->
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <h2 style="margin: 0; color: #328336;">
                            <i class="fas fa-exclamation-triangle"></i> Mis Incidencias
                        </h2>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="buscar-incidencias" placeholder="Buscar incidencias..."
                                style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; width: 250px;">
                            <button class="btn btn-primary" onclick="buscarIncidencias()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Tabla de incidencias -->
                    <div
                        style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #328336; color: white;">
                                <tr>
                                    <th style="padding: 15px; text-align: left; font-weight: 600;">Fecha de Envío</th>
                                    <th style="padding: 15px; text-align: left; font-weight: 600;">Fecha de Resolución
                                    </th>
                                    <th style="padding: 15px; text-align: left; font-weight: 600;">Título</th>
                                    <th style="padding: 15px; text-align: left; font-weight: 600;">Estado</th>
                                    <th style="padding: 15px; text-align: center; font-weight: 600;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-incidencias">
                                <tr>
                                    <td colspan="5" style="padding: 40px; text-align: center; color: #999;">
                                        <i class="fas fa-spinner fa-spin"
                                            style="font-size: 24px; margin-bottom: 10px;"></i>
                                        <p>Cargando incidencias...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Botón crear incidencia -->
                    <div style="text-align: right; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="mostrarFormularioIncidencia()"
                            style="padding: 12px 24px; font-size: 16px;">
                            <i class="fas fa-plus"></i> Crear Incidencia
                        </button>
                    </div>
                </div>

                <!-- Formulario de nueva/editar incidencia -->
                <div id="formulario-incidencia"
                    style="display: none; margin-bottom: 30px; padding: 30px; background: #f8f9fa; border-radius: 10px; position: relative; z-index: 1000; border: 2px solid #328336;">
                    <h3 style="margin-bottom: 25px; color: #328336;">
                        <i class="fas fa-file-alt"></i>
                        <span id="form-titulo">Nueva Incidencia</span>
                    </h3>

                    <form id="form-nueva-incidencia" enctype="multipart/form-data">
                        <input type="hidden" id="incidencia_id_edit" name="incidencia_id" value="">

                        <!-- Datos de Incidencia -->
                        <h4
                            style="color: #328336; margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid #328336; padding-bottom: 10px;">
                            Datos de Incidencia
                        </h4>

                        <div class="form-group" style="margin-bottom: 20px;">
                            <label for="incidencia-titulo">Título *</label>
                            <input type="text" id="incidencia-titulo" name="titulo" class="form-control" required
                                maxlength="255"
                                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        </div>

                        <div class="form-group" style="margin-bottom: 20px;">
                            <label for="incidencia-descripcion">Descripción *</label>
                            <textarea id="incidencia-descripcion" name="descripcion" class="form-control" required
                                rows="4"
                                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical;"></textarea>
                        </div>

                        <div class="form-grid"
                            style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="incidencia-tipo">Tipo de Incidencia *</label>
                                <select id="incidencia-tipo" name="tipo_incidencia_id" class="form-control" required
                                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                        <option value="">Cargando tipos...</option>
                                        </select>
                            </div>

                            <div class="form-group">
                                <label for="incidencia-comprobante">Comprobante</label>
                                <input type="text" id="incidencia-comprobante" name="numero_comprobante"
                                    class="form-control" maxlength="20" placeholder="Ej: B001-0001"
                                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>

                            <div class="form-group">
                                <label for="incidencia-evidencia">Evidencia (Imagen)</label>
                                <input type="file" id="incidencia-evidencia" name="evidencia" class="form-control"
                                    accept="image/*"
                                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <small style="color: #666; font-size: 12px;">Formatos: JPG, PNG, GIF (Máx. 5MB)</small>
                            </div>
                        </div>

                        <!-- Evaluación (Para administradores) -->
                        <div id="seccion-evaluacion" style="margin-top: 30px; display: none;">
                            <h4
                                style="color: #328336; margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid #328336; padding-bottom: 10px;">
                                <i class="fas fa-cogs"></i> Evaluación y Respuesta
                            </h4>

                            <!-- Estado de la incidencia -->
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #328336;">
                                    Estado de la Incidencia
                                </label>
                                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                        <input type="radio" name="estado_incidencia" value="3" id="estado-proceso"
                                            style="margin: 0;">
                                        <span style="color: #ffc107; font-weight: 600;">
                                            <i class="fas fa-clock"></i> En Proceso
                                        </span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                        <input type="radio" name="estado_incidencia" value="1" id="estado-aprobado"
                                            style="margin: 0;">
                                        <span style="color: #28a745; font-weight: 600;">
                                            <i class="fas fa-check-circle"></i> Aprobado
                                        </span>
                                    </label>
                                    <label
                                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                        <input type="radio" name="estado_incidencia" value="2" id="estado-rechazado"
                                            style="margin: 0;">
                                        <span style="color: #dc3545; font-weight: 600;">
                                            <i class="fas fa-times-circle"></i> Rechazado
                                        </span>
                                    </label>
                                </div>
                            </div>

                            <!-- Respuesta del hotel -->
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label for="incidencia-respuesta"
                                    style="display: block; margin-bottom: 10px; font-weight: 600; color: #328336;">
                                    <i class="fas fa-reply"></i> Respuesta del Hotel
                                </label>
                                <textarea id="incidencia-respuesta" name="respuesta" class="form-control" rows="4"
                                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical;"
                                    placeholder="Escriba la respuesta del hotel..."></textarea>
                                <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                    <i class="fas fa-info-circle"></i> Esta respuesta será visible para el cliente
                                </small>
                            </div>
                        </div>

                        <div class="form-actions"
                            style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px; padding-top: 25px; border-top: 2px solid #e0e0e0;">
                            <button type="button" class="btn btn-secondary" onclick="volverALista()">
                                <i class="fas fa-arrow-left"></i> Volver
                            </button>
                            <button type="submit" class="btn btn-primary" id="btn-guardar-incidencia">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sección: Room Service -->
            <div class="section-content" id="room-service">
                <h2 class="section-title">Room Service</h2>
                <iframe src="/Roomservice/roomservice_perfil" style="width:100%; height:600px; border:none;"></iframe>
            </div>

            <!-- Sección: Gestionar Empleados -->
            {% if session.get('rol_id') == 1 %}
            <div class="section-content" id="empleados">
                <h2 class="section-title">Gestionar Empleados</h2>

                <!-- Barra de búsqueda y filtros -->
                <div class="search-filters-section">
                    <div class="search-section">
                        <label for="search-input" class="search-label">Buscar</label>
                        <div class="search-form">
                            <input type="text" id="search-input" name="search" class="search-input"
                                placeholder="Buscar por nombre, apellido o numero telefonico...">

                            <button type="button" class="search-button" onclick="filtrarEmpleados()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <div class="filters-section">
                        <label for="rol-filter" class="filter-label">Rol</label>
                        <div class="filter-form">
                            <select id="rol-filter" name="rol" class="rol-select">
                                <option value="">Seleccione rol</option>
                                <option value="administrador">Administrador</option>
                                <option value="recepcionista">Recepcionista</option>
                                <option value="limpieza">Limpieza</option>
                            </select>
                        </div>
                    </div>

                    <div class="actions-section">
                        <button class="create-button" onclick="mostrarFormularioCrear()">
                            <i class="fas fa-plus"></i>
                            Crear
                        </button>
                    </div>
                </div>

                <!-- Tabla de empleados -->
                <div class="table-container">
                    <table class="empleados-table">
                        <thead>
                            <tr>
                                <th>Teléfono</th>
                                <th>Nombre completo</th>
                                <th>Turno</th>
                                <th>ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los empleados se cargarán dinámicamente desde la API -->
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
            {% if session.get('rol_id') == 1 %}
            <div class="section-content" id="promociones">
                <h2 class="section-title">Gestionar Promociones</h2>

                <div class="alert alert-success" id="alert-promo-success" style="display: none;"></div>
                <div class="alert alert-error" id="alert-promo-error" style="display: none;"></div>

                <div class="form-promocion"
                    style="background: #f9f9f9; padding: 25px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #328336;">
                    
                    <h3 style="color: #328336; margin-top: 0;">
                        <i class="fas fa-plus-circle"></i> Crear Nueva Promoción
                    </h3>

                    <form id="form-promocion" style="margin-bottom: 0;">
                        
                        <div class="form-grid" style="margin-bottom: 25px;">
                            <div class="form-group">
                                <label for="promo-tipo">Tipo de Promoción *</label>
                                <select id="promo-tipo" name="tipo_promocion_id" required>
                                    <option value="">Cargando tipos...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="promo-porcentaje">Porcentaje de Descuento (%) *</label>
                                <input type="number" id="promo-porcentaje" name="porcentaje" placeholder="Ej: 15" min="1"
                                    max="100" required>
                            </div>

                            <div class="form-group">
                                <label for="promo-fecha-inicio">Fecha de Inicio *</label>
                                <input type="date" id="promo-fecha-inicio" name="fecha_inicio" required>
                            </div>

                            <div class="form-group">
                                <label for="promo-fecha-fin">Fecha de Fin *</label>
                                <input type="date" id="promo-fecha-fin" name="fecha_fin" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="promo-descripcion">Descripción Breve *</label>
                            <input type="text" id="promo-descripcion" name="descripcion"
                                placeholder="Ej: Descuento de fin de semana" required>
                        </div>

                        <div class="form-actions" style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #f0f0f0;">
                            <button type="submit" class="btn btn-primary" id="btn-guardar-promo">
                                <i class="fas fa-save"></i> Guardar Promoción
                            </button>
                        </div>
                    </form>
                </div>

                <h3 style="color: #333; border-bottom: 2px solid #ddd; padding-bottom: 10px;">Promociones Existentes</h3>
                <div class="table-container">
                    <table class="empleados-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Descripción</th>
                                <th>Descuento</th>
                                <th>Vigencia</th>
                                <th>Estado</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-promociones-body">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px;">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

        </main>
    </div>
</div>

<!-- Modal de detalles del empleado -->
<div id="modalDetalles" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Detalles del Empleado</h3>
            <button class="modal-close" onclick="cerrarModal('modalDetalles')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="employee-details" id="detallesEmpleado">
                <!-- Los detalles se cargarán dinámicamente -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-modal btn-modal-secondary" onclick="cerrarModal('modalDetalles')">
                <i class="fas fa-times"></i>
                Cerrar
            </button>
        </div>
    </div>
</div>


<!-- Modal de confirmación (oculto por defecto) -->
<div id="modal-confirm" class="modal-confirm" style="display: none;">
    <div class="modal-confirm-content">
        <div class="modal-confirm-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 class="modal-confirm-title">Confirmar Acción</h3>
        <p class="modal-confirm-message">¿Estás seguro?</p>
        <div class="modal-confirm-buttons">
            <button class="btn-confirm btn-confirm-danger" onclick="confirmarAccion()">
                <i class="fas fa-trash"></i>
                Eliminar
            </button>
            <button class="btn-confirm btn-confirm-secondary" onclick="cancelarAccion()">
                <i class="fas fa-times"></i>
                Cancelar
            </button>
        </div>
    </div>
</div>

<!-- Modal de crear empleado -->
<div id="modalCrear" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Crear Nuevo Empleado</h3>
            <button class="modal-close" onclick="cerrarModal('modalCrear')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="formCrearEmpleado">
                <div class="employee-details">
                    <div class="detail-group">
                        <label class="detail-label" for="crear_nombres">Nombres *</label>
                        <input type="text" id="crear_nombres" name="nombres" class="detail-value"
                            pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+" title="Solo se permiten letras" required>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label" for="crear_ape_paterno">Apellido Paterno *</label>
                        <input type="text" id="crear_ape_paterno" name="ape_paterno" class="detail-value"
                            pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+" title="Solo se permiten letras" required>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label" for="crear_ape_materno">Apellido Materno *</label>
                        <input type="text" id="crear_ape_materno" name="ape_materno" class="detail-value"
                            pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+" title="Solo se permiten letras" required>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label" for="crear_dni">DNI *</label>
                        <input type="text" id="crear_dni" name="dni" class="detail-value" maxlength="8" required>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label" for="crear_telefono">Teléfono *</label>
                        <input type="text" id="crear_telefono" name="telefono" class="detail-value" maxlength="9"
                            pattern="^9[0-9]{8}$" title="El teléfono debe tener 9 dígitos y empezar con 9" required>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label" for="crear_sexo">Sexo *</label>
                        <select id="crear_sexo" name="sexo" class="detail-value" required>
                            <option value="">Seleccione</option>
                            <option value="M">Masculino</option>
                            <option value="F">Femenino</option>
                        </select>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label" for="crear_rol">Rol *</label>
                        <select id="crear_rol" name="rol" class="detail-value" required>
                            <option value="">Seleccione rol</option>
                            <option value="1">Recepcionista</option>
                            <option value="2">Administrador</option>
                            <option value="3">Limpieza</option>
                        </select>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label" for="crear_codigo">Código de Empleado *</label>
                        <input type="text" id="crear_codigo" name="codigo" class="detail-value" readonly required>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-modal btn-modal-secondary" onclick="cerrarModal('modalCrear')">
                <i class="fas fa-times"></i>
                Cancelar
            </button>
            <button class="btn-modal btn-modal-primary" onclick="guardarEmpleado()">
                <i class="fas fa-save"></i>
                Guardar
            </button>
        </div>
    </div>
</div>

<!-- Modal de editar empleado -->
<div id="modalEditar" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Editar Empleado</h3>
            <button class="modal-close" onclick="cerrarModal('modalEditar')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="formEditarEmpleado">
                <div class="employee-details">
                    <div class="detail-group">
                        <label class="detail-label" for="editar_nombres">Nombres *</label>
                        <input type="text" id="editar_nombres" name="nombres" class="detail-value"
                            pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+" title="Solo se permiten letras" required>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label" for="editar_ape_paterno">Apellido Paterno *</label>
                        <input type="text" id="editar_ape_paterno" name="ape_paterno" class="detail-value"
                            pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+" title="Solo se permiten letras" required>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label" for="editar_ape_materno">Apellido Materno *</label>
                        <input type="text" id="editar_ape_materno" name="ape_materno" class="detail-value"
                            pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+" title="Solo se permiten letras" required>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label" for="editar_dni">DNI *</label>
                        <input type="text" id="editar_dni" name="dni" class="detail-value" maxlength="8" required>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label" for="editar_telefono">Teléfono *</label>
                        <input type="text" id="editar_telefono" name="telefono" class="detail-value" maxlength="9"
                            required>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label" for="editar_sexo">Sexo *</label>
                        <select id="editar_sexo" name="sexo" class="detail-value" required>
                            <option value="">Seleccione</option>
                            <option value="M">Masculino</option>
                            <option value="F">Femenino</option>
                        </select>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label" for="editar_rol">Rol *</label>
                        <select id="editar_rol" name="rol" class="detail-value" required>
                            <option value="">Seleccione rol</option>
                            <option value="1">Recepcionista</option>
                            <option value="2">Administrador</option>
                            <option value="3">Limpieza</option>
                        </select>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label" for="editar_codigo">Código de Empleado *</label>
                        <input type="text" id="editar_codigo" name="codigo" class="detail-value" readonly
                            style="background-color: #f8f9fa;">
                        <small style="color: #6c757d; font-size: 12px;">Se genera automáticamente</small>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label" for="editar_estado">Estado *</label>
                        <select id="editar_estado" name="estado" class="detail-value" required>
                            <option value="">Seleccione estado</option>
                            <option value="Activo">Activo</option>
                            <option value="Inactivo">Inactivo</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-modal btn-modal-secondary" onclick="cerrarModal('modalEditar')">
                <i class="fas fa-times"></i>
                Cancelar
            </button>
            <button class="btn-modal btn-modal-primary" onclick="actualizarEmpleado()">
                <i class="fas fa-save"></i>
                Guardar Cambios
            </button>
        </div>
    </div>
</div>

<!-- Modal de asignar turno -->
<div id="modalAsignarTurno" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Asignar Turno</h3>
            <button class="modal-close" onclick="cerrarModal('modalAsignarTurno')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="formAsignarTurno">
                <div class="employee-details">
                    <div class="detail-group">
                        <label class="detail-label" for="asignar_dni">Nro. de documento</label>
                        <input type="text" id="asignar_dni" name="dni" class="detail-value" readonly
                            style="background-color: #f8f9fa;">
                    </div>
                    <div class="detail-group">
                        <label class="detail-label" for="asignar_empleado">Empleado</label>
                        <input type="text" id="asignar_empleado" name="empleado" class="detail-value" readonly
                            style="background-color: #f8f9fa;">
                    </div>
                    <div class="detail-group">
                        <label class="detail-label" for="asignar_turno">Turno *</label>
                        <select id="asignar_turno" name="turno" class="detail-value" required>
                            <option value="">Seleccione turno</option>
                            <option value="1">Mañana</option>
                            <option value="2">Tarde</option>
                            <option value="3">Noche</option>
                        </select>
                    </div>
                    <!-- Campo oculto para el empleado_id -->
                    <input type="hidden" id="asignar_empleado_id" name="empleado_id" value="">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-modal btn-modal-secondary" onclick="cerrarModal('modalAsignarTurno')">
                <i class="fas fa-times"></i>
                Cancelar
            </button>
            <button class="btn-modal btn-modal-primary" onclick="guardarTurno()">
                <i class="fas fa-save"></i>
                Guardar
            </button>
        </div>
    </div>
</div>

<!-- Notificaciones toast (oculto por defecto) -->
<div id="notification-toast" class="notification-toast" style="display: none;">
    <button class="notification-toast-close" onclick="cerrarNotificacionToast()">
        <i class="fas fa-times"></i>
    </button>
    <div class="notification-toast-header">
        <div class="notification-toast-icon">
            <i class="fas fa-check"></i>
        </div>
        <div class="notification-toast-body">
            <h4 class="notification-toast-title">Título</h4>
            <p class="notification-toast-message">Mensaje</p>
        </div>
    </div>
</div>

<!-- Modal de confirmación (oculto por defecto) -->
<div id="modal-confirm" class="modal-confirm" style="display: none;">
    <div class="modal-confirm-content">
        <div class="modal-confirm-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 class="modal-confirm-title">Confirmar Acción</h3>
        <p class="modal-confirm-message">¿Estás seguro?</p>
        <div class="modal-confirm-buttons">
            <button class="btn-confirm btn-confirm-danger" onclick="confirmarAccion()">
                <i class="fas fa-trash"></i>
                Eliminar
            </button>
            <button class="btn-confirm btn-confirm-secondary" onclick="cancelarAccion()">
                <i class="fas fa-times"></i>
                Cancelar
            </button>
        </div>
    </div>
</div>

<script>
    // Variables
    const menuButtons = document.querySelectorAll('.menu-btn');
    const sections = document.querySelectorAll('.section-content');
    const btnEditar = document.getElementById('btn-editar');
    const btnCancelar = document.getElementById('btn-cancelar');
    const btnGuardar = document.getElementById('btn-guardar');
    const formPerfil = document.getElementById('form-perfil');
    const inputs = formPerfil.querySelectorAll('input:not([readonly]), select:not([readonly])');
    const alertSuccess = document.getElementById('alert-success');
    const alertError = document.getElementById('alert-error');
    const errorMessage = document.getElementById('error-message');

    // Valores originales del formulario
    let valoresOriginales = {};
    
    // Detectar si el usuario es empleado o cliente
    const esEmpleado = '{{ perfil.tipo_perfil }}' === 'empleado';

    // Cambiar de sección
    menuButtons.forEach(button => {
        button.addEventListener('click', () => {
            const sectionId = button.dataset.section;

            // Actualizar menú activo
            menuButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            // Mostrar sección correspondiente
            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === sectionId) {
                    section.classList.add('active');

                    // Inicializar empleados si es la sección de empleados
                    if (sectionId === 'empleados') {
                        setTimeout(() => {
                            inicializarEmpleados();
                        }, 100);
                     }
                     // ### INICIO DE CÓDIGO NUEVO ###
                     else if (sectionId === 'promociones') {
                        // Carga los datos cuando se hace clic en la pestaña
                        cargarTiposPromocion();
                        cargarPromociones();
                    }
                }
            });

            // Ocultar alertas
            hideAlerts();
        });
    });

    // Guardar valores originales
    function guardarValoresOriginales() {
        valoresOriginales = {};
        inputs.forEach(input => {
            valoresOriginales[input.name] = input.value;
        });
    }

    // Restaurar valores originales
    function restaurarValoresOriginales() {
        inputs.forEach(input => {
            if (valoresOriginales[input.name] !== undefined) {
                input.value = valoresOriginales[input.name];
            }
        });
    }

    // Habilitar edición (solo para clientes)
    if (btnEditar && !esEmpleado) {
        btnEditar.addEventListener('click', () => {
            guardarValoresOriginales();

            inputs.forEach(input => {
                if (!input.hasAttribute('readonly')) {
                    input.disabled = false;
                    input.style.background = 'white';
                }
            });

            btnEditar.style.display = 'none';
            btnCancelar.style.display = 'inline-flex';
            btnGuardar.style.display = 'inline-flex';

            hideAlerts();
        });
    }

    // Cancelar edición (solo para clientes)
    if (btnCancelar && !esEmpleado) {
        btnCancelar.addEventListener('click', () => {
            restaurarValoresOriginales();

            inputs.forEach(input => {
                input.disabled = true;
                input.style.background = '#f8f9fa';
            });

            btnEditar.style.display = 'inline-flex';
            btnCancelar.style.display = 'none';
            btnGuardar.style.display = 'none';

            hideAlerts();
        });
    }

    // Guardar cambios (solo para clientes)
    if (!esEmpleado) {
        formPerfil.addEventListener('submit', async (e) => {
            e.preventDefault();

            btnGuardar.disabled = true;
            btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            hideAlerts();

            const formData = new FormData(formPerfil);

            try {
                const response = await fetch('{{ url_for("usuarios.ActualizarPerfil") }}', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    // Deshabilitar campos
                    inputs.forEach(input => {
                        input.disabled = true;
                        input.style.background = '#f8f9fa';
                    });

                    // Actualizar valores originales
                    guardarValoresOriginales();

                    // Cambiar botones
                    btnEditar.style.display = 'inline-flex';
                    btnCancelar.style.display = 'none';
                    btnGuardar.style.display = 'none';

                    // Mostrar mensaje de éxito
                    showSuccess();
                } else {
                    showError(data.message || 'Error al actualizar los datos');
                }
            } catch (error) {
                showError('Error de conexión. Por favor, intente nuevamente.');
            } finally {
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
            }
        });
    }

    // Mostrar/ocultar alertas
    function showSuccess() {
        alertSuccess.classList.add('show');
        setTimeout(() => {
            alertSuccess.classList.remove('show');
        }, 5000);
    }

    function showError(message) {
        errorMessage.textContent = message;
        alertError.classList.add('show');
        setTimeout(() => {
            alertError.classList.remove('show');
        }, 5000);
    }

    function hideAlerts() {
        alertSuccess.classList.remove('show');
        alertError.classList.remove('show');
    }

    // Inicializar valores originales
    guardarValoresOriginales();

    // Eliminar cuenta
    const btnEliminarCuenta = document.getElementById('btn-eliminar-cuenta');
    
    btnEliminarCuenta.addEventListener('click', async () => {
        // Confirmación con SweetAlert o confirmación nativa
        const confirmacion = confirm(
            '⚠️ ADVERTENCIA: Esta acción es irreversible.\n\n' +
            '¿Estás seguro de que deseas eliminar tu cuenta?\n\n' +
            'Se eliminarán todos tus datos personales, reservas e incidencias.\n\n' +
            'Esta acción NO se puede deshacer.'
        );

        if (!confirmacion) {
            return;
        }

        // Segunda confirmación para estar completamente seguro
        const confirmacionFinal = confirm(
            '¿Estás COMPLETAMENTE seguro?\n\n' +
            'Esta es tu última oportunidad para cancelar.\n\n' +
            'Escribe "ELIMINAR" para confirmar.'
        );

        if (!confirmacionFinal) {
            return;
        }

        try {
            btnEliminarCuenta.disabled = true;
            btnEliminarCuenta.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';

            const response = await fetch('{{ url_for("usuarios.EliminarCuenta") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                alert('✅ ' + data.message);
                // Redirigir a la página de inicio
                window.location.href = '{{ url_for("Index") }}';
            } else {
                alert('❌ Error: ' + data.message);
                btnEliminarCuenta.disabled = false;
                btnEliminarCuenta.innerHTML = '<i class="fas fa-trash-alt"></i> Eliminar Cuenta';
            }
        } catch (error) {
            console.error('Error:', error);
            alert('❌ Error de conexión. Por favor, intente nuevamente.');
            btnEliminarCuenta.disabled = false;
            btnEliminarCuenta.innerHTML = '<i class="fas fa-trash-alt"></i> Eliminar Cuenta';
        }
    });

    // Datos de empleados (se cargarán desde la base de datos)
    let empleadosData = [];

    // Función para filtrar empleados
    function filtrarEmpleados() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
        const rolFilter = document.getElementById('rol-filter').value;

        let empleadosFiltrados = empleadosData.filter(empleado => {
            // Búsqueda más inteligente
            let cumpleBusqueda = false;

            if (searchTerm === '') {
                cumpleBusqueda = true; // Si no hay término de búsqueda, mostrar todos
            } else {
                // Buscar en nombre completo
                const nombreCompleto = empleado.nombre.toLowerCase();

                // Buscar por palabras que empiecen con el término
                const palabras = nombreCompleto.split(' ');
                cumpleBusqueda = palabras.some(palabra => palabra.startsWith(searchTerm));

                // También buscar en teléfono si es numérico
                if (!cumpleBusqueda && /^\d+$/.test(searchTerm)) {
                    cumpleBusqueda = empleado.telefono.includes(searchTerm);
                }
            }

            // Filtro por rol
            const cumpleRol = !rolFilter || empleado.rol.toLowerCase().includes(rolFilter.toLowerCase());

            return cumpleBusqueda && cumpleRol;
        });

        mostrarEmpleados(empleadosFiltrados);
    }



    // Función para mostrar empleados en la tabla
    function mostrarEmpleados(empleados) {
        const tbody = document.querySelector('#empleados .empleados-table tbody');

        if (empleados.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align: center; padding: 40px; color: #999;">
                        <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                        No se encontraron empleados
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = empleados.map(empleado => {
            const esInactivo = empleado.estado && empleado.estado.toLowerCase() === 'inactivo';
            const disabledClass = esInactivo ? 'disabled' : '';
            const buttonTitle = esInactivo ? 'Para asignar un turno, el empleado debe estar activo' : 'Asignar turno';

            return `
            <tr onclick="mostrarDetallesEmpleado(${empleado.id})" style="cursor: pointer;">
                <td class="phone-cell">${empleado.telefono}</td>
                <td class="name-cell">${empleado.nombre}</td>
                <td class="shift-cell">
                    <span class="shift-badge">${empleado.turno}</span>
                </td>
                <td class="actions-cell">
                    <div class="action-buttons">
                        <button class="action-btn calendar-btn ${disabledClass}" title="${buttonTitle}" 
                                ${esInactivo ? 'disabled' : ''} 
                                onclick="event.stopPropagation(); if (!${esInactivo}) asignarTurno(${empleado.id}); else alert('Para asignar un turno, el empleado debe estar activo');">
                            <i class="fas fa-calendar"></i>
                        </button>
                        <button class="action-btn edit-btn" title="Actualizar empleado" onclick="event.stopPropagation(); editarEmpleado(${empleado.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" title="Eliminar empleado" onclick="event.stopPropagation(); eliminarEmpleado(${empleado.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            `;
        }).join('');
    }

    // Variables para modales y notificaciones
    let confirmCallback = null;
    let empleadoEditando = null;

    // Funciones para las acciones de empleados
    async function asignarTurno(id) {
        const empleado = empleadosData.find(e => e.id === id);
        if (!empleado) return;

        // Validar que el empleado esté activo
        if (empleado.estado && empleado.estado.toLowerCase() === 'inactivo') {
            alert('Para asignar un turno, el empleado debe estar activo');
            return;
        }

        // Limpiar formulario y llenar datos
        document.getElementById('formAsignarTurno').reset();
        document.getElementById('asignar_dni').value = empleado.dni;
        document.getElementById('asignar_empleado').value = empleado.nombre;
        document.getElementById('asignar_empleado_id').value = empleado.id;

        // Cargar turnos y turno actual
        await cargarTurnosParaAsignar();
        await cargarTurnoActual(empleado.id);

        // Mostrar modal
        document.getElementById('modalAsignarTurno').classList.add('show');
    }

    function editarEmpleado(id) {
        const empleado = empleadosData.find(e => e.id === id);
        if (!empleado) return;

        // Mostrar modal de edición
        mostrarModalEdicion(empleado);
    }

    async function eliminarEmpleado(id) {
        const empleado = empleadosData.find(e => e.id === id);
        if (!empleado) return;

        // Mostrar modal de confirmación bonito
        mostrarModalConfirmacion(
            'Eliminar Empleado',
            `¿Estás seguro de que quieres eliminar a <strong>${empleado.nombre}</strong>?`,
            'Esta acción eliminará permanentemente el empleado de la base de datos.',
            async () => {
                try {
                    // Eliminar de la base de datos
                    const response = await fetch(`/Cruds/Empleados/eliminar/${id}`, {
                        method: 'POST'
                    });
                    const result = await response.json();

                    if (result.success) {
                        // Recargar la lista desde la BD
                        await cargarEmpleados();
                        mostrarNotificacionBonita('success', 'Empleado Eliminado', `${empleado.nombre} ha sido eliminado permanentemente.`);
                    } else {
                        mostrarNotificacionBonita('error', 'Error', result.message);
                    }
                } catch (error) {
                    console.error('Error al eliminar empleado:', error);
                    mostrarNotificacionBonita('error', 'Error', 'Error al eliminar el empleado. Intente nuevamente.');
                }
            }
        );
    }

    // Función para cargar empleados desde la base de datos
    async function cargarEmpleados() {
        try {
            const response = await fetch('/Cruds/Empleados/api/empleados');
            const data = await response.json();
            empleadosData = data.empleados || [];
            mostrarEmpleados(empleadosData);
        } catch (error) {
            console.error('Error al cargar empleados:', error);
            // Mostrar mensaje de error
            const tbody = document.querySelector('#empleados .empleados-table tbody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align: center; padding: 40px; color: #dc3545;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                        Error al cargar empleados
                    </td>
                </tr>
            `;
        }
    }

    // Inicializar cuando se carga la sección de empleados
    function inicializarEmpleados() {
        const searchInput = document.getElementById('search-input');
        const rolFilter = document.getElementById('rol-filter');

        if (searchInput && rolFilter) {
            // Event listeners para búsqueda en tiempo real
            searchInput.addEventListener('input', filtrarEmpleados);
            rolFilter.addEventListener('change', filtrarEmpleados);

            // Cargar empleados desde la base de datos
            cargarEmpleados();
        }
    }

    // Funciones para los modales
    function mostrarDetallesEmpleado(id) {
        const empleado = empleadosData.find(e => e.id === id);
        if (!empleado) return;

        const detallesContainer = document.getElementById('detallesEmpleado');

        // Determinar la clase CSS según el estado
        const estadoClass = empleado.estado && empleado.estado.toLowerCase() === 'activo' ? 'estado-activo' : 'estado-inactivo';
        const estadoTexto = empleado.estado || 'Sin definir';

        detallesContainer.innerHTML = `
            <div class="detail-group">
                <label class="detail-label">Nombre Completo</label>
                <div class="detail-value">${empleado.nombre || 'N/A'}</div>
            </div>
            <div class="detail-group">
                <label class="detail-label">Código de Empleado</label>
                <div class="detail-value">${empleado.codigo || 'N/A'}</div>
            </div>
            <div class="detail-group">
                <label class="detail-label">DNI</label>
                <div class="detail-value">${empleado.dni || 'N/A'}</div>
            </div>
            <div class="detail-group">
                <label class="detail-label">Sexo</label>
                <div class="detail-value">${empleado.sexo === 'M' ? 'Masculino' : empleado.sexo === 'F' ? 'Femenino' : 'N/A'}</div>
            </div>
            <div class="detail-group">
                <label class="detail-label">Teléfono</label>
                <div class="detail-value">${empleado.telefono || 'N/A'}</div>
            </div>
            <div class="detail-group">
                <label class="detail-label">Rol</label>
                <div class="detail-value">${empleado.rol || 'N/A'}</div>
            </div>
            <div class="detail-group">
                <label class="detail-label">Turno Asignado</label>
                <div class="detail-value">${empleado.turno || 'Sin turno'}</div>
            </div>
            <div class="detail-group">
                <label class="detail-label">Estado</label>
                <div class="detail-value">
                    <span class="estado-badge ${estadoClass}">${estadoTexto}</span>
                </div>
            </div>
        `;

        document.getElementById('modalDetalles').classList.add('show');
    }

    // Función para mostrar formulario de crear empleado
    function mostrarFormularioCrear() {
        // Limpiar formulario
        document.getElementById('formCrearEmpleado').reset();
        document.getElementById('modalCrear').classList.add('show');

        // Agregar event listeners para generar código automáticamente
        const rolSelect = document.getElementById('crear_rol');
        const telefonoInput = document.getElementById('crear_telefono');
        const codigoInput = document.getElementById('crear_codigo');

        function generarCodigo() {
            const rol = rolSelect.value;
            const dni = document.getElementById('crear_dni').value;

            if (rol && dni) {
                let prefijo = '';
                switch (rol) {
                    case '1': prefijo = 'RE'; break; // Recepcionista
                    case '2': prefijo = 'AD'; break; // Administrador
                    case '3': prefijo = 'LI'; break; // Limpieza
                }

                // Usar el DNI completo
                const codigo = prefijo + dni;

                codigoInput.value = codigo;
            } else {
                codigoInput.value = '';
            }
        }

        // Event listeners
        rolSelect.addEventListener('change', generarCodigo);
        document.getElementById('crear_dni').addEventListener('input', function (e) {
            // Solo permitir números
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
            generarCodigo();
        });

        // Validación para teléfono (solo números, debe empezar con 9)
        document.getElementById('crear_telefono').addEventListener('input', function (e) {
            let value = e.target.value.replace(/[^0-9]/g, '');

            // Si no empieza con 9, no permitir el ingreso
            if (value.length > 0 && !value.startsWith('9')) {
                value = '9';
            }

            e.target.value = value;

            // Validar en tiempo real
            if (value.length > 0 && value.length < 9) {
                e.target.setCustomValidity('El teléfono debe tener 9 dígitos');
            } else if (value.length === 9 && value.startsWith('9')) {
                e.target.setCustomValidity('');
            } else if (value.length === 9 && !value.startsWith('9')) {
                e.target.setCustomValidity('El teléfono debe empezar con 9');
            }
        });

        // Validación para nombres (solo letras)
        ['crear_nombres', 'crear_ape_paterno', 'crear_ape_materno'].forEach(fieldId => {
            const field = document.getElementById(fieldId);
            field.addEventListener('input', function (e) {
                e.target.value = e.target.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúÑñ\s]/g, '');
            });
        });
    }


    function cerrarModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
    }

    async function guardarEmpleado() {
        const form = document.getElementById('formCrearEmpleado');
        const formData = new FormData(form);

        // Validar campos requeridos (excluyendo codigo ya que se genera automáticamente)
        const camposRequeridos = ['nombres', 'ape_paterno', 'ape_materno', 'dni', 'telefono', 'sexo', 'rol'];
        let camposFaltantes = [];

        camposRequeridos.forEach(campo => {
            if (!formData.get(campo)) {
                camposFaltantes.push(campo);
            }
        });

        if (camposFaltantes.length > 0) {
            mostrarNotificacionBonita('error', 'Campos Faltantes', 'Por favor complete todos los campos requeridos');
            return;
        }

        try {
            // Enviar datos al servidor
            const response = await fetch('/Cruds/Empleados/crear', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                cerrarModal('modalCrear');
                cargarEmpleados();
                mostrarNotificacionBonita('success', 'Empleado Creado', 'El empleado ha sido creado exitosamente.');
            } else {
                mostrarNotificacionBonita('error', 'Error', result.message);
            }
        } catch (error) {
            console.error('Error al guardar empleado:', error);
            mostrarNotificacionBonita('error', 'Error', 'Error al guardar el empleado. Intente nuevamente.');
        }
    }

    // Función para mostrar modal de edición
    function mostrarModalEdicion(empleado) {
        empleadoEditando = empleado;

        // Llenar formulario con datos del empleado
        document.getElementById('editar_nombres').value = empleado.nombres || '';
        document.getElementById('editar_ape_paterno').value = empleado.ape_paterno || '';
        document.getElementById('editar_ape_materno').value = empleado.ape_materno || '';
        document.getElementById('editar_dni').value = empleado.dni || '';
        document.getElementById('editar_telefono').value = empleado.telefono || '';
        document.getElementById('editar_sexo').value = empleado.sexo || '';
        document.getElementById('editar_rol').value = empleado.rol_id || '';
        document.getElementById('editar_codigo').value = empleado.codigo || '';
        document.getElementById('editar_estado').value = empleado.estado || '';

        // Agregar event listeners para generar código automáticamente
        const rolSelect = document.getElementById('editar_rol');
        const dniInput = document.getElementById('editar_dni');
        const codigoInput = document.getElementById('editar_codigo');

        function generarCodigoEdicion() {
            const rol = rolSelect.value;
            const dni = dniInput.value;
            if (rol && dni) {
                let prefijo = '';
                switch (rol) {
                    case '1': prefijo = 'RE'; break; // Recepcionista
                    case '2': prefijo = 'AD'; break; // Administrador
                    case '3': prefijo = 'LI'; break; // Limpieza
                }
                // Usar el DNI completo
                const codigo = prefijo + dni;
                codigoInput.value = codigo;
            } else {
                codigoInput.value = '';
            }
        }

        // Event listeners
        rolSelect.addEventListener('change', generarCodigoEdicion);
        dniInput.addEventListener('input', function (e) {
            // Solo permitir números
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
            generarCodigoEdicion();
        });

        // Validación para teléfono (solo números)
        document.getElementById('editar_telefono').addEventListener('input', function (e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        // Validación para nombres (solo letras)
        ['editar_nombres', 'editar_ape_paterno', 'editar_ape_materno'].forEach(fieldId => {
            const field = document.getElementById(fieldId);
            field.addEventListener('input', function (e) {
                e.target.value = e.target.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúÑñ\s]/g, '');
            });
        });

        // Mostrar modal
        document.getElementById('modalEditar').classList.add('show');
    }

    async function actualizarEmpleado() {
        if (!empleadoEditando) return;

        const form = document.getElementById('formEditarEmpleado');
        const formData = new FormData(form);

        // Validar campos requeridos
        const camposRequeridos = ['nombres', 'ape_paterno', 'ape_materno', 'dni', 'telefono', 'sexo', 'rol', 'estado'];
        let camposFaltantes = [];

        camposRequeridos.forEach(campo => {
            if (!formData.get(campo)) {
                camposFaltantes.push(campo);
            }
        });

        if (camposFaltantes.length > 0) {
            mostrarNotificacionBonita('error', 'Campos Faltantes', 'Por favor complete todos los campos requeridos');
            return;
        }

        try {
            // Enviar datos al servidor
            const response = await fetch(`/Cruds/Empleados/actualizar/${empleadoEditando.id}`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                cerrarModal('modalEditar');
                cargarEmpleados();
                mostrarNotificacionBonita('success', 'Empleado Actualizado', 'Los datos del empleado han sido actualizados exitosamente.');
            } else {
                mostrarNotificacionBonita('error', 'Error', result.message);
            }
        } catch (error) {
            console.error('Error al actualizar empleado:', error);
            mostrarNotificacionBonita('error', 'Error', 'Error al actualizar el empleado. Intente nuevamente.');
        }
    }

    async function guardarTurno() {
        const form = document.getElementById('formAsignarTurno');
        const formData = new FormData(form);
        const empleado_id = formData.get('empleado_id');
        const turno = formData.get('turno');

        if (!empleado_id || !turno) {
            mostrarNotificacionBonita('error', 'Campos Faltantes', 'Complete todos los campos requeridos');
            return;
        }

        try {
            const response = await fetch('/Cruds/Empleados/asignar-turno', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                cerrarModal('modalAsignarTurno');
                cargarEmpleados();
                mostrarNotificacionBonita('success', 'Turno Asignado', 'El turno ha sido asignado exitosamente al empleado.');
            } else {
                mostrarNotificacionBonita('error', 'Error', result.message);
            }
        } catch (error) {
            console.error('Error al asignar turno:', error);
            mostrarNotificacionBonita('error', 'Error', 'Error al asignar turno');
        }
    }

    async function cargarTurnosParaAsignar() {
        try {
            const response = await fetch('/Cruds/Empleados/turnos');
            const result = await response.json();
            const selectTurno = document.getElementById('asignar_turno');
            selectTurno.innerHTML = '<option value="">Seleccione turno</option>';

            if (result.success && result.turnos) {
                result.turnos.forEach(turno => {
                    const option = document.createElement('option');
                    option.value = turno.id;
                    option.textContent = turno.nombre;
                    selectTurno.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error al cargar turnos:', error);
            mostrarNotificacionBonita('error', 'Error', 'No se pudieron cargar los turnos.');
        }
    }

    async function cargarTurnoActual(empleado_id) {
        try {
            const response = await fetch(`/Cruds/Empleados/turno-actual/${empleado_id}`);
            const result = await response.json();
            const selectTurno = document.getElementById('asignar_turno');

            if (result.success && result.turno) {
                // Seleccionar el turno actual
                selectTurno.value = result.turno.id;
            }
        } catch (error) {
            console.error('Error al cargar turno actual:', error);
        }
    }

    // Funciones para notificaciones bonitas
    function mostrarNotificacionBonita(tipo, titulo, mensaje) {
        const toast = document.getElementById('notification-toast');
        const icon = toast.querySelector('.notification-toast-icon i');
        const title = toast.querySelector('.notification-toast-title');
        const message = toast.querySelector('.notification-toast-message');

        // Configurar contenido
        title.textContent = titulo;
        message.textContent = mensaje;

        // Configurar tipo
        toast.className = `notification-toast ${tipo}`;
        if (tipo === 'success') {
            icon.className = 'fas fa-check';
        } else {
            icon.className = 'fas fa-times';
        }

        // Mostrar notificación
        toast.style.display = 'block';
        toast.classList.add('show');

        // Auto-cerrar después de 4 segundos
        setTimeout(() => {
            cerrarNotificacionToast();
        }, 4000);
    }

    function cerrarNotificacionToast() {
        const toast = document.getElementById('notification-toast');
        toast.classList.remove('show');
        setTimeout(() => {
            toast.style.display = 'none';
        }, 300);
    }

    function mostrarModalConfirmacion(titulo, mensaje, descripcion, callback) {
        const modal = document.getElementById('modal-confirm');
        const title = modal.querySelector('.modal-confirm-title');
        const message = modal.querySelector('.modal-confirm-message');

        title.textContent = titulo;
        message.innerHTML = mensaje + '<br><small>' + descripcion + '</small>';

        confirmCallback = callback;
        modal.style.display = 'flex';
        modal.classList.add('show');
    }

    function confirmarAccion() {
        if (confirmCallback) {
            confirmCallback();
        }
        cerrarModalConfirmacion();
    }

    function cancelarAccion() {
        cerrarModalConfirmacion();
    }

    function cerrarModalConfirmacion() {
        const modal = document.getElementById('modal-confirm');
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
        confirmCallback = null;
    }

    // Cerrar modales al hacer clic fuera de ellos
    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('modal')) {
            e.target.classList.remove('show');
        }
        if (e.target.classList.contains('modal-confirm')) {
            cerrarModalConfirmacion();
        }
    });

    // ============================================
    // FUNCIONES PARA GESTIONAR INCIDENCIAS
    // ============================================

    let tiposIncidencia = [];
    let incidenciaActual = null;
    let todasLasIncidencias = [];
    let esAdministrador = false; // Variable para detectar si es administrador

    // Cargar tipos de incidencia al inicio
    async function cargarTiposIncidencia() {
        try {
            const response = await fetch('/incidentes/tipos');
            const data = await response.json();

            if (data.success) {
                tiposIncidencia = data.tipos;
                const select = document.getElementById('incidencia-tipo');
                select.innerHTML = '<option value="">Seleccione...</option>';

                tiposIncidencia.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.id_tipo;
                    option.textContent = tipo.nombre;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error al cargar tipos de incidencia:', error);
        }
    }

    // Cargar incidencias del cliente o todas si es administrador
    async function cargarIncidencias() {
        try {
            // Detectar si es administrador (rol_id = 1)
            const rolId = parseInt('{{ session.get("rol_id", 0) }}');
            esAdministrador = (rolId === 1);

            console.log('🔍 Debug cargarIncidencias:');
            console.log('- rolId:', rolId);
            console.log('- esAdministrador:', esAdministrador);

            let url = '/incidentes/mis-incidencias';
            if (esAdministrador) {
                url = '/incidentes/todas'; // Endpoint para todas las incidencias
                console.log('✅ Usuario es administrador, cargando todas las incidencias');
            } else {
                console.log('👤 Usuario normal, cargando solo sus incidencias');
            }

            console.log('- URL a consultar:', url);

            const response = await fetch(url);
            const data = await response.json();

            console.log('- Respuesta del servidor:', data);

            if (data.success) {
                todasLasIncidencias = data.incidencias;
                mostrarTablaIncidencias(data.incidencias);

                // Actualizar título si es administrador
                if (esAdministrador) {
                    const titulo = document.querySelector('#panel-incidencias h2');
                    if (titulo) {
                        titulo.textContent = 'Todas las Incidencias';
                    }
                }
            } else {
                mostrarErrorTabla(data.message || 'Error al cargar incidencias');
            }
        } catch (error) {
            console.error('Error al cargar incidencias:', error);
            mostrarErrorTabla('Error al cargar las incidencias');
        }
    }

    // Mostrar tabla de incidencias
    function mostrarTablaIncidencias(incidencias) {
        const tbody = document.getElementById('tabla-incidencias');

        if (incidencias.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="padding: 40px; text-align: center; color: #999;">
                        <i class="fas fa-inbox" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
                        <h4 style="color: #666; margin-bottom: 10px;">No hay incidencias registradas</h4>
                        <p>Haz clic en "Crear Incidencia" para reportar un problema</p>
                    </td>
                </tr>
            `;
            return;
        }

        let html = '';
        incidencias.forEach(inc => {
            // Determinar color del estado
            let estadoColor = '#ffc107';
            let estadoIcon = 'fa-clock';
            let estadoTexto = 'En proceso';

            if (inc.estado === 1) {
                estadoColor = '#28a745';
                estadoIcon = 'fa-check-circle';
                estadoTexto = 'Aprobado';
            } else if (inc.estado === 2) {
                estadoColor = '#dc3545';
                estadoIcon = 'fa-times-circle';
                estadoTexto = 'Rechazado';
            }

            html += `
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 15px;">${inc.fecha_envio}</td>
                    <td style="padding: 15px;">${inc.fecha_resolucion || '-'}</td>
                    <td style="padding: 15px; font-weight: 600;">${inc.titulo}</td>
                    <td style="padding: 15px;">
                        <span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${estadoColor}20; color: ${estadoColor};">
                            <i class="fas ${estadoIcon}"></i> ${estadoTexto}
                        </span>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <button onclick="verIncidencia(${inc.incidencia_id})" style="background: #17a2b8; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; margin-right: 5px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center;" title="Ver incidencia">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="console.log('🔧 Botón editar clickeado para ID:', ${inc.incidencia_id}); console.log('🔍 Función editarIncidencia existe:', typeof editarIncidencia); if (typeof editarIncidencia === 'function') { editarIncidencia(${inc.incidencia_id}); } else { console.error('❌ Función editarIncidencia no encontrada'); }" style="background: #ffc107; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center;" title="Editar incidencia">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    }

    // Mostrar error en tabla
    function mostrarErrorTabla(mensaje) {
        const tbody = document.getElementById('tabla-incidencias');
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="padding: 40px; text-align: center; color: #dc3545;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 32px;"></i>
                    <p style="margin-top: 15px;">${mensaje}</p>
                </td>
            </tr>
        `;
    }

    // Buscar incidencias
    function buscarIncidencias() {
        const termino = document.getElementById('buscar-incidencias').value.toLowerCase();
        const incidenciasFiltradas = todasLasIncidencias.filter(inc =>
            inc.titulo.toLowerCase().includes(termino) ||
            inc.descripcion.toLowerCase().includes(termino) ||
            inc.tipo_incidencia.toLowerCase().includes(termino)
        );
        mostrarTablaIncidencias(incidenciasFiltradas);
    }

    // Mostrar lista de incidencias
    function mostrarListaIncidencias(incidencias) {
        const contenedor = document.getElementById('contenedor-incidencias');

        let html = '<div style="display: grid; gap: 20px;">';

        incidencias.forEach(inc => {
            // Determinar color según estado
            let estadoColor = '#ffc107'; // En proceso (amarillo)
            let estadoIcon = 'fa-clock';

            if (inc.estado === 1) {
                estadoColor = '#28a745'; // Aprobado (verde)
                estadoIcon = 'fa-check-circle';
            } else if (inc.estado === 2) {
                estadoColor = '#dc3545'; // Rechazado (rojo)
                estadoIcon = 'fa-times-circle';
            }

            html += `
                <div style="background: white; border: 2px solid #e0e0e0; border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s; cursor: pointer;" onclick="verDetalleIncidencia(${inc.incidencia_id})">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 10px 0; color: #333; font-size: 18px;">
                                <i class="fas fa-file-alt" style="color: #328336;"></i> 
                                ${inc.titulo}
                            </h4>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; font-size: 13px; color: #666;">
                                <span><i class="fas fa-tag"></i> ${inc.tipo_incidencia}</span>
                                <span><i class="fas fa-calendar"></i> ${inc.fecha_envio}</span>
                                ${inc.numero_comprobante ? `<span><i class="fas fa-receipt"></i> ${inc.numero_comprobante}</span>` : ''}
                            </div>
                        </div>
                        <div style="padding: 8px 16px; background: ${estadoColor}; color: white; border-radius: 20px; font-weight: 600; font-size: 13px; white-space: nowrap;">
                            <i class="fas ${estadoIcon}"></i> ${inc.estado_texto}
                        </div>
                    </div>
                    
                    <p style="margin: 0; color: #666; line-height: 1.6;">${inc.descripcion.substring(0, 150)}${inc.descripcion.length > 150 ? '...' : ''}</p>
                    
                    ${inc.respuesta ? `
                        <div style="margin-top: 15px; padding: 15px; background: #e8f5e9; border-left: 4px solid #28a745; border-radius: 5px;">
                            <strong style="color: #155724; display: block; margin-bottom: 5px;">
                                <i class="fas fa-reply"></i> Respuesta del hotel:
                            </strong>
                            <p style="margin: 0; color: #155724;">${inc.respuesta}</p>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="event.stopPropagation(); editarIncidencia(${inc.incidencia_id})" class="btn-secondary" style="padding: 8px 16px; background: #ffc107; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 13px;">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button onclick="event.stopPropagation(); eliminarIncidenciaConfirm(${inc.incidencia_id})" class="btn-secondary" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 13px;">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        contenedor.innerHTML = html;
    }

    // Mostrar formulario para nueva incidencia
    function mostrarFormularioIncidencia() {
        // Ocultar panel principal
        document.getElementById('panel-incidencias').style.display = 'none';

        // Mostrar formulario
        document.getElementById('formulario-incidencia').style.display = 'block';

        // Configurar para nueva incidencia
        incidenciaActual = null;
        document.getElementById('form-titulo').textContent = 'Nueva Incidencia';
        document.getElementById('form-nueva-incidencia').reset();
        document.getElementById('incidencia_id_edit').value = '';

        // Configurar estado por defecto
        actualizarEstadoVisual(3);

        // Limpiar respuesta
        const respuesta = document.getElementById('incidencia-respuesta');
        if (respuesta) {
            respuesta.value = '';
            respuesta.placeholder = 'Aún no hay respuesta del hotel...';
        }

        // Cargar tipos de incidencia
        cargarTiposIncidencia();
    }

    // Ver incidencia (solo lectura)
    async function verIncidencia(incidenciaId) {
        try {
            const response = await fetch(`/incidentes/obtener/${incidenciaId}`);
            const data = await response.json();

            if (data.success) {
                const inc = data.incidencia;

                // Ocultar panel principal
                document.getElementById('panel-incidencias').style.display = 'none';

                // Mostrar formulario
                document.getElementById('formulario-incidencia').style.display = 'block';

                // Configurar para ver
                incidenciaActual = inc;
                document.getElementById('form-titulo').textContent = 'Ver Incidencia';

                // Llenar campos (solo lectura)
                document.getElementById('incidencia-titulo').value = inc.titulo;
                document.getElementById('incidencia-descripcion').value = inc.descripcion;
                document.getElementById('incidencia-tipo').value = inc.tipo_incidencia_id;
                document.getElementById('incidencia-comprobante').value = inc.numero_comprobante || '';
                document.getElementById('incidencia-respuesta').value = inc.respuesta || '';

                // Hacer campos de solo lectura
                document.getElementById('incidencia-titulo').readOnly = true;
                document.getElementById('incidencia-descripcion').readOnly = true;
                document.getElementById('incidencia-tipo').disabled = true;
                document.getElementById('incidencia-comprobante').readOnly = true;
                document.getElementById('incidencia-evidencia').disabled = true;

                // Mostrar estado actual
                actualizarEstadoVisual(inc.estado);

                // Ocultar botón guardar
                document.getElementById('btn-guardar-incidencia').style.display = 'none';

            } else {
                mostrarAlertaIncidencia('Error al cargar la incidencia', 'error');
            }
        } catch (error) {
            console.error('Error al cargar incidencia:', error);
            mostrarAlertaIncidencia('Error al cargar la incidencia', 'error');
        }
    }

    // Editar incidencia
    async function editarIncidencia(incidenciaId) {
        console.log('🚀 Iniciando edición de incidencia ID:', incidenciaId);

        try {
            // Obtener datos de la incidencia
            const response = await fetch(`/incidentes/obtener/${incidenciaId}`);
            const data = await response.json();

            if (!data.success) {
                mostrarAlertaIncidencia('Error al cargar la incidencia', 'error');
                return;
            }

            const inc = data.incidencia;
            console.log('✅ Incidencia cargada:', inc);

            // Detectar si es administrador
            const rolId = parseInt('{{ session.get("rol_id", 0) }}');
            const esAdmin = (rolId === 1);
            console.log('🔍 Rol detectado:', rolId, '- Es admin:', esAdmin);

            // Ocultar panel de lista y mostrar formulario
            document.getElementById('panel-incidencias').style.display = 'none';
            document.getElementById('formulario-incidencia').style.display = 'block';

            // Configurar título y ID
            document.getElementById('form-titulo').textContent = 'Editar Incidencia';
            document.getElementById('incidencia_id_edit').value = inc.incidencia_id;
            incidenciaActual = inc;

            // Llenar campos básicos
            document.getElementById('incidencia-titulo').value = inc.titulo;
            document.getElementById('incidencia-descripcion').value = inc.descripcion;
            document.getElementById('incidencia-tipo').value = inc.tipo_incidencia_id;
            document.getElementById('incidencia-comprobante').value = inc.numero_comprobante || '';

            // Cargar tipos de incidencia
            await cargarTiposIncidencia();

            // Configurar sección de evaluación solo para administradores
            const seccionEvaluacion = document.getElementById('seccion-evaluacion');

            if (esAdmin) {
                console.log('✅ Mostrando controles de administrador');

                // Mostrar sección de evaluación
                if (seccionEvaluacion) {
                    seccionEvaluacion.style.display = 'block';
                }

                // Configurar estado actual
                const estadoActual = inc.estado || 3;
                console.log('📊 Estado actual:', estadoActual);

                // Marcar el radio button correspondiente
                const radioEstado = document.querySelector(`input[name="estado_incidencia"][value="${estadoActual}"]`);
                if (radioEstado) {
                    radioEstado.checked = true;
                    console.log('✅ Radio button marcado para estado:', estadoActual);
                }

                // Llenar respuesta del hotel
                const campoRespuesta = document.getElementById('incidencia-respuesta');
                if (campoRespuesta) {
                    campoRespuesta.value = inc.respuesta || '';
                    campoRespuesta.readOnly = false;
                    console.log('✅ Campo de respuesta configurado');
                }

                // Hacer campos básicos editables
                document.getElementById('incidencia-titulo').readOnly = false;
                document.getElementById('incidencia-descripcion').readOnly = false;
                document.getElementById('incidencia-tipo').disabled = false;
                document.getElementById('incidencia-comprobante').readOnly = false;
                document.getElementById('incidencia-evidencia').disabled = false;

            } else {
                console.log('👤 Usuario normal - modo solo lectura');

                // Ocultar sección de evaluación para usuarios normales
                if (seccionEvaluacion) {
                    seccionEvaluacion.style.display = 'none';
                }

                // Hacer campos de solo lectura
                document.getElementById('incidencia-titulo').readOnly = true;
                document.getElementById('incidencia-descripcion').readOnly = true;
                document.getElementById('incidencia-tipo').disabled = true;
                document.getElementById('incidencia-comprobante').readOnly = true;
                document.getElementById('incidencia-evidencia').disabled = true;
            }

            // Mostrar botón guardar
            document.getElementById('btn-guardar-incidencia').style.display = 'inline-block';

            console.log('✅ Formulario de edición configurado correctamente');

        } catch (error) {
            console.error('❌ Error al cargar incidencia:', error);
            mostrarAlertaIncidencia('Error al cargar la incidencia: ' + error.message, 'error');
        }
    }

    // Volver a la lista
    function volverALista() {
        document.getElementById('formulario-incidencia').style.display = 'none';
        document.getElementById('panel-incidencias').style.display = 'block';

        // Limpiar formulario
        document.getElementById('form-nueva-incidencia').reset();
        incidenciaActual = null;
    }

    // Cancelar formulario
    function cancelarFormularioIncidencia() {
        document.getElementById('formulario-incidencia').style.display = 'none';
        document.getElementById('form-nueva-incidencia').reset();
        incidenciaActual = null;
    }

    // Función de debug
    function debugFormulario() {
        console.log('🔍 === DEBUG FORMULARIO ===');

        const formulario = document.getElementById('formulario-incidencia');
        console.log('Formulario:', formulario);
        console.log('Display actual:', formulario ? formulario.style.display : 'NO ENCONTRADO');

        if (formulario) {
            formulario.style.setProperty('display', 'block', 'important');
            formulario.style.border = '3px solid red';
            console.log('✅ Formulario forzado a mostrar con borde rojo');
        } else {
            console.error('❌ Formulario no encontrado');
        }

        // Verificar otros elementos
        console.log('Título:', document.getElementById('form-titulo'));
        console.log('Form:', document.getElementById('form-nueva-incidencia'));
        console.log('ID Edit:', document.getElementById('incidencia_id_edit'));
    }

    // Función para mostrar controles de estado para administradores
    function mostrarControlesEstadoAdmin(estadoActual, respuestaActual = '') {
        console.log('🔧 mostrarControlesEstadoAdmin llamada:');
        console.log('- estadoActual:', estadoActual);
        console.log('- respuestaActual:', respuestaActual);

        const seccionEvaluacion = document.getElementById('seccion-evaluacion');
        console.log('- seccionEvaluacion encontrada:', !!seccionEvaluacion);
        console.log('- seccionEvaluacion elemento:', seccionEvaluacion);

        if (seccionEvaluacion) {
            // Mostrar la sección de evaluación
            seccionEvaluacion.style.display = 'block';

            // Crear controles de estado para administrador
            const controlesHTML = `
                <h4 style="color: #328336; margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid #328336; padding-bottom: 10px;">
                    <i class="fas fa-cogs"></i> Evaluación (Administrador)
                </h4>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #328336;">
                        <i class="fas fa-cogs"></i> Estado de la Incidencia
                    </label>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.3s;">
                            <input type="radio" name="estado_incidencia" value="3" ${estadoActual == 3 ? 'checked' : ''} style="margin: 0;">
                            <span style="color: #ffc107; font-weight: 600;">
                                <i class="fas fa-clock"></i> En Proceso
                            </span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.3s;">
                            <input type="radio" name="estado_incidencia" value="1" ${estadoActual == 1 ? 'checked' : ''} style="margin: 0;">
                            <span style="color: #28a745; font-weight: 600;">
                                <i class="fas fa-check-circle"></i> Aprobado
                            </span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.3s;">
                            <input type="radio" name="estado_incidencia" value="2" ${estadoActual == 2 ? 'checked' : ''} style="margin: 0;">
                            <span style="color: #dc3545; font-weight: 600;">
                                <i class="fas fa-times-circle"></i> Rechazado
                            </span>
                        </label>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label for="incidencia-respuesta-admin" style="display: block; margin-bottom: 10px; font-weight: 600; color: #328336;">
                        <i class="fas fa-reply"></i> Respuesta del Hotel
                    </label>
                    <textarea id="incidencia-respuesta-admin" name="respuesta" class="form-control" rows="4" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical;" placeholder="Escriba la respuesta del hotel...">${respuestaActual || ''}</textarea>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        <i class="fas fa-info-circle"></i> Esta respuesta será visible para el cliente
                    </small>
                </div>
            `;

            // Reemplazar el contenido de la sección de evaluación
            seccionEvaluacion.innerHTML = controlesHTML;
            console.log('✅ Controles de estado creados y mostrados');
            console.log('🔍 HTML aplicado:', seccionEvaluacion.innerHTML.substring(0, 200) + '...');

            // Agregar estilos dinámicos a los radio buttons
            const radioButtons = seccionEvaluacion.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function () {
                    // Actualizar estilos visuales
                    radioButtons.forEach(rb => {
                        const label = rb.closest('label');
                        if (rb.checked) {
                            if (rb.value == '1') {
                                label.style.borderColor = '#28a745';
                                label.style.backgroundColor = '#d4edda';
                            } else if (rb.value == '2') {
                                label.style.borderColor = '#dc3545';
                                label.style.backgroundColor = '#f8d7da';
                            } else {
                                label.style.borderColor = '#ffc107';
                                label.style.backgroundColor = '#fff3cd';
                            }
                        } else {
                            label.style.borderColor = '#e0e0e0';
                            label.style.backgroundColor = 'transparent';
                        }
                    });
                });

                // Aplicar estilos iniciales
                if (radio.checked) {
                    const label = radio.closest('label');
                    if (radio.value == '1') {
                        label.style.borderColor = '#28a745';
                        label.style.backgroundColor = '#d4edda';
                    } else if (radio.value == '2') {
                        label.style.borderColor = '#dc3545';
                        label.style.backgroundColor = '#f8d7da';
                    } else {
                        label.style.borderColor = '#ffc107';
                        label.style.backgroundColor = '#fff3cd';
                    }
                }
            });
        }
    }

    // Función para actualizar el estado visual (solo lectura)
    function actualizarEstadoVisual(estado) {
        const seccionEvaluacion = document.getElementById('seccion-evaluacion');
        if (seccionEvaluacion) {
            // Mostrar la sección de evaluación
            seccionEvaluacion.style.display = 'block';

            // Crear contenido de solo lectura
            const contenidoHTML = `
                <h4 style="color: #328336; margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid #328336; padding-bottom: 10px;">
                    <i class="fas fa-info-circle"></i> Evaluación
                </h4>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>Estado Actual</label>
                    <div id="estado-actual" style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e0e0e0; text-align: center; font-weight: 600; font-size: 16px;">
                        ${estado === 1 ? '<i class="fas fa-check-circle"></i> Aprobado' :
                    estado === 2 ? '<i class="fas fa-times-circle"></i> Rechazado' :
                        '<i class="fas fa-clock"></i> En proceso'}
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="incidencia-respuesta">Respuesta del Hotel</label>
                    <textarea id="incidencia-respuesta" name="respuesta" class="form-control" rows="4" readonly style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; resize: vertical; background: #f8f9fa;" placeholder="Aún no hay respuesta del hotel..."></textarea>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        <i class="fas fa-info-circle"></i> Esta respuesta será proporcionada por el personal del hotel
                    </small>
                </div>
            `;

            seccionEvaluacion.innerHTML = contenidoHTML;

            // Aplicar estilos al estado
            const estadoActual = document.getElementById('estado-actual');
            if (estadoActual) {
                let estadoColor = '';
                let backgroundColor = '';

                if (estado === 1) {
                    estadoColor = '#28a745';
                    backgroundColor = '#d4edda';
                } else if (estado === 2) {
                    estadoColor = '#dc3545';
                    backgroundColor = '#f8d7da';
                } else {
                    estadoColor = '#ffc107';
                    backgroundColor = '#fff3cd';
                }

                estadoActual.style.color = estadoColor;
                estadoActual.style.borderColor = estadoColor;
                estadoActual.style.backgroundColor = backgroundColor;
            }
        }
    }

    // Ver detalle de incidencia
    async function verDetalleIncidencia(incidenciaId) {
        try {
            const response = await fetch(`/incidentes/obtener/${incidenciaId}`);
            const data = await response.json();

            if (data.success) {
                const inc = data.incidencia;

                // Mostrar modal o expandir detalle
                let detalleHTML = `
                    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 800px; margin: 20px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
                            <h3 style="margin: 0; color: #328336;">
                                <i class="fas fa-file-alt"></i> Detalle de Incidencia
                            </h3>
                            <button onclick="cerrarDetalleIncidencia()" style="background: none; border: none; font-size: 24px; color: #999; cursor: pointer;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div style="display: grid; gap: 20px;">
                            <div>
                                <strong style="color: #328336; display: block; margin-bottom: 5px;">Título:</strong>
                                <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">${inc.titulo}</p>
                            </div>
                            
                            <div>
                                <strong style="color: #328336; display: block; margin-bottom: 5px;">Descripción:</strong>
                                <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 5px; line-height: 1.6;">${inc.descripcion}</p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                <div>
                                    <strong style="color: #328336; display: block; margin-bottom: 5px;">Tipo:</strong>
                                    <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">${inc.tipo_incidencia}</p>
                                </div>
                                <div>
                                    <strong style="color: #328336; display: block; margin-bottom: 5px;">Estado:</strong>
                                    <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">${inc.estado_texto}</p>
                                </div>
                            </div>
                            
                            ${inc.numero_comprobante ? `
                                <div>
                                    <strong style="color: #328336; display: block; margin-bottom: 5px;">Comprobante:</strong>
                                    <p style="margin: 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">${inc.numero_comprobante}</p>
                                </div>
                            ` : ''}
                            
                            ${inc.imagen ? `
                                <div>
                                    <strong style="color: #328336; display: block; margin-bottom: 5px;">Evidencia:</strong>
                                    <img src="data:image/jpeg;base64,${inc.imagen}" style="max-width: 100%; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                </div>
                            ` : ''}
                            
                            ${inc.respuesta ? `
                                <div style="padding: 20px; background: #e8f5e9; border-left: 4px solid #28a745; border-radius: 10px;">
                                    <strong style="color: #155724; display: block; margin-bottom: 10px; font-size: 16px;">
                                        <i class="fas fa-reply"></i> Respuesta del hotel:
                                    </strong>
                                    <p style="margin: 0; color: #155724; line-height: 1.6;">${inc.respuesta}</p>
                                </div>
                            ` : ''}
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                                <button onclick="cerrarDetalleIncidencia()" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // Crear overlay y mostrar detalle
                const overlay = document.createElement('div');
                overlay.id = 'detalle-overlay';
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; padding: 20px;';
                overlay.innerHTML = detalleHTML;
                overlay.onclick = function (e) {
                    if (e.target === overlay) {
                        cerrarDetalleIncidencia();
                    }
                };
                document.body.appendChild(overlay);
            }
        } catch (error) {
            console.error('Error al cargar detalle:', error);
            mostrarAlertaIncidencia('Error al cargar el detalle de la incidencia', 'error');
        }
    }

    function cerrarDetalleIncidencia() {
        const overlay = document.getElementById('detalle-overlay');
        if (overlay) {
            overlay.remove();
        }
    }

    // Función editarIncidencia duplicada eliminada - usar la versión principal

    // Eliminar incidencia con confirmación
    function eliminarIncidenciaConfirm(incidenciaId) {
        if (confirm('¿Está seguro de eliminar esta incidencia? Esta acción no se puede deshacer.')) {
            eliminarIncidencia(incidenciaId);
        }
    }

    // Eliminar incidencia
    async function eliminarIncidencia(incidenciaId) {
        try {
            const response = await fetch(`/incidentes/eliminar/${incidenciaId}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                mostrarAlertaIncidencia('Incidencia eliminada exitosamente', 'success');
                cargarIncidencias();
            } else {
                mostrarAlertaIncidencia(data.message || 'Error al eliminar incidencia', 'error');
            }
        } catch (error) {
            console.error('Error al eliminar incidencia:', error);
            mostrarAlertaIncidencia('Error al eliminar la incidencia', 'error');
        }
    }

    // Guardar incidencia (crear o actualizar)
    document.getElementById('form-nueva-incidencia').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const incidenciaId = document.getElementById('incidencia_id_edit').value;
        const btnGuardar = document.getElementById('btn-guardar-incidencia');

        // Detectar si es administrador
        const rolId = parseInt('{{ session.get("rol_id", 0) }}');
        const esAdmin = (rolId === 1);

        console.log('💾 Preparando guardado - Es admin:', esAdmin, '- ID incidencia:', incidenciaId);

        // Para nuevas incidencias, no enviar campos de estado y respuesta
        if (!incidenciaId) {
            console.log('📝 Nueva incidencia - sin estado ni respuesta');
            formData.delete('estado');
            formData.delete('respuesta');
        } else {
            // Para incidencias existentes, si es administrador, incluir estado y respuesta
            if (esAdmin) {
                console.log('🔧 Guardando como administrador');

                // Obtener el estado seleccionado
                const estadoSeleccionado = document.querySelector('input[name="estado_incidencia"]:checked');
                if (estadoSeleccionado) {
                    formData.set('estado', estadoSeleccionado.value);
                    console.log('📊 Estado a guardar:', estadoSeleccionado.value);
                }

                // Obtener la respuesta del hotel
                const campoRespuesta = document.getElementById('incidencia-respuesta');
                if (campoRespuesta) {
                    formData.set('respuesta', campoRespuesta.value);
                    console.log('💬 Respuesta a guardar:', campoRespuesta.value.substring(0, 50) + '...');
                }
            } else {
                console.log('👤 Usuario normal - sin estado ni respuesta');
                formData.delete('estado');
                formData.delete('respuesta');
            }
        }

        btnGuardar.disabled = true;
        btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

        try {
            let url = '/incidentes/crear';
            let method = 'POST';

            if (incidenciaId) {
                url = `/incidentes/actualizar/${incidenciaId}`;
                method = 'POST';
            }

            const response = await fetch(url, {
                method: method,
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                mostrarAlertaIncidencia(data.message || 'Incidencia guardada exitosamente', 'success');
                volverALista();
                cargarIncidencias();
            } else {
                mostrarAlertaIncidencia(data.message || 'Error al guardar la incidencia', 'error');
            }
        } catch (error) {
            console.error('Error al guardar incidencia:', error);
            mostrarAlertaIncidencia('Error al guardar la incidencia', 'error');
        } finally {
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = '<i class="fas fa-save"></i> Guardar';
        }
    });

    // Mostrar alertas de incidencias
    function mostrarAlertaIncidencia(mensaje, tipo) {
        const alertSuccess = document.getElementById('alert-incidencia-success');
        const alertError = document.getElementById('alert-incidencia-error');
        const successMsg = document.getElementById('incidencia-success-message');
        const errorMsg = document.getElementById('incidencia-error-message');

        // Ocultar todas las alertas
        alertSuccess.style.display = 'none';
        alertError.style.display = 'none';

        if (tipo === 'success') {
            successMsg.textContent = mensaje;
            alertSuccess.style.display = 'block';
            setTimeout(() => {
                alertSuccess.style.display = 'none';
            }, 5000);
        } else {
            errorMsg.textContent = mensaje;
            alertError.style.display = 'block';
            setTimeout(() => {
                alertError.style.display = 'none';
            }, 5000);
        }

        // Scroll a la alerta
        document.getElementById('incidencias').scrollIntoView({ behavior: 'smooth' });
    }

    // Inicializar incidencias cuando se abre la sección
    const menuIncidencias = document.querySelector('[data-section="incidencias"]');
    if (menuIncidencias) {
        menuIncidencias.addEventListener('click', function () {
            setTimeout(() => {
                cargarIncidencias();
            }, 100);
        });
    }

    // Agregar búsqueda en tiempo real
    document.addEventListener('DOMContentLoaded', function () {
        console.log('🚀 Script de incidencias cargado correctamente');
        const buscarInput = document.getElementById('buscar-incidencias');
        if (buscarInput) {
            buscarInput.addEventListener('input', function () {
                buscarIncidencias();
            });
        }
    });

    // Agregar event listener alternativo para el botón de nueva incidencia
    document.addEventListener('DOMContentLoaded', function () {
        const btnNuevaIncidencia = document.querySelector('button[onclick="mostrarFormularioIncidencia()"]');
        if (btnNuevaIncidencia) {
            btnNuevaIncidencia.addEventListener('click', function (e) {
                e.preventDefault();
                console.log('Botón de nueva incidencia clickeado');
                mostrarFormularioIncidencia();
            });
        } else {
            console.error('No se encontró el botón de nueva incidencia');
        }
    });

    // ### INICIO DE CÓDIGO NUEVO: Lógica para Promociones ###
    // Cargar los tipos de promoción para el combo del formulario
    async function cargarTiposPromocion() {
        const select = document.getElementById('promo-tipo');
        if (!select) return; // Salir si no se encuentra el combo

        try {
            const response = await fetch('/promociones/tipos');
            const data = await response.json();
            if (data.success) {
                select.innerHTML = '<option value="" disabled selected>Seleccione un tipo...</option>';
                data.tipos.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.id_tipo_promocion;
                    option.textContent = tipo.nombre;
                    select.appendChild(option);
             });
            } else {
                 select.innerHTML = '<option value="">Error al cargar</option>';
            }
        } catch (e) {
            console.error("Error cargando tipos de promo:", e);
            select.innerHTML = '<option value="">Error de red</option>';
        }
    }

    // Cargar la lista de promociones existentes (VERSIÓN CORREGIDA)
    async function cargarPromociones() {
        const tbody = document.getElementById('tabla-promociones-body');
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Cargando...</td></tr>';

        try {
            const response = await fetch('/promociones/todas');
            const data = await response.json();

            if (data.success && data.promociones.length > 0) {
                tbody.innerHTML = ''; // Limpiar el "Cargando..."
                
                data.promociones.forEach(promo => {
                    const tr = document.createElement('tr'); // 1. Crear la fila

                    // --- SOLUCIÓN: Crear celda por celda (método seguro) ---

                    // Celda ID
                    const tdId = document.createElement('td');
                    tdId.textContent = promo.id_promocion;
                    tr.appendChild(tdId);

                    // Celda Descripción
                    const tdDesc = document.createElement('td');
                    tdDesc.textContent = promo.descripcion;
                    tr.appendChild(tdDesc);

                    // Celda Descuento
                    const tdPorcentaje = document.createElement('td');
                    tdPorcentaje.textContent = `${promo.porcentaje}%`;
                    tr.appendChild(tdPorcentaje);

                    // Celda Vigencia
                    const tdVigencia = document.createElement('td');
                    /* NOTA: Tus fechas vienen mal desde el backend (muestran "%d/%m/%Y").
                       El JS las mostrará, pero idealmente deberías arreglar 
                       el formato de fecha en tu código de Python/Flask antes de enviarlo.
                    */
                    tdVigencia.textContent = `${promo.fecha_inicio} al ${promo.fecha_fin}`;
                    tr.appendChild(tdVigencia);

                    // Celda Estado
                    const tdEstado = document.createElement('td');
                    const estadoClass = promo.estado == 1 ? 'estado-Activa' : 'estado-Inactiva';
                    // Usamos innerHTML aquí solo para el <span>, lo cual es seguro.
                    tdEstado.innerHTML = `<span class="${estadoClass}">${promo.nombre_estado}</span>`; 
                    tr.appendChild(tdEstado);

                    // Celda Acción (esta sí puede usar innerHTML por la complejidad del form)
                    const tdAccion = document.createElement('td');
                    tdAccion.innerHTML = `
                        <form id="form-estado-promo-${promo.id_promocion}" onsubmit="event.preventDefault(); cambiarEstadoPromocion(${promo.id_promocion});" style="display:inline-block;">
                            <input type="hidden" name="estado" value="${promo.estado == 1 ? '0' : '1'}">
                            <button type="submit" class="btn-modal ${promo.estado == 1 ? 'btn-modal-secondary' : 'btn-modal-primary'}" style="padding: 5px 10px; font-size: 12px;">
                                ${promo.estado == 1 ? 'Desactivar' : 'Activar'}
                            </button>
                        </form>
                    `;
                    tr.appendChild(tdAccion);

                    // --- Fin del método seguro ---

                    tbody.appendChild(tr); // 2. Añadir la fila completada a la tabla
                });

            } else if (data.success) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No hay promociones creadas.</td></tr>';
            } else {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px; color: red;">${data.message}</td></tr>`;
            }
        } catch (e) {
            console.error("Error cargando promociones:", e);
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: red;">Error de red al cargar promociones.</td></tr>';
        }
    }

     // Guardar (crear) una nueva promoción
     async function guardarPromocion(event) {
         event.preventDefault(); // Evita que la página se recargue
         const form = document.getElementById('form-promocion');
         const btn = document.getElementById('btn-guardar-promo');
         const formData = new FormData(form);

         btn.disabled = true;
         btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

         try {
            const response = await fetch('/promociones/crear', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                mostrarAlertaPromo(data.message, 'success');
                form.reset();
                cargarPromociones(); // Recargar la lista de promociones
            } else {
                mostrarAlertaPromo(data.message, 'error');
            }
        } catch (e) {
             console.error("Error al crear promoción:", e);
            mostrarAlertaPromo('Error de red al crear la promoción.', 'error');
        } finally {
            btn.disabled = false;
             btn.innerHTML = '<i class="fas fa-save"></i> Guardar Promoción';
         }
     }
     // Cambiar el estado de una promoción (activar/desactivar)
    async function cambiarEstadoPromocion(promocionId) {
        const form = document.getElementById(`form-estado-promo-${promocionId}`);
        const formData = new FormData(form);
        
        try {
            const response = await fetch(`/promociones/${promocionId}/cambiar_estado`, {
                // ¡AQUÍ YA NO ESTÁ EL ERROR!
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                mostrarAlertaPromo(data.message, 'success');
                cargarPromociones(); // Recargar la tabla
            } else {
                mostrarAlertaPromo(data.message, 'error');
            }
        } catch (e) {
            console.error("Error al cambiar estado:", e);
            mostrarAlertaPromo('Error de red al cambiar estado.', 'error');
        }
    }

    // Asignar el evento de submit al formulario de promociones
    document.getElementById('form-promocion').addEventListener('submit', guardarPromocion);

    // Mostrar alertas de promociones
     function mostrarAlertaPromo(mensaje, tipo) {
         const alertSuccess = document.getElementById('alert-promo-success');
        const alertError = document.getElementById('alert-promo-error');
       
        alertSuccess.style.display = 'none';
        alertError.style.display = 'none';

         if (tipo === 'success') {
            alertSuccess.textContent = mensaje;
             alertSuccess.style.display = 'block';
         } else {
            alertError.textContent = mensaje;
            alertError.style.display = 'block';
         }
     }


</script>
{% endblock %}