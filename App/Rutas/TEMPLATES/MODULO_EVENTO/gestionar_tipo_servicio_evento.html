{% extends "/MODULO_EVENTO/Crud_evento.html" %}

{% block tipo_servicio_evento_content %}

{% if mode == 'list' %}
<div class="content-crud-evento section-content" id="tipos_servicios_evento">
    <h2 class="section-title-f">Gestionar Tipos de Servicio</h2>

    <div class="alert alert-success" id="alert-evento-success" style="display: none;"></div>
    <div class="alert alert-error" id="alert-evento-error" style="display: none;"></div>

    <!-- Barra de bÃºsqueda y filtros -->
    <div class="search-filters-section">
        <div class="search-section">
            <label for="search-input" class="search-label">Buscar</label>
            <div class="search-form">
                <input type="text" id="search-input" name="search" class="search-input"
                    placeholder="Buscar tipo de servicio...">
                <button type="button" class="search-button" onclick="buscarTiposServicio()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="actions-section">
            <button type="button" onclick="window.location.href='{{ url_for('modulos.NewTipoServicio') }}'"
                class="create-button">
                <i class="fas fa-plus"></i> Crear nuevo
            </button>
        </div>
    </div>

    <!-- Tabla -->
    <div class="table-container">
        <table class="tipos-evento-table tbl-list">
            <thead>
                <tr>
                    <th class="col-id text-center">ID</th>
                    <th class="col-nombre text-center">Nombre del Tipo de Servicio</th>
                    <th class="col-estado text-center">Estado</th>
                    <th class="col-accion text-center">AcciÃ³n</th>
                </tr>
            </thead>
            <tbody id="tabla-tipos-servicio-body">
                {% if tipos|length > 0 %}
                {% for tipo in tipos %}
                <tr>
                    <td class="col-id text-center">{{ tipo['id_tipo_servicio_evento'] }}</td>
                    <td class="col-nombre text-center">{{ tipo['nombre_tipo'] }}</td>
                    <td class="col-estado text-center">{{ 'Activo' if tipo['estado']==1 else 'Inactivo' }}</td>
                    <td class="col-accion text-center">
                        <div class="action-buttons2">
                            <button type="button" class="action-btn edit-btn"
                                onclick="window.location.href='{{ url_for('modulos.EditTipoServicio', id_tipo_servicio_evento=tipo['id_tipo_servicio_evento']) }}'">
                                <i class="fa-solid fa-pen"></i>
                            </button>

                            <button type="button" class="action-btn view-btn"
                                onclick="window.location.href='{{ url_for('modulos.ViewTipoServicio', id_tipo_servicio_evento=tipo['id_tipo_servicio_evento']) }}'">
                                <i class="fa-solid fa-eye"></i>
                            </button>

                            <!-- <button class="action-btn delete-btn" data-id="{{ tipo['id_tipo_servicio_evento'] }}"
                                onclick="eliminarServicioEvento(event)">
                                <i class="fas fa-trash"></i>
                            </button> -->

                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="4" class="text-center p-3">No hay tipos de servicio registrados</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    {% else %}
    <!-- Formulario -->
    <div class="content-crud-evento section-content" id="form-servicio-section">
        <div class="form-promocion-f"
            style="background: #f9f9f9; padding: 25px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #328336;">

            <h3 style="color: #328336; margin-top: 0;">
                {% if mode=='insert' %}
                Crear Nuevo Tipo de Servicio
                {% elif mode=='edit' %}
                Editar Tipo de Servicio {{ tipo_servicio['id_tipo_servicio_evento'] }}
                {% else %}
                Ver Tipo de Servicio {{ tipo_servicio['id_tipo_servicio_evento'] }}
                {% endif %}
            </h3>

            <form id="form-tipo-servicio" style="margin-bottom: 0;"
                action="{{ url_for('modulos.SaveTipoServicio') if mode=='insert' else url_for('modulos.UpdateTipoServicio') }}"
                method="POST">

                <input type="hidden" name="id_tipo_servicio_evento"
                    value="{{ tipo_servicio['id_tipo_servicio_evento'] if tipo_servicio else '' }}">

                <div class="form-grid" style="margin-bottom: 25px;">
                    <!-- Nombre -->
                    <div class="form-group">
                        <label for="nombre-tipo">Nombre *</label>

                        {% if mode=='view' %}
                        <input type="text" id="nombre-tipo" class="form-control bg-light"
                            value="{{ tipo_servicio['nombre_tipo'] }}" readonly>
                        {% else %}
                        <input type="text" id="nombre-tipo" name="nombre_tipo" class="form-control"
                            value="{{ tipo_servicio['nombre_tipo'] if tipo_servicio else '' }}" required>
                        {% endif %}
                    </div>

                    <!-- Estado -->
                    <div class="form-group">
                        <label for="estado-tipo">Estado *</label>

                        {% if mode=='view' %}
                        <input type="text" id="estado-tipo" class="form-control bg-light"
                            value="{{ 'Activo' if tipo_servicio['estado']==1 else 'Inactivo' }}" readonly>
                        {% else %}
                        <select id="estado-tipo" name="estado" class="form-control">
                            <option value="1" {% if tipo_servicio and tipo_servicio['estado']==1 %}selected{% endif %}>
                                Activo
                            </option>
                            <option value="0" {% if tipo_servicio and tipo_servicio['estado']==0 %}selected{% endif %}>
                                Inactivo
                            </option>
                        </select>
                        {% endif %}
                    </div>
                </div>

                <div class="form-actions" style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #f0f0f0;">
                    <a href="{{ url_for('modulos.tipos_servicios_evento') }}"
                        class="btn btn-light btn-volver">Volver</a>

                    {% if mode != 'view' %}
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
    {% endif %}
    <input type="hidden" id="tipoServicioEventoIdToDelete">

    <div id="modal-confirm" class="modal-confirm" style="display: none;">
        <div class="modal-confirm-content">
            <div class="modal-confirm-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="modal-confirm-title">Confirmar AcciÃ³n</h3>
            <p class="modal-confirm-message">Â¿EstÃ¡s seguro?</p>
            <div class="modal-confirm-buttons">
                <button class="btn-confirm btn-confirm-danger" onclick="confirmarAccion()">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
                <button class="btn-confirm btn-confirm-secondary" onclick="cancelarAccion()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- NotificaciÃ³n toast -->
    <div id="notification-toast" class="notification-toast" style="display: none;">
        <button class="notification-toast-close" onclick="cerrarNotificacionToast()">
            <i class="fas fa-times"></i>
        </button>
        <div class="notification-toast-header">
            <div class="notification-toast-icon">
                <i class="fas fa-check"></i>
            </div>
            <div class="notification-toast-body">
                <h4 class="notification-toast-title">TÃ­tulo</h4>
                <p class="notification-toast-message">Mensaje</p>
            </div>
        </div>
    </div>
</div>


<script>
    let confirmCallback = null;

    function mostrarModalConfirmacion(titulo, mensaje, descripcion, callback) {
        const modal = document.getElementById('modal-confirm');
        const title = modal.querySelector('.modal-confirm-title');
        const message = modal.querySelector('.modal-confirm-message');

        title.textContent = titulo;
        message.innerHTML = mensaje + '<br><small>' + descripcion + '</small>';

        confirmCallback = callback;
        modal.style.display = 'flex';
        modal.classList.add('show');
    }

    async function eliminarServicioEvento(event) {
        event.stopPropagation();

        const button = event.currentTarget;
        const id = button.dataset.id;

        if (!id) {
            console.error("No se encontrÃ³ el ID del servicio del evento.");
            return;
        }

        // Mostrar el modal de confirmaciÃ³n
        mostrarModalConfirmacion(
            "Eliminar Tipo Servicio",
            `Â¿EstÃ¡s seguro de que deseas eliminar el servicio con ID <strong>${id}</strong>?`,
            "Esta acciÃ³n eliminarÃ¡ permanentemente el servicio asociado al evento.",
            async () => {
                try {
                    const response = await fetch(`/Cruds/DeleteTipoServicio`, {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: new URLSearchParams({ id_tipo_servicio_evento: id })

                    });

                    const result = await response.json();

                    if (result.success) {
                        mostrarNotificacionBonita(
                            "success",
                            "Servicio eliminado",
                            `El servicio con ID ${id} ha sido eliminado correctamente.`
                        );
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        mostrarNotificacionBonita(
                            "error",
                            "Error al eliminar",
                            result.message || "No se pudo eliminar el servicio."
                        );
                    }
                } catch (error) {
                    console.error("Error al eliminar servicio:", error);
                    mostrarNotificacionBonita(
                        "error",
                        "Error",
                        "OcurriÃ³ un problema al eliminar el servicio. Intente nuevamente."
                    );
                }
            }
        );
    }

    function confirmarAccion() {
        if (confirmCallback) confirmCallback();
        cerrarModalConfirmacion();
    }

    function cancelarAccion() {
        cerrarModalConfirmacion();
    }

    function cerrarModalConfirmacion() {
        const modal = document.getElementById('modal-confirm');
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
        confirmCallback = null;
    }

    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('modal-confirm')) {
            cerrarModalConfirmacion();
        }
    });

    function cerrarNotificacionToast() {
        const toast = document.getElementById('notification-toast');
        toast.classList.remove('show');
        setTimeout(() => {
            toast.style.display = 'none';
        }, 300);
    }

    function mostrarNotificacionBonita(tipo, titulo, mensaje) {
        const toast = document.getElementById('notification-toast');
        const icon = toast.querySelector('.notification-toast-icon i');
        const title = toast.querySelector('.notification-toast-title');
        const message = toast.querySelector('.notification-toast-message');

        title.textContent = titulo;
        message.textContent = mensaje;

        toast.className = `notification-toast ${tipo}`;
        icon.className = (tipo === 'success') ? 'fas fa-check' : 'fas fa-times';

        toast.style.display = 'block';
        toast.classList.add('show');

        setTimeout(() => {
            cerrarNotificacionToast();
        }, 4000);
    }
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const input = document.getElementById("search-input");
    const tbody = document.getElementById("tabla-tipos-servicio-body");
    let tiposServicioData = []; // almacenamiento local de resultados

    // âœ… Cargar todos los tipos de servicio al inicio
    async function cargarTiposServicioInicial() {
        try {
            const response = await fetch('/Cruds/SearchTiposServicios?query=');
            tiposServicioData = await response.json();
            mostrarTiposServicio(tiposServicioData);
        } catch (error) {
            console.error("Error al cargar tipos servicio:", error);
        }
    }

    // âœ… Renderizar filas en la tabla
    function mostrarTiposServicio(data) {
        if (!data || data.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center p-3" style="color:#999;">
                        <i class="fas fa-search" style="font-size:20px;margin-bottom:6px;"></i><br>
                        No se encontraron resultados
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = data.map(tipo => `
            <tr>
                <td class="col-id text-center">${tipo.id_tipo_servicio_evento}</td>
                <td class="col-nombre text-center">${tipo.nombre_tipo}</td>
                <td class="col-estado text-center">${tipo.estado == 1 ? 'Activo' : 'Inactivo'}</td>

                <td class="col-accion text-center">
                    <div class="action-buttons2">

                        <button type="button" class="action-btn edit-btn"
                            onclick="window.location.href='/Cruds/EditTipoServicio/${tipo.id_tipo_servicio_evento}'">
                            <i class="fa-solid fa-pen"></i>
                        </button>

                        <button type="button" class="action-btn view-btn"
                            onclick="window.location.href='/Cruds/ViewTipoServicio/${tipo.id_tipo_servicio_evento}'">
                            <i class="fa-solid fa-eye"></i>
                        </button>

                        
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function filtrarLocal() {
        const search = input.value.toLowerCase().trim();

        if (search === "") {
            mostrarTiposServicio(tiposServicioData);
            return;
        }

        const filtrados = tiposServicioData.filter(t => {
            const nombre = t.nombre_tipo.toLowerCase();
            const partes = nombre.split(" ");
            return partes.some(p => p.startsWith(search)) ||
                t.id_tipo_servicio_evento.toString().includes(search);
        });

        mostrarTiposServicio(filtrados);
    }

    // âœ… Buscar en backend solo cuando lo pida el usuario
    async function buscarEnServidor() {
        const query = input.value.trim();

        try {
            const response = await fetch(`/Cruds/SearchTiposServicios?query=${encodeURIComponent(query)}`);
            const data = await response.json();
            tiposServicioData = data;
            mostrarTiposServicio(data);
        } catch (e) {
            console.error("Error backend:", e);
        }
    }

    // ðŸŽ¯ Eventos
    input.addEventListener("input", filtrarLocal);

    input.addEventListener("keydown", e => {
        if (e.key === "Enter") {
            buscarEnServidor();
        }
    });

    // Exponer al botÃ³n del HTML
    window.buscarTiposServicio = buscarEnServidor;

    // Inicial
    cargarTiposServicioInicial();
});
</script>



{% endblock %}