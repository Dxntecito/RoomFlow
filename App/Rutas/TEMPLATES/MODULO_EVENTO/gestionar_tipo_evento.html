{% extends "/MODULO_EVENTO/Crud_evento.html" %}

{% block tipo_evento_content %}

{% if mode == 'list' %}<div class="content-crud-evento section-content" id="tipos_evento">
    <h2 class="section-title-f">Gestionar Tipos de Evento</h2>

    <div class="alert alert-success" id="alert-evento-success" style="display: none;"></div>
    <div class="alert alert-error" id="alert-evento-error" style="display: none;"></div>

    <!-- Barra de bÃºsqueda y filtros -->
    <div class="search-filters-section">
        <div class="search-section">
            <label for="search-input" class="search-label">Buscar</label>
            <div class="search-form">
                <input type="text" id="search-input" name="search" class="search-input"
                    placeholder="Buscar tipo de evento...">
                <button type="button" class="search-button" onclick="buscarTiposEvento()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="actions-section">
            <button type="button" onclick="window.location.href='{{ url_for('modulos.NewTipoEvento') }}'"
                class="create-button">
                <i class="fas fa-plus"></i> Crear nuevo
            </button>
        </div>
    </div>

    <!-- Tabla de Tipos de Evento Existentes -->
    <div class="table-container">
        <table class="tipos-evento-table tbl-list">
            <thead>
                <tr>
                    <th class="col-id text-center">ID</th>
                    <th class="col-nombre text-center">Nombre del Tipo de Evento</th>
                    <th class="col-estado text-center">Estado</th>
                    <th class="col-accion text-center">AcciÃ³n</th>
                </tr>
            </thead>
            <tbody id="tabla-tipos-evento-body">
                {% if tipos|length > 0 %}
                {% for evento in tipos %}

                <tr>
                    <td class="col-id text-center">{{ evento['tipo_evento_id'] }}</td>
                    <td class="col-nombre text-center">{{ evento['nombre_tipo_evento'] }}</td>
                    <td class="col-estado text-center">{{ 'Activo' if evento['estado']==1 else 'Inactivo' }}</td>
                    <td class="col-accion text-center">
                        <div class="action-buttons2">
                            <button type="button" class="action-btn edit-btn"
                                onclick="window.location.href='{{ url_for('modulos.EditTipoEvento', tipo_evento_id=evento['tipo_evento_id']) }}'">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button type="button" class="action-btn view-btn"
                                onclick="window.location.href='{{ url_for('modulos.ViewTipoEvento', tipo_evento_id=evento['tipo_evento_id']) }}'">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="{{ evento['id_evento'] }}"
                                title="Dar de baja evento" {% if evento['tiene_nota_credito'] %} disabled
                                style="opacity:0.5; cursor:not-allowed;" {% endif %} onclick="darBaja(event)">
                                <i class="fas fa-minus"></i>
                            </button>


                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="4" class="text-center p-3">No hay tipos de evento registrados</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    {% else %}
    <!-- Formulario Insert / Edit / View -->
    <div class="content-crud-evento section-content" id="form-evento-section">
        <div class="form-promocion-f"
            style="background: #f9f9f9; padding: 25px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #328336;">

            <h3 style="color: #328336; margin-top: 0;">
                {% if mode=='insert' %}
                Crear Nuevo Tipo de Evento
                {% elif mode=='edit' %}
                Editar Tipo de Evento {{ tipo_evento['tipo_evento_id'] }}
                {% else %}
                Ver Tipo de Evento {{ tipo_evento['tipo_evento_id'] }}
                {% endif %}

            </h3>

            <form id="form-tipo-evento" style="margin-bottom: 0;"
                action="{{ url_for('modulos.SaveTipoEvento') if mode=='insert' else url_for('modulos.UpdateTipoEvento') }}"
                method="POST">

                <input type="hidden" name="tipo_evento_id" value="{{ tipo_evento['tipo_evento_id'] }}">

                <div class="form-grid" style="margin-bottom: 25px;">
                    <div class="form-group">
                        <label for="nombre-tipo-evento">Nombre *</label>
                        {% if mode=='view' %}
                        <input type="text" id="nombre-tipo-evento" class="form-control bg-light"
                            value="{{ tipo_evento['nombre_tipo_evento'] }}" readonly>
                        {% else %}
                        <input type="text" id="nombre-tipo-evento" name="nombre_tipo_evento" class="form-control"
                            value="{{ tipo_evento['nombre_tipo_evento'] if tipo_evento else '' }}" required>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="precio_por_hora">Precio *</label>
                        {% if mode=='view' %}
                        <input type="number" id="precio_por_hora" class="form-control bg-light"
                            value="{{ tipo_evento['precio_por_hora'] }}" readonly>
                        {% else %}
                        <input type="number" id="precio_por_hora" name="precio_por_hora" class="form-control"
                            value="{{ tipo_evento['precio_por_hora'] if tipo_evento else '' }}" required>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="estado-tipo-evento">Estado *</label>
                        {% if mode=='view' %}
                        <input type="text" id="estado-tipo-evento" class="form-control bg-light"
                            value="{{ 'Activo' if tipo_evento['estado']==1 else 'Inactivo' }}" readonly>
                        {% else %}
                        <select id="estado-tipo-evento" name="estado" class="form-control">
                            <option value="1" {% if tipo_evento and tipo_evento['estado']==1 %}selected{% endif %}>
                                Activo</option>
                            <option value="0" {% if tipo_evento and tipo_evento['estado']==0 %}selected{% endif %}>
                                Inactivo</option>
                        </select>
                        {% endif %}
                    </div>
                </div>

                <div class="form-actions" style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #f0f0f0;">
                    <a href="{{ url_for('modulos.tipos_eventos') }}" class="btn btn-light btn-volver">Volver</a>
                    {% if mode != 'view' %}
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Modal confirmaciÃ³n -->
    <input type="hidden" id="tipoEventoIdToDelete">

    <div id="modal-confirm" class="modal-confirm" style="display: none;">
        <div class="modal-confirm-content">
            <div class="modal-confirm-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="modal-confirm-title">Confirmar AcciÃ³n</h3>
            <p class="modal-confirm-message">Â¿EstÃ¡s seguro?</p>
            <div class="modal-confirm-buttons">
                <button class="btn-confirm btn-confirm-danger" onclick="confirmarAccion()">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
                <button class="btn-confirm btn-confirm-secondary" onclick="cancelarAccion()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- NotificaciÃ³n toast -->
    <div id="notification-toast" class="notification-toast" style="display: none;">
        <button class="notification-toast-close" onclick="cerrarNotificacionToast()">
            <i class="fas fa-times"></i>
        </button>
        <div class="notification-toast-header">
            <div class="notification-toast-icon">
                <i class="fas fa-check"></i>
            </div>
            <div class="notification-toast-body">
                <h4 class="notification-toast-title">TÃ­tulo</h4>
                <p class="notification-toast-message">Mensaje</p>
            </div>
        </div>
    </div>
</div>

<!-- Campo oculto para almacenar el ID a eliminar -->
<script>
    let confirmCallback = null;

    function mostrarModalConfirmacion(titulo, mensaje, descripcion, callback) {
        const modal = document.getElementById('modal-confirm');
        const title = modal.querySelector('.modal-confirm-title');
        const message = modal.querySelector('.modal-confirm-message');

        title.textContent = titulo;
        message.innerHTML = mensaje + '<br><small>' + descripcion + '</small>';

        confirmCallback = callback;
        modal.style.display = 'flex';
        modal.classList.add('show');
    }

    async function eliminarTipoEvento(event) {
        event.stopPropagation();

        const button = event.currentTarget;
        const id = button.dataset.id;

        if (!id) {
            console.error("No se encontrÃ³ el ID del tipo de evento.");
            return;
        }

        // Mostrar el modal de confirmaciÃ³n
        mostrarModalConfirmacion(
            "Eliminar Tipo de Evento",
            `Â¿EstÃ¡s seguro de que deseas eliminar el tipo de evento con ID <strong>${id}</strong>?`,
            "Esta acciÃ³n eliminarÃ¡ permanentemente el tipo de evento de la base de datos.",
            async () => {
                try {
                    const response = await fetch(`/Cruds/DeleteTipoEvento`, {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: new URLSearchParams({ tipo_evento_id: id })
                    });

                    const result = await response.json();

                    if (result.success) {
                        mostrarNotificacionBonita(
                            "success",
                            "Tipo de evento eliminado",
                            `El tipo de evento con ID ${id} ha sido eliminado correctamente.`
                        );
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        mostrarNotificacionBonita(
                            "error",
                            "Error al eliminar",
                            result.message || "No se pudo eliminar el tipo de evento."
                        );
                    }
                } catch (error) {
                    console.error("Error al eliminar tipo de evento:", error);
                    mostrarNotificacionBonita(
                        "error",
                        "Error",
                        "OcurriÃ³ un problema al eliminar el tipo de evento. Intente nuevamente."
                    );
                }
            }
        );
    }

    function confirmarAccion() {
        if (confirmCallback) confirmCallback();
        cerrarModalConfirmacion();
    }

    function cancelarAccion() {
        cerrarModalConfirmacion();
    }

    function cerrarModalConfirmacion() {
        const modal = document.getElementById('modal-confirm');
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
        confirmCallback = null;
    }

    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('modal-confirm')) {
            cerrarModalConfirmacion();
        }
    });

    function cerrarNotificacionToast() {
        const toast = document.getElementById('notification-toast');
        toast.classList.remove('show');
        setTimeout(() => {
            toast.style.display = 'none';
        }, 300);
    }

    function mostrarNotificacionBonita(tipo, titulo, mensaje) {
        const toast = document.getElementById('notification-toast');
        const icon = toast.querySelector('.notification-toast-icon i');
        const title = toast.querySelector('.notification-toast-title');
        const message = toast.querySelector('.notification-toast-message');

        title.textContent = titulo;
        message.textContent = mensaje;

        toast.className = `notification-toast ${tipo}`;
        icon.className = (tipo === 'success') ? 'fas fa-check' : 'fas fa-times';

        toast.style.display = 'block';
        toast.classList.add('show');

        setTimeout(() => {
            cerrarNotificacionToast();
        }, 4000);
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {

        const input = document.getElementById("search-input");
        const tbody = document.getElementById("tabla-tipos-evento-body");
        let tiposEventoData = []; // almacenamiento local de resultados

        // âœ… Cargar todos desde backend al inicio
        async function cargarTiposEventoInicial() {
            try {
                const response = await fetch('/Cruds/SearchTiposEventos?query=');
                tiposEventoData = await response.json();
                mostrarTiposEvento(tiposEventoData);
            } catch (error) {
                console.error("Error al cargar tipos evento:", error);
            }
        }

        // âœ… Mostrar en tabla
        function mostrarTiposEvento(data) {
            if (!data || data.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align:center;padding:40px;color:#999;">
                        <i class="fas fa-search" style="font-size:24px;margin-bottom:10px;"></i>
                        No se encontraron resultados
                    </td>
                </tr>
            `;
                return;
            }

            tbody.innerHTML = data.map(evento => `
            <tr>
                <td class="col-id text-center">${evento.tipo_evento_id}</td>
                <td class="col-numero text-center">${evento.nombre_tipo_evento}</td>
                <td class="col-estado text-center">${evento.estado == 1 ? 'Activo' : 'Inactivo'}</td>
                <td class="col-accion text-center">
                    <div class="action-buttons2">
                        <button type="button" class="action-btn edit-btn" 
                            onclick="window.location.href='/Cruds/EditTipoEvento/${evento.tipo_evento_id}'">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button type="button" class="action-btn view-btn" 
                            onclick="window.location.href='/Cruds/ViewTipoEvento/${evento.tipo_evento_id}'">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                        <button type="button" class="action-btn delete-btn" 
                            data-id="${evento.tipo_evento_id}" onclick="eliminarTipoEvento(event)">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        }

        // âœ… Filtrar local mientras escribe
        function filtrarLocal() {
            const search = input.value.toLowerCase().trim();

            if (search === "") {
                mostrarTiposEvento(tiposEventoData);
                return;
            }

            const filtrados = tiposEventoData.filter(t => {
                const nombre = t.nombre_tipo_evento.toLowerCase();
                const partes = nombre.split(" ");

                // Coincidencia por palabra que empieza igual
                return partes.some(p => p.startsWith(search)) ||
                    t.tipo_evento_id.toString().includes(search);
            });

            mostrarTiposEvento(filtrados);
        }

        // âœ… Buscar en servidor (cuando presiona botÃ³n o Enter)
        async function buscarEnServidor() {
            const query = input.value.trim();

            try {
                const response = await fetch(`/Cruds/SearchTiposEventos?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                tiposEventoData = data; // actualizar cache
                mostrarTiposEvento(data);
            } catch (e) {
                console.error("Error backend:", e);
            }
        }

        // ðŸŽ¯ Eventos:
        input.addEventListener("input", filtrarLocal);

        // Enter â†’ bÃºsqueda servidor
        input.addEventListener("keydown", e => {
            if (e.key === "Enter") {
                buscarEnServidor();
            }
        });

        // Hacer accesible al botÃ³n existente
        window.buscarTiposEvento = buscarEnServidor;

        // Inicial
        cargarTiposEventoInicial();
    });
</script>



<script>
    document.addEventListener("DOMContentLoaded", () => {
        // âœ… Define aquÃ­ el ID del enlace activo en el menÃº
        const activeId = "nav-tipos-evento";

        const nav = document.getElementById("nav-principal");
        if (!nav) return;

        const links = nav.querySelectorAll("a");
        links.forEach(link => {
            if (link.id === activeId) {
                link.classList.add("active");
            } else {
                link.classList.remove("active");
            }
        });
    });
</script>

{% endblock %}