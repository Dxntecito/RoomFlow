{% extends "Master.html" %}
{% block stiles %}
<link rel="stylesheet" href="{{ url_for('static', filename='CSS/Booking.css') }}">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Arimo:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='CSS/Booking_huespedes.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='CSS/pago.css') }}">
<style>
  .progress-container {
  position: relative;
  display: flex;
  justify-content: space-between;
  align-items:baseline;
  width: 80%;
  margin: 40px auto;
}

.progress-line {
  position: absolute;
  top: 18px; /* centrado respecto a los c√≠rculos */
  left: 0;
  width: 100%;
  height: 4px;
  background-color: #ccc;
  z-index: 1;
}

.progress-step {
  position: relative;
  z-index: 2;
  text-align: center;
  flex: 1;
}

.circle {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background-color: #ccc;
  color: white;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 8px;
  transition: background-color 0.3s, transform 0.3s;
}

.progress-step.active .circle {
  background-color: #1abc9c; /* verde */
  transform: scale(1.1);
}

.progress-step.completed .circle {
  background-color: #1abc9c;
}

.progress-step p {
  margin: 0;
  font-size: 14px;
  color: #333;
}

</style>
{% endblock %}
{% block content %}
<div id="booking_room_page">
  <div id="booking_room_page">
  <div class="progress-container">
  <div class="progress-line"></div>
  <div class="progress-step active" data-step="1">
    <div class="circle">1</div>
    <p>Habitaciones</p>
  </div>
  <div class="progress-step" data-step="2">
    <div class="circle">2</div>
    <p>Tus datos</p>
  </div>
  <div class="progress-step" data-step="3">
    <div class="circle">3</div>
    <p>Finalizar reserva</p>
  </div>
</div>
  <!-- üîπ PASO 1: Selecci√≥n de habitaciones -->
  <div id="step1">
    <div class="booking-hero">
      <div class="booking-heading">
        <span class="booking-badge"><i class="fas fa-calendar-alt"></i> Reserva f√°cil</span>
        <h2 class="booking_tittle">Reserva de habitaciones</h2>
        <p class="booking-subtitle">Selecciona tus fechas y encuentra la habitaci√≥n perfecta para tu estad√≠a en Hostal Bol√≠var.</p>
        <div class="booking-timer booking-timer--hidden" id="booking_timer_container">
          <i class="fas fa-hourglass-half"></i>
          <span>Tiempo restante: <strong id="booking_timer_display">10:00</strong></span>
        </div>
      </div>

      <form method="GET" action="{{ url_for('bookingroom.BookingRoom') }}" class="booking-card">
        <div class="booking-field">
          <label for="Start_booking_date">Fecha de entrada</label>
          <input type="datetime-local"
                 id="Start_booking_date"
                 name="start"
                 class="date_input"
                 {% if start_dt is not none %}
                   value="{{ start_dt.strftime('%Y-%m-%dT%H:%M') }}"
                 {% else %}
                   value=""
                 {% endif %}>
        </div>

        <div class="booking-field">
          <label for="End_booking_date">Fecha de salida</label>
          <input type="datetime-local"
                 id="End_booking_date"
                 name="end"
                 class="date_input"
                 {% if end_dt is not none %}
                   value="{{ end_dt.strftime('%Y-%m-%dT%H:%M') }}"
                 {% else %}
                   value=""
                 {% endif %}>
        </div>

        <button type="submit" class="booking-submit">
          <i class="fas fa-search"></i>
          Buscar habitaciones
        </button>
      </form>
    </div>

    <div class="booking-filters-card" id="Booking_Filters">
      <div class="filter-header">
        <h3>Filtros</h3>
        <p>Refina tu b√∫squeda seg√∫n piso o categor√≠a para encontrar la habitaci√≥n ideal.</p>
      </div>
      <div class="filter-fields">
        <div class="filter-field">
          <label for="floor_number">Nro. de Piso</label>
          <div class="select-wrapper">
            <i class="fas fa-building"></i>
            <select class="select_design" id="floor_number" name="floor_number">
              <option value="">-- Selecciona una opci√≥n --</option>
              {% for floor in floors %}
              <option value="{{ floor[0] }}">{{ floor[1] }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="filter-field">
          <label for="room_category">Categor√≠a</label>
          <div class="select-wrapper">
            <i class="fas fa-star"></i>
            <select class="select_design" id="room_category" name="turno">
              <option value="">-- Selecciona una opci√≥n --</option>
              {% for category in categories %}
              <option value="{{ category[0] }}">{{ category[1] }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
      <div class="filter-helper">Puedes combinar filtros para mostrar s√≥lo las habitaciones que se ajustan a tus necesidades.</div>
    </div>

    <div>
      <h2 class="Booking_web_subheaders" id="block_titles">Habitaciones elegidas</h2>
      <div class="summary-card" id="summary_booking">
        <div id="selected_rooms"></div>
        <div id="summary_footer">
          <p id="Total_sum">Total: S/. 0.00</p>
          <p><a href="#" class="booking_label" id="next_booking_link">Continuar</a></p>
        </div>
      </div>
    </div>

    <table id="booking_room_available" class="booking_label" border="1">
  <thead>
    <tr>
      <th>Piso</th>
      <th>N¬∞ Habitaci√≥n</th>
      <th>Categor√≠a</th>
      <th>Capacidad</th>
      <th>Precio</th>
      <th>Reservar</th>
    </tr>
  </thead>
  <tbody>
    {% if rooms|length == 0 %}
    <tr>
      <td colspan="6" style="text-align: center; padding: 40px; color: #999;"> 
        <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
        No se encontraron Habitaciones disponibles, intente con otra fecha.
      </td>
    </tr>
    {% else %}
      {% for room in rooms %}
      <tr class="room-row" data-floor="{{ room[4] }}" data-category="{{ room[3] }}">
        {% for floor in floors %}
          {% if room[4] == floor[0] %}
          <td>Piso {{ floor[1] }}</td>
          {% endif %}
        {% endfor %}
        <td>{{ room[1] }}</td>
        {% for category in categories %}
          {% if room[3] == category[0] %}
          <td>{{ category[1] }}</td>
          <td>{{ category[4] }} Personas</td>
          {% endif %}
        {% endfor %}
        <td class="price" data-room-id="{{ room[0] }}">{{ room[5] }}</td>
        <td><input class="checkbox_booking" type="checkbox" name="booking_{{ room[0] }}" value="{{ room[0] }}" id="checkbox_booking_{{ room[0] }}"></td>
      </tr>
      {% endfor %}
    {% endif %}
  </tbody>
</table>

  </div>

  <!-- PASO 2: Registro de cliente -->
  <div id="step2" style="display:none;">
    
    <h2>Registro del Cliente</h2>
    <form id="client_form" autocomplete="off">
      <div class="switch_container" style="display:flex; align-items:center; gap:10px; margin:8px 0;">
        <label class="switch_label">Natural</label>
        <label class="switch">
          <input type="checkbox" id="tipo_cliente_switch">
          <span class="slider round"></span>
        </label>
        <label class="switch_label">Jur√≠dica</label>
      </div>
    <label id="tipo_cliente_label">Persona Natural</label>
    <!-- ---------- Campos Persona Natural ---------- -->
    <div id="natural_fields">
      <label for="num_doc_natural">Tipo Documento</label>
      <select id="tipo_doc_natural">
        <option value="-1">-- Seleccione Tipo Documento --</option>
        {% for type_doc in types_doc %}
          {% if type_doc[1] != "RUC" %}
            <option value="{{ type_doc[0] }}" data-nombre="{{ type_doc[1] }}">{{ type_doc[1] }}</option>
          {% endif %}
        {% endfor %}
      </select>

      </select>
      <div class="input-group">
        <input type="text" id="num_doc_natural" maxlength="8" placeholder="Ej: 87654321">
        <button type="button" id="buscar_natural_doc">Buscar</button>
      </div>
      <label for="nombres">Nombres</label>
      <input type="text" id="nombres" placeholder="Nombres">

      <label for="ape_paterno">Apellido Paterno</label>
      <input type="text" id="ape_paterno" placeholder="Apellido paterno">

      <label for="ape_materno">Apellido Materno</label>
      <input type="text" id="ape_materno" placeholder="Apellido materno">

      <label for="telefono_natural">Tel√©fono</label>
      <input type="text" id="telefono_natural" placeholder="987654321">

      <label for="pais_select">Pa√≠s</label>
      <select id="pais_select">
        <option value="">-- Seleccione pa√≠s --</option>
        {% for country in countries %}
        <option value="{{ country[0] }}">{{ country[1] }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- ---------- Campos Persona Jur√≠dica (ocultos por defecto) ---------- -->
    <div id="juridica_fields" style="display:none;">
      <label for="num_doc_juridico">RUC (11 d√≠gitos)</label>
      <div class="input-group">
        <input type="text" id="num_doc_juridico" maxlength="11" placeholder="Ej: 20123456789">
        <button type="button" id="buscar_juridica_doc">Buscar</button>
      </div>
      <label for="razon_social">Raz√≥n Social</label>
      <input type="text" id="razon_social" placeholder="Nombre de la empresa">

          <label for="tipo_empresa">Tipo de Empresa</label>
      <select id="tipo_empresa">
        <option value="">-- Seleccione Tipo de Empresa --</option>
        {% for type_emp in types_emp %}
        <option value="{{ type_emp[0] }}">{{ type_emp[1] }}</option>
        {% endfor %}
      </select>

      <label for="direccion_juridica">Direcci√≥n</label>
      <input type="text" id="direccion_juridica" placeholder="Direcci√≥n fiscal">

      <label for="telefono_juridico">Tel√©fono</label>
      <input type="text" id="telefono_juridico" placeholder="987654321" maxlength="9">

      <label for="pais_select_j">Pa√≠s</label>
      <select id="pais_select_j">
        <option value="">-- Seleccione pa√≠s --</option>
        {% for country in countries %}
        <option value="{{ country[0] }}">{{ country[1] }}</option>
        {% endfor %}
        <!-- si tienes la lista desde el backend, reemplaza estas opciones dinamicamente -->
      </select>
    </div>

    <div class="button_group" style="margin-top:12px;">
      <button type="button" id="back_to_rooms">‚Üê Regresar</button>
      <button type="button" id="next_to_guests">Siguiente ‚Üí</button>
    </div>
  </form>

  </div>

  <!-- PASO 3: Registro de hu√©spedes -->
  <div id="step3" style="display:none;">
    <h2>Registro de Hu√©spedes por Habitaci√≥n</h2>
    <div id="habitaciones_container"></div>

    <div class="button_group">
      <button type="button" id="back_to_client">‚Üê Regresar</button>
      <button type="submit" id="payment_phase">Continuar al Pago</button>
      <button type="submit" id="finalizar_reserva" style="display:none">Finalizar Reserva</button>
    </div>
  </div>

  <!-- PASO 4: Facturaci√≥n / Pago (lo dejamos, pero lo ocultamos al guardar reserva) -->
  <!-- Tu contenido existente -->
<div id="step4" style="display:none;">
  <h2>Facturaci√≥n y pago</h2>

  <section id="payment_method_section">
    <label class="booking_label">M√©todo de pago:</label>
    <div>
      <label><input type="radio" name="payment_method" value="2" checked> Tarjeta (cr√©dito/d√©bito)</label>
      <!-- <label style="margin-left:1rem;"><input type="radio" name="payment_method" value="3"> Billetera electr√≥nica</label> -->
    </div>
  </section>

  <form id="card_form" autocomplete="off">
    <h3>Datos de la tarjeta</h3>
    <div>
      <label class="booking_label">Titular</label>
      <input type="text" id="card_holder" placeholder="Nombre como en la tarjeta" required>
    </div>
    <div class="card-number-wrapper">
  <label class="booking_label">N√∫mero de tarjeta</label>
  <div class="card-input-container">
    <input
      type="text"
      id="card_number"
      placeholder="1234 5678 9012 3456"
      maxlength="19"
      inputmode="numeric"
      required
    >
    <img id="card_logo" src="" alt="Card Logo" style="display:none;">
  </div>
</div>
    <div style="display:flex; gap:10px;">
      <div style="flex:1;">
        <label class="booking_label">Expiraci√≥n (MM/AA)</label>
        <input type="text" id="card_exp" placeholder="MM/AA" maxlength="5" required>
      </div>
      <div style="width:120px;">
        <label class="booking_label">CVV</label>
        <input type="password" id="card_cvv" placeholder="123" maxlength="4" required>
      </div>
    </div>
  </form>

  <section id="payment_summary">
    <h3>Resumen de pago</h3>
    <div id="payment_items"></div>
    <p id="payment_total"><strong>Total:</strong> S/. <span id="payment_total_amount">0.00</span></p>
  </section>

  <div class="button_group">
    <button type="button" id="back_to_step3">‚Üê Volver</button>
    <button type="button" id="process_payment">Realizar pago</button>
  </div>
</div>

<!-- üåÄ MODAL DE PROCESAMIENTO -->
<div id="paymentModal" class="payment-modal">
  <div class="payment-modal-content">
    <div id="loader" class="loader"></div>
    <h3 id="paymentStatus">Procesando pago...</h3>
  </div>
</div>

  <!-- PASO 5: Comprobante / Descarga -->
  <div id="step5" style="display:none;">
  <h2>Pago completado ‚Äî Comprobante</h2>
  <p>Tu reserva se guard√≥ correctamente. Descarga tu comprobante aqu√≠:</p>

  <div style="display:flex; gap:12px; align-items:center;">
    <a id="download_comprobante_link" class="btn" href="#" target="_blank" download style="display:none;">Descargar comprobante (PDF)</a>
    <button id="open_comprobante_newtab" style="display:none;">Abrir comprobante en nueva pesta√±a</button>
    <p id="comprobante_status" style="margin:0 0 0 8px;color:#333;"></p>
  </div>

  <div class="comprobante-email" style="margin-top:20px;">
    <label for="correo_comprobante">¬øQuieres recibirlo en tu correo?</label>
    <div class="comprobante-email__input">
      <input type="email" id="correo_comprobante" placeholder="tu.correo@ejemplo.com" autocomplete="email">
      <button type="button" id="enviar_comprobante_correo">Enviar comprobante</button>
    </div>
    <p id="comprobante_email_status" class="comprobante-email__status"></p>
  </div>

    <div style="margin-top:16px;">
    <button id="volver_home">Volver al Inicio</button>
  </div>
  </div>
</div>

<div id="booking_timer_modal" class="booking-timer-modal">
  <div class="booking-timer-modal__content">
    <i class="fas fa-hourglass-end"></i>
    <h3>Tiempo de reserva agotado</h3>
    <p>Lo sentimos, los 10 minutos para completar tu reserva han finalizado. Ser√°s redirigido al inicio.</p>
  </div>
</div>

<script>
  window.BOOKING_HOME_URL = "{{ url_for('Index') }}";
</script>
<script src="{{ url_for('static', filename='JS/Booking_timer.js') }}"></script>
<script src="{{ url_for('static', filename='JS/Booking.js') }}"></script>
<script src="{{ url_for('static', filename='JS/Booking_payment.js') }}"></script>
<script src="{{ url_for('static', filename='JS/Booking_functions.js') }}"></script>
<script src="{{ url_for('static', filename='JS/Booking_validations.js') }}"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const fechaEntrada = document.getElementById("Start_booking_date");
  const fechaSalida = document.getElementById("End_booking_date");
  const form = document.querySelector(".booking-card");

  // Poner la fecha m√≠nima en la hora actual
  const now = new Date();
  const pad = n => String(n).padStart(2, "0");
  const localNow = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
  fechaEntrada.min = localNow;
  fechaSalida.min = localNow;

  form.addEventListener("submit", (e) => {
    const entrada = new Date(fechaEntrada.value);
    const salida = new Date(fechaSalida.value);

    if (!fechaEntrada.value || !fechaSalida.value) {
      alert("‚ö†Ô∏è Debes seleccionar ambas fechas.");
      e.preventDefault();
      return;
    }

    if (entrada >= salida) {
      alert("‚ö†Ô∏è La fecha de entrada debe ser antes que la fecha de salida.");
      e.preventDefault();
      return;
    }
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const steps = document.querySelectorAll('.progress-step');
  const line = document.querySelector('.progress-line');
  let currentStep = 1;

  function setStep(step) {
    steps.forEach((el, i) => {
      el.classList.remove('active', 'completed');
      if (i + 1 < step) el.classList.add('completed');
      if (i + 1 === step) el.classList.add('active');
    });
    const percent = (step - 1) / (steps.length - 1) * 100;
    line.style.background = `linear-gradient(to right, #009879 ${percent}%, #ccc ${percent}%)`;
    currentStep = step;
  }

  // Paso 1 por defecto
  setStep(1);

  // --- Eventos ---
  const nextBookingLink = document.getElementById('next_booking_link');
  const paymentPhaseBtn = document.getElementById('payment_phase');

  if (nextBookingLink) {
    nextBookingLink.addEventListener('click', (e) => {
      e.preventDefault();
      setStep(2); // activa "Tus datos"
    });
  }

  if (paymentPhaseBtn) {
    paymentPhaseBtn.addEventListener('click', (e) => {
      setStep(3); // activa "Finalizar reserva"
    });
  }
});
</script>

<script>
  const backToStep3Btn = document.getElementById("back_to_step3");
  const usuarioId = {{ session.get('usuario_id') | tojson }};
  let banderita ="FALSE"
  let usuario_id= "0"
  if (!usuarioId) {
    console.log("No hay usuario logueado");
    banderita ="FALSE"
    // Aqu√≠ puedes ocultar botones, redirigir, etc.
  } else {
    console.log("Usuario logueado:", usuarioId);
    banderita="TRUE"
    usuario = usuarioId
  }
const floorSelect = document.getElementById("floor_number");
function filterRows() {
  const selFloor = floorSelect.value; // valor string o ""
  const selCategory = categorySelect.value;

  // recorrer cada fila
  document.querySelectorAll('.room-row').forEach(row => {
    const rowFloor = row.dataset.floor; // string
    const rowCategory = row.dataset.category;

    let show = true;
    if (selFloor && selFloor !== "" && selFloor !== rowFloor) show = false;
    if (selCategory && selCategory !== "" && selCategory !== rowCategory) show = false;

    const checkbox = row.querySelector('.checkbox_booking');

    if (show) {
      row.style.display = "";
    } else {
      // Si la fila se oculta y est√° marcada, desmarcarla y disparar change para limpiar selecci√≥n
      if (checkbox && checkbox.checked) {
        checkbox.checked = false;
        // dispatchEvent para que el manejador de checkbox limpie la UI y el total
        checkbox.dispatchEvent(new Event('change'));
      }
      row.style.display = "none";
    }
  });
}

// Diccionarios generados por Jinja: id -> nombre, id -> precio
const roomNames = {
{% for room in rooms %}
  "{{ room[0] }}": "{{ room[1] }}"{% if not loop.last %},{% endif %}
{% endfor %}
};
const roomPrices = {
{% for room in rooms %}
  "{{ room[0] }}": {{ room[5] }}{% if not loop.last %},{% endif %}
{% endfor %}
};
const categorySelect = document.getElementById("room_category");

// Escuchar cambios en selects
floorSelect.addEventListener('change', filterRows);
categorySelect.addEventListener('change', filterRows);

// Si quieres aplicar el filtro al cargar con valores por defecto:
filterRows();

// --- Datos de habitaciones generados con Jinja ---
const roomCapacities = {
{% for room in rooms %}
"{{ room[0] }}": {% for category in categories %}{% if room[3] == category[0] %}{{ category[4] }}{% endif %}{% endfor %}{% if not loop.last %},{% endif %}
{% endfor %}
};

// --- Paso 1 ‚Üí Paso 2 (Cliente) ---
nextLink.addEventListener("click", e => {
  e.preventDefault();
  if (selectedRooms.length === 0) {
    alert("Seleccione al menos una habitaci√≥n antes de continuar.");
    return;
  }
  if (usuarioId) {
    step1.style.display = "none";
    step3.style.display = "block";
    generarFormulariosHuespedes();
  }else{
    step1.style.display = "none";
    step2.style.display = "block";
  }
  
});

// --- Paso 2 ‚Üí Paso 1 ---
backToRooms.addEventListener("click", () => {
  step2.style.display = "none";
  step1.style.display = "block";
});

// --- Paso 3 ‚Üí Paso 2 ---
backToClient.addEventListener("click", () => {
  if (usuarioId) {
    step3.style.display = "none";
    step1.style.display = "block";
  }else{
    step3.style.display = "none";
    step2.style.display = "block";
  }
});

// estado de cliente que construir√°s
backToStep3Btn?.addEventListener("click", () => {
  if (step4El) step4El.style.display = "none";
  if (step3El) step3El.style.display = "block";
});

// validar DNI (8 d√≠gitos) y RUC (11 d√≠gitos) - solo n√∫meros
document.getElementById("tipo_doc_natural").addEventListener("change", function () {
  const selectedOption = this.options[this.selectedIndex];
  const tipoNombre = selectedOption.getAttribute("data-nombre");
  const inputNumDoc = document.getElementById("num_doc_natural");

  if (tipoNombre === "DNI") {
    inputNumDoc.maxLength = 8;
    inputNumDoc.placeholder = "Ej: 87654321";
    inputNumDoc.oninput = function () {
      this.value = this.value.replace(/\D/g, ""); // Solo n√∫meros
    };
    tipo_validacion = 1;
  } else if (tipoNombre === "Pasaporte") {
    inputNumDoc.maxLength = 9; // puedes ajustar seg√∫n el formato que uses
    inputNumDoc.placeholder = "Ej: 123456789";
    inputNumDoc.oninput = function () {
      this.value = this.value.replace(/\D/g, ""); // Solo n√∫meros
    };
    tipo_validacion = 0;
  } else {
    inputNumDoc.maxLength = 9;
    inputNumDoc.placeholder = "Ingrese documento";
    inputNumDoc.oninput = function () {
      this.value = ""; // No permite ingresar nada
    };
  }

  // Limpiamos el campo cuando se cambia el tipo
  inputNumDoc.value = "";
});

telefonoInput.addEventListener("input", function () {
  // Eliminar todo lo que no sea n√∫mero
  this.value = this.value.replace(/\D/g, "");

  // Forzar que empiece con 9
  if (this.value.length === 1 && this.value !== "9") {
    this.value = ""; // Si el primer d√≠gito no es 9, se borra
  }

  // Limitar a 9 d√≠gitos
  if (this.value.length > 9) {
    this.value = this.value.slice(0, 9);
  }
});

telefonojuridica.addEventListener("input", function () {
  // Eliminar todo lo que no sea n√∫mero
  this.value = this.value.replace(/\D/g, "");

  // Forzar que empiece con 9
  if (this.value.length === 1 && this.value !== "9") {
    this.value = ""; // Si el primer d√≠gito no es 9, se borra
  }

  // Limitar a 9 d√≠gitos
  if (this.value.length > 9) {
    this.value = this.value.slice(0, 9);
  }
});

// on switch change
tipoSwitch.addEventListener("change", () => {
  toggleClienteView();
  // opcional: limpiar campos para evitar datos sucios entre vistas
  limpiarCampos();
});

// inicializar vista
toggleClienteView();

// bot√≥n volver (si lo usas)
if (backToRoomsBtn) {
  backToRoomsBtn.addEventListener("click", () => {
    // tu l√≥gica para volver al paso anterior (ya exist√≠a)
    // por ejemplo:
    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    if (step2) step2.style.display = "none";
    if (step1) step1.style.display = "block";
  });
}

// bot√≥n siguiente: construir clientData y validar seg√∫n tipo
if (nextToGuestsBtn) {
  nextToGuestsBtn.addEventListener("click", (e) => {
    e.preventDefault();

    const esJuridico = tipoSwitch.checked;

    if (!esJuridico) {
      // Persona Natural -> campos: num_doc, nombres, ape_paterno, ape_materno, telefono, pais
      const dniVal = numDocNatural.value.trim();
      const nombresVal = nombres.value.trim();
      const apePatVal = apePaterno.value.trim();
      const apeMatVal = apeMaterno.value.trim();
      const telefonoVal = telefonoNatural.value.trim();
      const paisVal = paisSelect.value;
      const tipo_doc_n = tipo_doc_natural_select.value;

      // validaciones
      if (!validarPersonaNatural()) return;
      
      clientData = {
        tipo: "N",
        num_doc: dniVal,
        nombres: nombresVal,
        ape_paterno: apePatVal,
        ape_materno: apeMatVal,
        telefono: telefonoVal || null,
        pais_id: paisVal,
        tipo_doc_id: tipo_doc_n,
        usuario_id: usuarioId
      };

    } else {
      // Persona Jur√≠dica -> campos: num_doc_juridico (RUC 11), razon_social, direccion, tipo_empresa
      const rucVal = numDocJuridico.value.trim();
      const razonVal = razonSocial.value.trim();
      const direccionVal = direccionJuridica.value.trim();
      const paisj = paisjuridica.value;
      const telefonoj = telefonojuridica.value.trim();
      const tipoempresaj = tipoempresa.value;
      // const tipoEmpVal = tipoEmpresa.value;

      if (!validarPersonaJuridica()) return;


      clientData = {
        tipo: "J",
        num_doc: rucVal,
        razon_social: razonVal,
        direccion: direccionVal,
        pais_id: paisj,
        telefono: telefonoj,
        tipoemp_id: tipoempresaj,
        usuario_id: usuarioId
      };
    }

    // si llega aqu√≠, clientData est√° listo
    console.log("ClientData preparado:", clientData);

    // aqu√≠ sigue la l√≥gica de tu app: generar formularios de hu√©spedes y avanzar al siguiente paso
    // por ejemplo:
    generarFormulariosHuespedes(); // si usas la funci√≥n que ya tienes

    const step2 = document.getElementById("step2");
    const step3 = document.getElementById("step3");
    if (step2) step2.style.display = "none";
    if (step3) step3.style.display = "block";

    // guarda clientData en un scope global si lo necesitas:
    window.__CLIENT_DATA__ = clientData;
  });
}
</script>
<script>
document.getElementById("volver_home").addEventListener("click", () => {
  window.location.href = "/RoomFlow";
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const cardInput = document.getElementById("card_number");
  const logo = document.getElementById("card_logo");

  const cardPatterns = {
    visa: /^4[0-9]{0,}$/,
    mastercard: /^5[1-5][0-9]{0,}$/,
    amex: /^3[47][0-9]{0,}$/
  };

  const logos = {
    visa: "https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg",
    mastercard: "https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg",
    amex: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/fa/American_Express_logo_%282018%29.svg/640px-American_Express_logo_%282018%29.svg.png"
  };

  cardInput.addEventListener("input", () => {
    let value = cardInput.value.replace(/\D/g, ""); // eliminar espacios/no d√≠gitos
    cardInput.value = value.replace(/(.{4})/g, "$1 ").trim(); // formatea con espacios

    let found = false;
    for (const [brand, pattern] of Object.entries(cardPatterns)) {
      if (pattern.test(value)) {
        logo.src = logos[brand];
        logo.style.display = "block";
        found = true;
        break;
      }
    }

    if (!found) {
      logo.style.display = "none";
    }
  });
});
</script>

{% endblock %}
