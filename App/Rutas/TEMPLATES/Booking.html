{% extends "Master.html" %}
{% block stiles %}
<link rel="stylesheet" href="{{ url_for('static', filename='CSS/Booking.css') }}">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Arimo:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='CSS/Booking_huespedes.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='CSS/pago.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='CSS/Booking_modals.css') }}">
<style>
  .progress-container {
  position: relative;
  display: flex;
  justify-content: space-between;
  align-items:baseline;
  width: 80%;
  margin: 40px auto;
}

.progress-line {
  position: absolute;
  top: 18px; /* centrado respecto a los c√≠rculos */
  left: 0;
  width: 100%;
  height: 4px;
  background-color: #ccc;
  z-index: 1;
}

.progress-step {
  position: relative;
  z-index: 2;
  text-align: center;
  flex: 1;
}

.circle {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background-color: #ccc;
  color: white;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 8px;
  transition: background-color 0.3s, transform 0.3s;
}

.progress-step.active .circle {
  background-color: #1abc9c; /* verde */
  transform: scale(1.1);
}

.progress-step.completed .circle {
  background-color: #1abc9c;
}

.progress-step p {
  margin: 0;
  font-size: 14px;
  color: #333;
}

</style>
{% endblock %}
{% block content %}
<script>
  window.bookingHasSession = {{ (session.get('usuario_id') is not none)|tojson }};
  window.BOOKING_PAGE_URL = "{{ url_for('bookingroom.BookingRoom') }}";
  window.BOOKING_LOGIN_URL = "{{ url_for('usuarios.Login') }}";
  window.BOOKING_REGISTER_URL = "{{ url_for('usuarios.Registro') }}";
</script>
<div id="booking_room_page">
  <div class="progress-container">
  <div class="progress-line"></div>
  <div class="progress-step active" data-step="1">
    <div class="circle">1</div>
    <p>Habitaciones</p>
  </div>
  <div class="progress-step" data-step="2">
    <div class="circle">2</div>
    <p>Tus datos</p>
  </div>
  <div class="progress-step" data-step="3">
    <div class="circle">3</div>
    <p>Finalizar reserva</p>
  </div>
</div>
  <!-- üîπ PASO 1: Selecci√≥n de habitaciones -->
  <div id="step1">
    <div class="booking-hero">
      <div class="booking-heading">
        <!-- Temporizador NO debe aparecer en step1, solo desde step2 en adelante -->
      </div>

      <form method="GET" action="{{ url_for('bookingroom.BookingRoom') }}" class="booking-card">
        <div class="booking-field">
          <label for="Start_booking_date">Fecha de entrada</label>
          <input type="datetime-local"
                 id="Start_booking_date"
                 name="start"
                 class="date_input"
                 {% if start_dt is not none %}
                   value="{{ start_dt.strftime('%Y-%m-%dT%H:%M') }}"
                 {% else %}
                   value=""
                 {% endif %}>
        </div>

        <div class="booking-field">
          <label for="End_booking_date">Fecha de salida</label>
          <input type="datetime-local"
                 id="End_booking_date"
                 name="end"
                 class="date_input"
                 {% if end_dt is not none %}
                   value="{{ end_dt.strftime('%Y-%m-%dT%H:%M') }}"
                 {% else %}
                   value=""
                 {% endif %}>
        </div>

        <button type="submit" class="booking-submit">
          <i class="fas fa-search"></i>
          Buscar habitaciones
        </button>
      </form>
    </div>

    <!-- Contenedor principal: Filtros (izquierda) + Tabla (derecha) -->
    <div class="booking-main-layout">
      <!-- Barra lateral de filtros -->
      <aside class="booking-filters-sidebar" id="Booking_Filters">
        <div class="filter-header">
          <h3>Filtros</h3>
          <p>Refina tu b√∫squeda seg√∫n piso o categor√≠a para encontrar la habitaci√≥n ideal.</p>
        </div>
        <div class="filter-fields">
          <div class="filter-field">
            <label for="floor_number">Nro. de Piso</label>
            <div class="select-wrapper">
              <i class="fas fa-building"></i>
              <select class="select_design" id="floor_number" name="floor_number">
                <option value="">-- Selecciona una opci√≥n --</option>
                {% for floor in floors %}
                <option value="{{ floor[0] }}">{{ floor[1] }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="filter-field">
            <label for="room_category">Categor√≠a</label>
            <div class="select-wrapper">
              <i class="fas fa-star"></i>
              <select class="select_design" id="room_category" name="turno">
                <option value="">-- Selecciona una opci√≥n --</option>
                {% for category in categories %}
                <option value="{{ category.id }}">{{ category.nombre }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="filter-helper">Puedes combinar filtros para mostrar s√≥lo las habitaciones que se ajustan a tus necesidades.</div>
      </aside>

      <!-- Contenido principal: Tabla de habitaciones -->
      <div class="booking-content-main">
        <div class="rooms-table-wrapper">
          <table id="booking_room_available" class="booking_label" border="1">
  <thead>
    <tr>
      <th>Habitaci√≥n</th>
      <th>Detalles</th>
      <th>Precio</th>
      <th>Reservar</th>
    </tr>
  </thead>
  <tbody id="rooms_table_body">
    {% if rooms|length == 0 %}
    <tr>
      <td colspan="6" style="text-align: center; padding: 40px; color: #999;"> 
        <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
        No se encontraron Habitaciones disponibles, intente con otra fecha.
      </td>
    </tr>
    {% else %}
      {% for room in rooms %}
      {% set category = categories_map.get(room.categoria_id) %}
      {% set floor_number = floors_map.get(room.piso_id, room.piso_id) %}
      {% set image_slug = category.slug if category else 'habitacion' %}
      {% set description_text = category.descripcion if category and category.descripcion else 'Disfruta de una estad√≠a confortable con todos los servicios esenciales.' %}
      <tr class="room-row" data-floor="{{ room.piso_id }}" data-category="{{ room.categoria_id }}">
        <td>
          <div class="room-card">
            <div class="room-card__image">
              <img src="{{ url_for('static', filename='Img/' ~ image_slug ~ '.jpg') }}" alt="Habitaci√≥n {{ category.nombre if category else '' }}">
            </div>
            <div class="room-card__meta">
              <h4>Habitaci√≥n {{ room.numero }}</h4>
              <span class="room-card__badge">Piso {{ floor_number }}</span>
            </div>
          </div>
        </td>
        <td>
          <div class="room-card__details">
            <span class="room-card__category">{{ category.nombre if category else 'Categor√≠a' }}</span>
            <p class="room-card__description">
              {{ description_text }}
            </p>
            <span class="room-card__capacity">
              Capacidad: {{ category.capacidad if category else '?' }} personas
            </span>
          </div>
        </td>
        <td class="price" data-room-id="{{ room.id }}">S/. {{ "%.2f"|format(room.precio) }}</td>
        <td><input class="checkbox_booking" type="checkbox" name="booking_{{ room.id }}" value="{{ room.id }}" id="checkbox_booking_{{ room.id }}"></td>
      </tr>
      {% endfor %}
    {% endif %}
  </tbody>
</table>
          <!-- Paginaci√≥n de habitaciones -->
          <div class="rooms-pagination" id="rooms_pagination" style="display: none;">
            <button type="button" class="pagination-btn" id="rooms_prev_btn" disabled>
              <i class="fas fa-chevron-left"></i> Anterior
            </button>
            <span class="pagination-info" id="rooms_pagination_info">P√°gina 1 de 1</span>
            <button type="button" class="pagination-btn" id="rooms_next_btn" disabled>
              Siguiente <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Motivo de viaje -->
    <div class="travel-motive-card">
      <label for="motivo_viaje">MOTIVO DE VIAJE</label>
      <input type="text" id="motivo_viaje" name="motivo_viaje" placeholder="Ej. Vacaciones familiares, viaje de negocios, evento especial...">
      <p class="travel-motive-helper">Comparte el prop√≥sito de tu estad√≠a para que podamos sugerirte servicios y experiencias a medida.</p>
    </div>

    <!-- Habitaciones elegidas y servicios -->
    <div>
      <h2 class="Booking_web_subheaders" id="block_titles">Habitaciones elegidas</h2>
      <div class="summary-card" id="summary_booking">
        <div id="selected_rooms"></div>

        <div id="selected_services_container" class="services-summary hidden">
          <h3>Servicios adicionales</h3>
          <p class="services-summary__helper">Potencia tu experiencia a√±adiendo servicios exclusivos.</p>
          <div class="services-grid">
            {% for service in services %}
            <div class="service-card-horizontal" data-service-id="{{ service.id }}" data-price="{{ '%.2f'|format(service.precio) }}" data-name="{{ service.nombre }}">
              <div class="service-card-horizontal__image">
                <img src="{{ url_for('static', filename='Img/' ~ service.imagen) }}"
                     alt="{{ service.nombre }}">
              </div>
              <div class="service-card-horizontal__content">
                <div class="service-card-horizontal__info">
                  <span class="service-card-horizontal__name">{{ service.nombre }}</span>
                  <p class="service-card-horizontal__description">{{ service.descripcion }}</p>
                </div>
                <div class="service-card-horizontal__controls">
                  <div class="service-quantity-controls">
                    <button type="button" class="quantity-btn quantity-btn--minus" data-service="{{ service.id }}">-</button>
                    <span class="quantity-display" data-service="{{ service.id }}">0</span>
                    <button type="button" class="quantity-btn quantity-btn--plus" data-service="{{ service.id }}">+</button>
                  </div>
                  <span class="service-card-horizontal__price">S/. <span class="service-price-unit">{{ '%.2f'|format(service.precio) }}</span></span>
                  <span class="service-card-horizontal__total">Total: S/. <span class="service-price-total" data-service="{{ service.id }}">0.00</span></span>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <div id="summary_footer">
          <p id="Total_sum">Total: S/. 0.00</p>
          <p><a href="#" class="booking_label" id="next_booking_link">Continuar</a></p>
        </div>
      </div>
    </div>

  </div>

  <!-- PASO 2: Registro de cliente -->
  <div id="step2" style="display:none;">
    <div class="booking-timer booking-timer--hidden" id="booking_timer_container_step2">
      <i class="fas fa-hourglass-half"></i>
      <span>Tiempo restante: <strong id="booking_timer_display_step2">10:00</strong></span>
    </div>
    <h2>Registro del Cliente</h2>
    <form id="client_form" autocomplete="off">
      <div class="client-form-card">
        <div class="client-form-toggle">
          <span class="toggle-label">Natural</span>
          <label class="switch">
            <input type="checkbox" id="tipo_cliente_switch">
            <span class="slider round"></span>
          </label>
          <span class="toggle-label">Jur√≠dica</span>
        </div>
        <p id="tipo_cliente_label" class="client-form-type">Persona Natural</p>

        <!-- ---------- Campos Persona Natural ---------- -->
        <div id="natural_fields" class="form-grid">
          <div class="form-field span-2">
            <label for="tipo_doc_natural">Tipo Documento</label>
            <select id="tipo_doc_natural">
              <option value="-1">-- Seleccione Tipo Documento --</option>
              {% for type_doc in types_doc %}
                {% if type_doc[1] != "RUC" %}
                  <option value="{{ type_doc[0] }}" data-nombre="{{ type_doc[1] }}">{{ type_doc[1] }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>

          <div class="form-field span-2">
            <label for="num_doc_natural">N√∫mero de documento</label>
            <div class="input-group">
              <input type="text" id="num_doc_natural" maxlength="8" placeholder="Ej: 87654321">
              <button type="button" id="buscar_natural_doc">Buscar</button>
            </div>
          </div>

          <div class="form-field">
            <label for="nombres">Nombres</label>
            <input type="text" id="nombres" placeholder="Nombres">
          </div>

          <div class="form-field">
            <label for="telefono_natural">Tel√©fono</label>
            <input type="text" id="telefono_natural" placeholder="987654321">
          </div>

          <div class="form-field">
            <label for="ape_paterno">Apellido Paterno</label>
            <input type="text" id="ape_paterno" placeholder="Apellido paterno">
          </div>

          <div class="form-field">
            <label for="ape_materno">Apellido Materno</label>
            <input type="text" id="ape_materno" placeholder="Apellido materno">
          </div>

          <div class="form-field span-2">
            <label for="pais_select">Pa√≠s</label>
            <select id="pais_select">
              <option value="">-- Seleccione pa√≠s --</option>
              {% for country in countries %}
              <option value="{{ country[0] }}">{{ country[1] }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- ---------- Campos Persona Jur√≠dica (ocultos por defecto) ---------- -->
        <div id="juridica_fields" class="form-grid" style="display:none;">
          <div class="form-field span-2">
            <label for="num_doc_juridico">RUC (11 d√≠gitos)</label>
            <div class="input-group">
              <input type="text" id="num_doc_juridico" maxlength="11" placeholder="Ej: 20123456789">
              <button type="button" id="buscar_juridica_doc">Buscar</button>
            </div>
          </div>

          <div class="form-field">
            <label for="razon_social">Raz√≥n Social</label>
            <input type="text" id="razon_social" placeholder="Nombre de la empresa">
          </div>

          <div class="form-field">
            <label for="telefono_juridico">Tel√©fono</label>
            <input type="text" id="telefono_juridico" placeholder="987654321" maxlength="9">
          </div>

          <div class="form-field">
            <label for="tipo_empresa">Tipo de Empresa</label>
            <select id="tipo_empresa">
              <option value="">-- Seleccione Tipo de Empresa --</option>
              {% for type_emp in types_emp %}
              <option value="{{ type_emp[0] }}">{{ type_emp[1] }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-field">
            <label for="pais_select_j">Pa√≠s</label>
            <select id="pais_select_j">
              <option value="">-- Seleccione pa√≠s --</option>
              {% for country in countries %}
              <option value="{{ country[0] }}">{{ country[1] }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-field span-2">
            <label for="direccion_juridica">Direcci√≥n</label>
            <input type="text" id="direccion_juridica" placeholder="Direcci√≥n fiscal">
          </div>
        </div>

        <div class="button_group">
          <button type="button" id="back_to_rooms">‚Üê Regresar</button>
          <button type="button" id="next_to_guests">Siguiente ‚Üí</button>
        </div>
      </div>
  </form>

  </div>

  <!-- PASO 3: Registro de hu√©spedes -->
  <div id="step3" style="display:none;">
    <div class="booking-timer booking-timer--hidden" id="booking_timer_container_step3">
      <i class="fas fa-hourglass-half"></i>
      <span>Tiempo restante: <strong id="booking_timer_display_step3">10:00</strong></span>
    </div>
    <h2>Registro de Hu√©spedes por Habitaci√≥n</h2>
    <div id="habitaciones_container"></div>

    <div class="button_group">
      <button type="button" id="back_to_client">‚Üê Regresar</button>
      <button type="submit" id="payment_phase">Continuar al Pago</button>
      <button type="submit" id="finalizar_reserva" style="display:none">Finalizar Reserva</button>
    </div>
  </div>

  <!-- PASO 4: Facturaci√≥n / Pago (lo dejamos, pero lo ocultamos al guardar reserva) -->
  <!-- Tu contenido existente -->
  <div id="step4" style="display:none;">
    <div class="booking-timer booking-timer--hidden" id="booking_timer_container_step4">
      <i class="fas fa-hourglass-half"></i>
      <span>Tiempo restante: <strong id="booking_timer_display_step4">10:00</strong></span>
    </div>
    <h2>Facturaci√≥n y pago</h2>

    <div class="payment-layout">
      <!-- Columna izquierda: M√©todos de pago (60%) -->
      <div class="payment-methods-column">
  <section id="payment_method_section">
    <label class="booking_label">M√©todo de pago:</label>
    <div>
      <label><input type="radio" name="payment_method" value="2" checked> Tarjeta (cr√©dito/d√©bito)</label>
      <label style="margin-left:1rem;"><input type="radio" name="payment_method" value="4"> Pago por QR</label>
      <label style="margin-left:1rem;"><input type="radio" name="payment_method" value="5"> Transferencia bancaria</label>
    </div>
  </section>

  <form id="card_form" autocomplete="off">
    <h3>Datos de la tarjeta</h3>
    <div>
      <label class="booking_label">Titular</label>
      <input
        type="text"
        id="card_holder"
        placeholder="Nombre como en la tarjeta"
        maxlength="50"
        autocomplete="cc-name"
        inputmode="text"
        required>
    </div>
    <div class="card-number-wrapper">
  <label class="booking_label">N√∫mero de tarjeta</label>
  <div class="card-input-container">
    <input
      type="text"
      id="card_number"
      placeholder="1234 5678 9012 3456"
      maxlength="19"
      inputmode="numeric"
      required
    >
    <img id="card_logo" src="" alt="Card Logo" style="display:none;">
  </div>
</div>
    <div style="display:flex; gap:10px;">
      <div style="flex:1;">
        <label class="booking_label">Expiraci√≥n (MM/AA)</label>
        <div class="card-exp-wrapper">
          <select id="card_exp_month" class="card-exp-select" required>
            <option value="">MM</option>
            <option value="01">01</option>
            <option value="02">02</option>
            <option value="03">03</option>
            <option value="04">04</option>
            <option value="05">05</option>
            <option value="06">06</option>
            <option value="07">07</option>
            <option value="08">08</option>
            <option value="09">09</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
          </select>
          <span class="card-exp-separator">/</span>
          <select id="card_exp_year" class="card-exp-select" required>
            <option value="">AA</option>
          </select>
          <input type="hidden" id="card_exp" required>
        </div>
      </div>
      <div style="width:120px;">
        <label class="booking_label">CVV</label>
        <input type="password" id="card_cvv" placeholder="123" maxlength="4" required>
      </div>
    </div>
  </form>

  <section id="qr_payment_section" class="payment-alt hidden">
    <h3>Pago por QR (Yape)</h3>
    <div class="payment-brand">
      <img src="{{ url_for('static', filename='Img/yape.jpg') }}" alt="Logo Yape" style="max-width: 1200px; width: 100%; height: auto;">
    </div>
    <p>Escanea el c√≥digo con Yape para enviar tu pago al n√∫mero <strong>+51 952 225 506</strong>.</p>
    <p class="payment-hint">Nuestro equipo verificar√° el pago y confirmar√° tu reserva.</p>
  </section>

  <section id="transfer_payment_section" class="payment-alt hidden">
    <h3>Transferencia bancaria</h3>
    <div class="transfer-info">
      <p><strong>N√∫mero de cuenta:</strong> 30570524754011</p>
      <p><strong>CCI:</strong> 0023517052475401118</p>
      <p>Realiza la transferencia por el monto indicado y conserva el comprobante.</p>
    </div>
    <p class="payment-hint">Un asesor validar√° la operaci√≥n antes de cerrar la reserva.</p>
  </section>
      </div>

      <!-- Columna derecha: Resumen de pago (40%) -->
      <div class="payment-summary-column">
  <section id="payment_summary">
    <h3>Resumen de pago</h3>
    <div id="payment_items"></div>
    <p id="payment_total"><strong>Total:</strong> S/. <span id="payment_total_amount">0.00</span></p>
  </section>
      </div>
    </div>

  <div class="button_group">
    <button type="button" id="back_to_step3">‚Üê Volver</button>
    <button type="button" id="process_payment">Realizar pago</button>
  </div>
</div>

<!-- üåÄ MODAL DE PROCESAMIENTO -->
<div id="paymentModal" class="payment-modal">
  <div class="payment-modal-content">
    <div id="loader" class="loader"></div>
    <h3 id="paymentStatus">Procesando pago...</h3>
  </div>
</div>

  <!-- PASO 5: Comprobante / Descarga -->
  <div id="step5" style="display:none;">
    <div class="booking-timer booking-timer--hidden" id="booking_timer_container_step5">
      <i class="fas fa-hourglass-half"></i>
      <span>Tiempo restante: <strong id="booking_timer_display_step5">10:00</strong></span>
    </div>
    <h2>Pago completado ‚Äî Comprobante</h2>
  <p>Tu reserva se guard√≥ correctamente. Descarga tu comprobante aqu√≠:</p>

  <div style="display:flex; gap:12px; align-items:center;">
    <a id="download_comprobante_link" class="btn" href="#" target="_blank" download style="display:none;">Descargar comprobante (PDF)</a>
    <button id="open_comprobante_newtab" style="display:none;">Abrir comprobante en nueva pesta√±a</button>
    <p id="comprobante_status" style="margin:0 0 0 8px;color:#333;"></p>
  </div>

  <div class="comprobante-email" style="margin-top:20px;">
    <label for="correo_comprobante">¬øQuieres recibirlo en tu correo?</label>
    <div class="comprobante-email__input">
      <input type="email" id="correo_comprobante" placeholder="tu.correo@ejemplo.com" autocomplete="email">
      <button type="button" id="enviar_comprobante_correo">Enviar comprobante</button>
    </div>
    <p id="comprobante_email_status" class="comprobante-email__status"></p>
  </div>

    <div style="margin-top:16px;">
    <button id="volver_home">Volver al Inicio</button>
  </div>
  </div>
</div>

<div id="booking_timer_modal" class="booking-timer-modal">
  <div class="booking-timer-modal__content">
    <i class="fas fa-hourglass-end"></i>
    <h3>Tiempo de reserva agotado</h3>
    <p>Lo sentimos, los 10 minutos para completar tu reserva han finalizado. Ser√°s redirigido al inicio.</p>
  </div>
</div>

<script>
  window.BOOKING_HOME_URL = "{{ url_for('Index') }}";
</script>
<script src="{{ url_for('static', filename='JS/Booking_modals.js') }}"></script>
<script src="{{ url_for('static', filename='JS/date_input_lock.js') }}"></script>
<script src="{{ url_for('static', filename='JS/Booking_timer.js') }}"></script>
<script src="{{ url_for('static', filename='JS/Booking.js') }}"></script>
<script src="{{ url_for('static', filename='JS/Booking_payment.js') }}"></script>
<script src="{{ url_for('static', filename='JS/Booking_functions.js') }}"></script>
<script src="{{ url_for('static', filename='JS/Booking_validations.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const fechaEntrada = document.getElementById("Start_booking_date");
  const fechaSalida = document.getElementById("End_booking_date");
  const form = document.querySelector(".booking-card");

  // Poner la fecha m√≠nima en la hora actual
  const now = new Date();
  const pad = n => String(n).padStart(2, "0");
  const formatDateTimeLocal = date => `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
  const ONE_HOUR_MS = 60 * 60 * 1000;

  const localNow = formatDateTimeLocal(now);
  const initialSalidaMin = formatDateTimeLocal(new Date(now.getTime() + ONE_HOUR_MS));

  fechaEntrada.min = localNow;
  fechaSalida.min = initialSalidaMin;

  fechaEntrada.addEventListener("change", () => {
    if (fechaEntrada.value) {
      const entradaDate = new Date(fechaEntrada.value);
      const minSalidaDate = new Date(entradaDate.getTime() + ONE_HOUR_MS);
      const minSalidaString = formatDateTimeLocal(minSalidaDate);

      fechaSalida.min = minSalidaString;

      if (fechaSalida.value) {
        const salidaDate = new Date(fechaSalida.value);
        if (salidaDate < minSalidaDate) {
          fechaSalida.value = minSalidaString;
        }
      } else {
        fechaSalida.value = minSalidaString;
      }
    } else {
      fechaSalida.min = initialSalidaMin;
      if (fechaSalida.value && fechaSalida.value < initialSalidaMin) {
        fechaSalida.value = initialSalidaMin;
      }
    }
  });

  fechaSalida.addEventListener("change", () => {
    if (fechaEntrada.value && fechaSalida.value) {
      const entradaDate = new Date(fechaEntrada.value);
      const minSalidaDate = new Date(entradaDate.getTime() + ONE_HOUR_MS);
      const salidaDate = new Date(fechaSalida.value);

      if (salidaDate < minSalidaDate) {
        const minSalidaString = formatDateTimeLocal(minSalidaDate);
        fechaSalida.value = minSalidaString;
        fechaSalida.min = minSalidaString;
      }
    }
  });

  form.addEventListener("submit", (e) => {
    const entrada = new Date(fechaEntrada.value);
    const salida = new Date(fechaSalida.value);

    if (!fechaEntrada.value || !fechaSalida.value) {
      showBookingAlert("‚ö†Ô∏è Debes seleccionar ambas fechas.", "warning");
      e.preventDefault();
      return;
    }

    // Validar que la entrada sea despu√©s de la hora actual
    if (entrada < now) {
      showBookingAlert("‚ö†Ô∏è La fecha de entrada debe ser posterior a la fecha y hora actuales.", "warning");
      e.preventDefault();
      return;
    }

    if (entrada >= salida) {
      showBookingAlert("‚ö†Ô∏è La fecha de salida debe ser posterior a la fecha de entrada.", "warning");
      e.preventDefault();
      return;
    }

    const diffMs = salida.getTime() - entrada.getTime();
    if (diffMs < ONE_HOUR_MS) {
      showBookingAlert("‚ö†Ô∏è La fecha de salida debe ser al menos una hora despu√©s de la fecha de entrada.", "warning");
      e.preventDefault();
      return;
    }
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const steps = document.querySelectorAll('.progress-step');
  const line = document.querySelector('.progress-line');
  let currentStep = 1;

  function setStep(step) {
    steps.forEach((el, i) => {
      el.classList.remove('active', 'completed');
      if (i + 1 < step) el.classList.add('completed');
      if (i + 1 === step) el.classList.add('active');
    });
    const percent = (step - 1) / (steps.length - 1) * 100;
    line.style.background = `linear-gradient(to right, #009879 ${percent}%, #ccc ${percent}%)`;
    currentStep = step;
  }

  // Paso 1 por defecto
  setStep(1);

  // --- Eventos ---
  const nextBookingLink = document.getElementById('next_booking_link');
  const paymentPhaseBtn = document.getElementById('payment_phase');

  if (nextBookingLink) {
    nextBookingLink.addEventListener('click', (e) => {
      e.preventDefault();
      setStep(2); // activa "Tus datos"
    });
  }

  if (paymentPhaseBtn) {
    paymentPhaseBtn.addEventListener('click', (e) => {
      setStep(3); // activa "Finalizar reserva"
    });
  }
});
</script>

<script>
  const backToStep3Btn = document.getElementById("back_to_step3");
  const usuarioId = {{ session.get('usuario_id') | tojson }};
  let banderita ="FALSE"
  let usuario_id= "0"
  if (!usuarioId) {
    console.log("No hay usuario logueado");
    banderita ="FALSE"
    // Aqu√≠ puedes ocultar botones, redirigir, etc.
  } else {
    console.log("Usuario logueado:", usuarioId);
    banderita="TRUE"
    usuario = usuarioId
  }
const floorSelect = document.getElementById("floor_number");
function filterRows() {
  const selFloor = floorSelect.value; // valor string o ""
  const selCategory = categorySelect.value;

  // recorrer cada fila
  document.querySelectorAll('.room-row').forEach(row => {
    const rowFloor = row.dataset.floor; // string
    const rowCategory = row.dataset.category;

    let show = true;
    if (selFloor && selFloor !== "" && selFloor !== rowFloor) show = false;
    if (selCategory && selCategory !== "" && selCategory !== rowCategory) show = false;

    const checkbox = row.querySelector('.checkbox_booking');

    if (show) {
      row.style.display = "";
      row.dataset.filtered = "true"; // Marcar como no filtrada
    } else {
      // Si la fila se oculta y est√° marcada, desmarcarla y disparar change para limpiar selecci√≥n
      if (checkbox && checkbox.checked) {
        checkbox.checked = false;
        // dispatchEvent para que el manejador de checkbox limpie la UI y el total
        checkbox.dispatchEvent(new Event('change'));
      }
      row.style.display = "none";
      row.dataset.filtered = "false"; // Marcar como filtrada
    }
  });
  
  // Resetear a p√°gina 1 cuando se aplican filtros
  currentRoomsPage = 1;
}

// Diccionarios generados por Jinja: id -> nombre, id -> precio
const roomNames = {
{% for room in rooms %}
  "{{ room.id }}": "{{ room.numero }}"{% if not loop.last %},{% endif %}
{% endfor %}
};
const roomPrices = {
{% for room in rooms %}
  "{{ room.id }}": {{ "%.2f"|format(room.precio) }}{% if not loop.last %},{% endif %}
{% endfor %}
};
const serviceNames = {
{% for service in services %}
  "{{ service.id }}": "{{ service.nombre }}"{% if not loop.last %},{% endif %}
{% endfor %}
};
const servicePrices = {
{% for service in services %}
  "{{ service.id }}": {{ "%.2f"|format(service.precio) }}{% if not loop.last %},{% endif %}
{% endfor %}
};
const categorySelect = document.getElementById("room_category");

// Escuchar cambios en selects
floorSelect.addEventListener('change', () => {
  filterRows();
  updateRoomsPagination();
});
categorySelect.addEventListener('change', () => {
  filterRows();
  updateRoomsPagination();
});

// Paginaci√≥n de habitaciones (5 por p√°gina)
let currentRoomsPage = 1;
const ROOMS_PER_PAGE = 5;

function updateRoomsPagination() {
  // Obtener todas las filas que NO est√°n filtradas (disponibles para mostrar)
  const allRows = Array.from(document.querySelectorAll('.room-row'));
  const visibleRows = allRows.filter(row => {
    // Si no tiene el atributo filtered, asumir que est√° disponible
    if (!row.dataset.filtered) {
      return true;
    }
    // Solo incluir filas que no est√°n filtradas
    return row.dataset.filtered === 'true';
  });
  
  const totalPages = Math.ceil(visibleRows.length / ROOMS_PER_PAGE);
  const pagination = document.getElementById('rooms_pagination');
  const prevBtn = document.getElementById('rooms_prev_btn');
  const nextBtn = document.getElementById('rooms_next_btn');
  const infoSpan = document.getElementById('rooms_pagination_info');
  
  // Si no hay p√°ginas o solo hay una, ocultar paginaci√≥n
  if (totalPages <= 1) {
    if (pagination) pagination.style.display = 'none';
    // Mostrar todas las filas no filtradas
    visibleRows.forEach(row => {
      row.style.display = '';
    });
    return;
  }
  
  // Ajustar currentRoomsPage si es mayor que totalPages
  if (currentRoomsPage > totalPages) {
    currentRoomsPage = totalPages;
  }
  
  if (pagination) pagination.style.display = 'flex';
  if (prevBtn) prevBtn.disabled = currentRoomsPage === 1;
  if (nextBtn) nextBtn.disabled = currentRoomsPage >= totalPages;
  if (infoSpan) infoSpan.textContent = `P√°gina ${currentRoomsPage} de ${totalPages}`;
  
  // Mostrar solo las filas de la p√°gina actual
  const startIndex = (currentRoomsPage - 1) * ROOMS_PER_PAGE;
  const endIndex = startIndex + ROOMS_PER_PAGE;
  
  visibleRows.forEach((row, index) => {
    if (index >= startIndex && index < endIndex) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

// Event listeners para paginaci√≥n
document.getElementById('rooms_prev_btn')?.addEventListener('click', () => {
  if (currentRoomsPage > 1) {
    currentRoomsPage--;
    updateRoomsPagination();
    // Scroll suave hacia arriba de la tabla
    const table = document.getElementById('booking_room_available');
    if (table) {
      table.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }
});

document.getElementById('rooms_next_btn')?.addEventListener('click', () => {
  // Obtener filas no filtradas
  const allRows = Array.from(document.querySelectorAll('.room-row'));
  const visibleRows = allRows.filter(row => {
    if (!row.dataset.filtered) return true;
    return row.dataset.filtered === 'true';
  });
  const totalPages = Math.ceil(visibleRows.length / ROOMS_PER_PAGE);
  
  if (currentRoomsPage < totalPages) {
    currentRoomsPage++;
    updateRoomsPagination();
    // Scroll suave hacia arriba de la tabla
    const table = document.getElementById('booking_room_available');
    if (table) {
      table.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }
});

// Inicializar paginaci√≥n al cargar
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    // Marcar todas las filas como disponibles inicialmente
    document.querySelectorAll('.room-row').forEach(row => {
      if (!row.dataset.filtered) {
        row.dataset.filtered = 'true';
      }
    });
    filterRows();
    updateRoomsPagination();
  }, 100);
});

// Funci√≥n para verificar si hay habitaciones y deshabilitar filtros
function updateFiltersState() {
  const filtersSidebar = document.getElementById('Booking_Filters');
  const roomRows = document.querySelectorAll('.room-row');
  const hasRooms = roomRows.length > 0;
  
  if (filtersSidebar) {
    if (hasRooms) {
      filtersSidebar.classList.remove('disabled');
      if (floorSelect) floorSelect.disabled = false;
      if (categorySelect) categorySelect.disabled = false;
    } else {
      filtersSidebar.classList.add('disabled');
      if (floorSelect) floorSelect.disabled = true;
      if (categorySelect) categorySelect.disabled = true;
    }
  }
}

// Funci√≥n para sincronizar altura del aside con la tabla
function syncSidebarHeight() {
  const sidebar = document.getElementById('Booking_Filters');
  const tableWrapper = document.querySelector('.rooms-table-wrapper');
  const table = document.getElementById('booking_room_available');
  
  if (!sidebar) return;
  
  // Obtener altura de la tabla o del wrapper
  let tableHeight = 0;
  if (table) {
    tableHeight = table.offsetHeight;
  } else if (tableWrapper) {
    tableHeight = tableWrapper.offsetHeight;
  }
  
  // Altura m√≠nima para que los datos no se sobresalgan
  const minHeight = 300;
  
  // Usar la altura de la tabla o la m√≠nima, la que sea mayor
  const finalHeight = Math.max(tableHeight, minHeight);
  
  // Aplicar altura fija al sidebar
  sidebar.style.height = finalHeight + 'px';
  sidebar.style.minHeight = finalHeight + 'px';
  sidebar.style.maxHeight = finalHeight + 'px';
  sidebar.style.overflowY = 'auto'; // Permitir scroll si el contenido es mayor
}

// Si quieres aplicar el filtro al cargar con valores por defecto:
filterRows();
updateFiltersState();
syncSidebarHeight();
toggleServicesSection?.();

// Observar cambios en la tabla para actualizar altura y estado de filtros
const tableObserver = new MutationObserver(() => {
  updateFiltersState();
  syncSidebarHeight();
});

const table = document.getElementById('booking_room_available');
if (table) {
  tableObserver.observe(table, {
    childList: true,
    subtree: true,
    attributes: true,
    attributeFilter: ['style']
  });
}

// Actualizar altura cuando cambie el tama√±o de la ventana
window.addEventListener('resize', () => {
  setTimeout(syncSidebarHeight, 100);
});

// --- Datos de habitaciones generados con Jinja ---
const roomCapacities = {
{% for room in rooms %}
  "{{ room.id }}": {{ categories_map.get(room.categoria_id).capacidad if categories_map.get(room.categoria_id) else 0 }}{% if not loop.last %},{% endif %}
{% endfor %}
};

const BOOKING_STORAGE_KEY = 'booking_pending_data';

function getSelectedServiceIds() {
  return Array.from(document.querySelectorAll('.service-checkbox:checked')).map(cb => cb.value);
}

function saveBookingProgress(reason = 'login') {
  try {
    const state = {
      rooms: Array.isArray(selectedRooms) ? [...selectedRooms] : [],
      services: getSelectedServiceIds(),
      startDate: startDateInput?.value || '',
      endDate: endDateInput?.value || '',
      timestamp: Date.now(),
      reason
    };
    localStorage.setItem(BOOKING_STORAGE_KEY, JSON.stringify(state));
  } catch (error) {
    console.warn('[Booking] No se pudo guardar el progreso:', error);
  }
}

function resetBookingSelections() {
  selectedRooms = [];
  selectedServices = [];
  roomsTotal = 0;
  servicesTotal = 0;
  total = 0;
  if (selectedContainer) {
    selectedContainer.innerHTML = '';
  }
  document.querySelectorAll('.checkbox_booking').forEach(cb => {
    cb.checked = false;
  });
  resetServicesSelection();
  updateTotalDisplay();
}

function restoreBookingProgressIfNeeded() {
  if (!window.bookingHasSession) return;
  let stored = null;
  try {
    stored = localStorage.getItem(BOOKING_STORAGE_KEY);
  } catch (error) {
    console.warn('[Booking] No se pudo leer el progreso guardado:', error);
  }
  if (!stored) return;

  let data = null;
  try {
    data = JSON.parse(stored);
  } catch (error) {
    console.warn('[Booking] Progreso inv√°lido, se eliminar√°.', error);
    localStorage.removeItem(BOOKING_STORAGE_KEY);
    return;
  }

  resetBookingSelections();

  if (startDateInput && data.startDate) {
    startDateInput.value = data.startDate;
  }
  if (endDateInput && data.endDate) {
    endDateInput.value = data.endDate;
  }

  if (Array.isArray(data.rooms)) {
    const roomsSet = new Set(data.rooms);
    document.querySelectorAll('.checkbox_booking').forEach(cb => {
      if (roomsSet.has(cb.value)) {
        cb.checked = true;
        cb.dispatchEvent(new Event('change'));
      }
    });
  }

  if (Array.isArray(data.services)) {
    const servicesSet = new Set(data.services);
    serviceCheckboxes.forEach(cb => {
      cb.checked = servicesSet.has(cb.value);
      cb.dispatchEvent(new Event('change'));
    });
  }

  // Ocultar paso 1 y mostrar el siguiente paso apropiado
  if (step1) step1.style.display = 'none';
  if (usuarioId) {
    if (step2) step2.style.display = 'none';
    if (step3) {
      step3.style.display = 'block';
      generarFormulariosHuespedes();
    }
  } else {
    if (step2) step2.style.display = 'block';
  }

  if (window.bookingTimer && typeof window.bookingTimer.updateVisibility === 'function') {
    window.bookingTimer.updateVisibility();
  }

  scrollToTop();

  try {
    localStorage.removeItem(BOOKING_STORAGE_KEY);
  } catch (error) {
    console.warn('[Booking] No se pudo limpiar el progreso guardado:', error);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  restoreBookingProgressIfNeeded();
  // Verificar estado inicial de filtros y altura
  setTimeout(() => {
    updateFiltersState();
    syncSidebarHeight();
  }, 100);
});

// Funci√≥n helper para hacer scroll hacia arriba
function scrollToTop() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// --- Paso 1 ‚Üí Paso 2 (Cliente) ---
nextLink.addEventListener("click", e => {
  e.preventDefault();
  if (!usuarioId) {
    saveBookingProgress('login');
    const currentUrl = window.location.pathname + window.location.search;
    const loginTarget = window.BOOKING_LOGIN_URL
      ? `${window.BOOKING_LOGIN_URL}?return_url=${encodeURIComponent(currentUrl)}`
      : currentUrl;
    window.location.href = loginTarget;
    return;
  }
  if (selectedRooms.length === 0) {
    showBookingAlert("Seleccione al menos una habitaci√≥n antes de continuar.", "warning");
    return;
  }
  step1.style.display = "none";
  step3.style.display = "block";
  generarFormulariosHuespedes();
  // Actualizar visibilidad del temporizador
  if (window.bookingTimer && typeof window.bookingTimer.updateVisibility === 'function') {
    window.bookingTimer.updateVisibility();
  }
  scrollToTop();
});

// --- Paso 2 ‚Üí Paso 1 ---
backToRooms.addEventListener("click", () => {
  step2.style.display = "none";
  step1.style.display = "block";
  scrollToTop();
});

// --- Paso 3 ‚Üí Paso 2 ---
backToClient.addEventListener("click", () => {
  if (usuarioId) {
    step3.style.display = "none";
    step1.style.display = "block";
  }else{
    step3.style.display = "none";
    step2.style.display = "block";
  }
  // Actualizar visibilidad del temporizador
  if (window.bookingTimer && typeof window.bookingTimer.updateVisibility === 'function') {
    window.bookingTimer.updateVisibility();
  }
  scrollToTop();
});

// estado de cliente que construir√°s
backToStep3Btn?.addEventListener("click", () => {
  if (step4El) step4El.style.display = "none";
  if (step3El) step3El.style.display = "block";
  scrollToTop();
});

// validar DNI (8 d√≠gitos) y RUC (11 d√≠gitos) - solo n√∫meros
document.getElementById("tipo_doc_natural").addEventListener("change", function () {
  const selectedOption = this.options[this.selectedIndex];
  const tipoNombre = selectedOption.getAttribute("data-nombre");
  const inputNumDoc = document.getElementById("num_doc_natural");

  if (tipoNombre === "DNI") {
    inputNumDoc.maxLength = 8;
    inputNumDoc.placeholder = "Ej: 87654321";
    inputNumDoc.oninput = function () {
      this.value = this.value.replace(/\D/g, ""); // Solo n√∫meros
    };
    tipo_validacion = 1;
  } else if (tipoNombre === "Pasaporte") {
    inputNumDoc.maxLength = 9; // puedes ajustar seg√∫n el formato que uses
    inputNumDoc.placeholder = "Ej: 123456789";
    inputNumDoc.oninput = function () {
      this.value = this.value.replace(/\D/g, ""); // Solo n√∫meros
    };
    tipo_validacion = 0;
  } else {
    inputNumDoc.maxLength = 9;
    inputNumDoc.placeholder = "Ingrese documento";
    inputNumDoc.oninput = function () {
      this.value = ""; // No permite ingresar nada
    };
  }

  // Limpiamos el campo cuando se cambia el tipo
  inputNumDoc.value = "";
});

telefonoInput.addEventListener("input", function () {
  // Eliminar todo lo que no sea n√∫mero
  this.value = this.value.replace(/\D/g, "");

  // Forzar que empiece con 9
  if (this.value.length === 1 && this.value !== "9") {
    this.value = ""; // Si el primer d√≠gito no es 9, se borra
  }

  // Limitar a 9 d√≠gitos
  if (this.value.length > 9) {
    this.value = this.value.slice(0, 9);
  }
});

telefonojuridica.addEventListener("input", function () {
  // Eliminar todo lo que no sea n√∫mero
  this.value = this.value.replace(/\D/g, "");

  // Forzar que empiece con 9
  if (this.value.length === 1 && this.value !== "9") {
    this.value = ""; // Si el primer d√≠gito no es 9, se borra
  }

  // Limitar a 9 d√≠gitos
  if (this.value.length > 9) {
    this.value = this.value.slice(0, 9);
  }
});

// on switch change
tipoSwitch.addEventListener("change", () => {
  toggleClienteView();
  // opcional: limpiar campos para evitar datos sucios entre vistas
  limpiarCampos();
});

// inicializar vista
toggleClienteView();

// bot√≥n volver (si lo usas)
if (backToRoomsBtn) {
  backToRoomsBtn.addEventListener("click", () => {
    // tu l√≥gica para volver al paso anterior (ya exist√≠a)
    // por ejemplo:
    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    if (step2) step2.style.display = "none";
    if (step1) step1.style.display = "block";
    scrollToTop();
  });
}

// bot√≥n siguiente: construir clientData y validar seg√∫n tipo
if (nextToGuestsBtn) {
  nextToGuestsBtn.addEventListener("click", (e) => {
    e.preventDefault();

    const esJuridico = tipoSwitch.checked;

    if (!esJuridico) {
      // Persona Natural -> campos: num_doc, nombres, ape_paterno, ape_materno, telefono, pais
      const dniVal = numDocNatural.value.trim();
      const nombresVal = nombres.value.trim();
      const apePatVal = apePaterno.value.trim();
      const apeMatVal = apeMaterno.value.trim();
      const telefonoVal = telefonoNatural.value.trim();
      const paisVal = paisSelect.value;
      const tipo_doc_n = tipo_doc_natural_select.value;

      // validaciones
      if (!validarPersonaNatural()) return;
      
      clientData = {
        tipo: "N",
        num_doc: dniVal,
        nombres: nombresVal,
        ape_paterno: apePatVal,
        ape_materno: apeMatVal,
        telefono: telefonoVal || null,
        pais_id: paisVal,
        tipo_doc_id: tipo_doc_n,
        usuario_id: usuarioId
      };

    } else {
      // Persona Jur√≠dica -> campos: num_doc_juridico (RUC 11), razon_social, direccion, tipo_empresa
      const rucVal = numDocJuridico.value.trim();
      const razonVal = razonSocial.value.trim();
      const direccionVal = direccionJuridica.value.trim();
      const paisj = paisjuridica.value;
      const telefonoj = telefonojuridica.value.trim();
      const tipoempresaj = tipoempresa.value;
      // const tipoEmpVal = tipoEmpresa.value;

      if (!validarPersonaJuridica()) return;


      clientData = {
        tipo: "J",
        num_doc: rucVal,
        razon_social: razonVal,
        direccion: direccionVal,
        pais_id: paisj,
        telefono: telefonoj,
        tipoemp_id: tipoempresaj,
        usuario_id: usuarioId
      };
    }

    // si llega aqu√≠, clientData est√° listo
    console.log("ClientData preparado:", clientData);

    // aqu√≠ sigue la l√≥gica de tu app: generar formularios de hu√©spedes y avanzar al siguiente paso
    // por ejemplo:
    generarFormulariosHuespedes(); // si usas la funci√≥n que ya tienes

    const step2 = document.getElementById("step2");
    const step3 = document.getElementById("step3");
    if (step2) step2.style.display = "none";
    if (step3) step3.style.display = "block";
    // Actualizar visibilidad del temporizador
    if (window.bookingTimer && typeof window.bookingTimer.updateVisibility === 'function') {
      window.bookingTimer.updateVisibility();
    }
    scrollToTop();

    // guarda clientData en un scope global si lo necesitas:
    window.__CLIENT_DATA__ = clientData;
  });
}
</script>
<script>
document.getElementById("volver_home").addEventListener("click", () => {
  (async () => {
    const confirmed = await showBookingConfirm("¬øDeseas salir y volver al inicio?", "Confirmar salida");
    if (confirmed) {
      const homeUrl = window.BOOKING_HOME_URL || "/";
      window.location.replace(homeUrl);
    }
  })();
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const cardInput = document.getElementById("card_number");
  const logo = document.getElementById("card_logo");

  const cardPatterns = {
    visa: /^4[0-9]{0,}$/,
    mastercard: /^5[1-5][0-9]{0,}$/,
    amex: /^3[47][0-9]{0,}$/
  };

  const logos = {
    visa: "https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg",
    mastercard: "https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg",
    amex: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/fa/American_Express_logo_%282018%29.svg/640px-American_Express_logo_%282018%29.svg.png"
  };

  cardInput.addEventListener("input", () => {
    let value = cardInput.value.replace(/\D/g, ""); // eliminar espacios/no d√≠gitos
    cardInput.value = value.replace(/(.{4})/g, "$1 ").trim(); // formatea con espacios

    let found = false;
    for (const [brand, pattern] of Object.entries(cardPatterns)) {
      if (pattern.test(value)) {
        logo.src = logos[brand];
        logo.style.display = "block";
        found = true;
        break;
      }
    }

    if (!found) {
      logo.style.display = "none";
    }
  });
});
</script>


<script>
// Interceptar bot√≥n atr√°s, recarga y cierre de p√°gina
(function() {
  let isNavigatingAway = false;
  let isReloading = false;
  
  // Funci√≥n para verificar si estamos en el flujo de reserva
  function isInBookingFlow() {
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const step4 = document.getElementById('step4');
    const step5 = document.getElementById('step5');
    
    // Funci√≥n auxiliar para verificar si un elemento est√° visible
    function isElementVisible(el) {
      if (!el) return false;
      const style = window.getComputedStyle(el);
      return style.display !== 'none' && style.visibility !== 'hidden';
    }
    
    // Verificar si alg√∫n paso despu√©s del 1 est√° visible
    const isStep2Visible = isElementVisible(step2);
    const isStep3Visible = isElementVisible(step3);
    const isStep4Visible = isElementVisible(step4);
    const isStep5Visible = isElementVisible(step5);
    
    // Si SOLO el paso 5 est√° visible (comprobante), significa que el pago ya se complet√≥
    // En ese caso, NO estamos en el flujo activo de reserva
    if (isStep5Visible && !isStep2Visible && !isStep3Visible && !isStep4Visible) {
      return false; // Pago completado, permitir navegaci√≥n libre
    }
    
    // Tambi√©n verificar si hay habitaciones seleccionadas o datos guardados
    const hasSelectedRooms = typeof selectedRooms !== 'undefined' && selectedRooms && selectedRooms.length > 0;
    const hasClientData = typeof clientData !== 'undefined' && clientData && Object.keys(clientData).length > 0;
    const hasBookingData = localStorage.getItem('booking_pending_data') !== null;
    
    // Estamos en el flujo si:
    // 1. Alg√∫n paso 2, 3 o 4 est√° visible (pero NO solo el 5), O
    // 2. Hay habitaciones seleccionadas, O
    // 3. Hay datos de cliente guardados, O
    // 4. Hay datos en localStorage
    const isInFlow = isStep2Visible || isStep3Visible || isStep4Visible ||
                     hasSelectedRooms || hasClientData || hasBookingData;
    
    return isInFlow;
  }
  
  // Funci√≥n para limpiar todos los datos del formulario
  function clearAllBookingData() {
    // Limpiar localStorage
    localStorage.removeItem('booking_pending_data');
    
    // Limpiar sessionStorage del temporizador
    if (window.sessionStorage) {
      window.sessionStorage.removeItem('bookingTimerExpiration');
    }
    
    // Limpiar variables globales
    if (typeof selectedRooms !== 'undefined') {
      selectedRooms = [];
    }
    if (typeof selectedServices !== 'undefined') {
      selectedServices = [];
    }
    if (typeof clientData !== 'undefined') {
      clientData = {};
    }
    
    // Limpiar formularios
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
      form.reset();
    });
    
    // Limpiar checkboxes de habitaciones
    document.querySelectorAll('.checkbox_booking').forEach(cb => {
      cb.checked = false;
    });
    
    // Limpiar checkboxes de servicios (sistema antiguo)
    document.querySelectorAll('.service-checkbox').forEach(cb => {
      cb.checked = false;
      cb.closest('.service-card')?.classList.remove('selected');
    });
    
    // Limpiar cantidades de servicios (sistema nuevo)
    if (typeof serviceQuantities !== 'undefined') {
      serviceQuantities = {};
    }
    
    // Resetear displays de cantidad de servicios
    document.querySelectorAll('.service-card-horizontal').forEach(card => {
      const quantityDisplay = card.querySelector('.quantity-display');
      const totalDisplay = card.querySelector('.service-price-total');
      if (quantityDisplay) quantityDisplay.textContent = '0';
      if (totalDisplay) totalDisplay.textContent = '0.00';
      card.classList.remove('selected');
    });
    
    // Limpiar contenedores de habitaciones seleccionadas
    const selectedRoomsContainer = document.getElementById('selected_rooms');
    if (selectedRoomsContainer) {
      selectedRoomsContainer.innerHTML = '';
    }
    
    // Detener temporizador si est√° corriendo
    if (window.bookingTimer && typeof window.bookingTimer.stop === 'function') {
      window.bookingTimer.stop(false);
    }
  }
  
  // Funci√≥n para volver al inicio
  function navigateSafely(targetUrl) {
    isNavigatingAway = true;
    clearAllBookingData();
    window.location.replace(targetUrl);
  }

  function goToHome() {
    navigateSafely("{{ url_for('Index') }}");
  }
  
  // Funci√≥n para verificar si estamos en el paso 5 (pago completado)
  function isInStep5() {
    const step5 = document.getElementById('step5');
    if (!step5) return false;
    const style = window.getComputedStyle(step5);
    return style.display !== 'none' && style.visibility !== 'hidden';
  }
  
  // Interceptar bot√≥n atr√°s del navegador
  window.addEventListener('popstate', function(e) {
    // Si el timer expir√≥, permitir la redirecci√≥n sin alert
    if (window.isTimerExpired) {
      return;
    }
    
    // Si estamos en el paso 5 (pago completado), redirigir al index sin alerta
    if (isInStep5()) {
      history.pushState(null, null, window.location.href);
      goToHome();
      return;
    }
    
    if (isNavigatingAway) {
      return; // Permitir navegaci√≥n si ya confirmamos
    }
    
    if (isInBookingFlow()) {
      // Prevenir la navegaci√≥n hacia atr√°s
      history.pushState(null, null, window.location.href);
      
      // Usar async/await para manejar la promesa correctamente
      (async () => {
        const confirmed = await showBookingConfirm('¬øEst√°s seguro de que quieres salir? Si contin√∫as, ser√°s redirigido al inicio y se borrar√°n todos los datos ingresados.', 'Confirmar salida');
        if (confirmed) {
          goToHome();
        } else {
          // Si cancela, volver a agregar el estado al historial
          history.pushState(null, null, window.location.href);
        }
      })();
    }
  });
  
  // Interceptar teclas de recarga (F5, Ctrl+R, Ctrl+F5) ANTES del beforeunload
  document.addEventListener('keydown', function(e) {
    // Si el timer expir√≥, permitir la recarga sin alert
    if (window.isTimerExpired) {
      return;
    }
    
    // F5 o Ctrl+R o Ctrl+F5
    const isReloadKey = e.key === 'F5' || 
                        (e.ctrlKey && (e.key === 'r' || e.key === 'R')) || 
                        (e.ctrlKey && e.shiftKey && (e.key === 'R' || e.key === 'r'));
    
    if (isReloadKey) {
      // Si estamos en el paso 5 (pago completado), redirigir al index sin alerta
      if (isInStep5()) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        isReloading = true;
        clearAllBookingData();
        goToHome();
        return false;
      }
      
      // Verificar si estamos en el flujo de reserva
      // Tambi√©n permitir si la validaci√≥n de pago fall√≥ (redirecci√≥n autom√°tica)
      if (!isInBookingFlow() || isNavigatingAway || isReloading || window.isPaymentValidationFailed) {
        return;
      }
      
      // Prevenir el comportamiento por defecto
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      // Mostrar confirmaci√≥n
      (async () => {
        const confirmed = await showBookingConfirm('¬øEst√°s seguro de que quieres recargar la p√°gina? Si contin√∫as, se borrar√°n todos los datos ingresados.', 'Confirmar recarga');
        if (confirmed) {
          isReloading = true;
          clearAllBookingData();
          // Usar location.replace para evitar que se active beforeunload
          window.location.replace(window.location.href);
        }
      })();
      
      return false;
    }
  }, true); // Usar capture phase para interceptar antes que otros handlers
  
  // Tambi√©n interceptar el evento beforeunload para recargas del navegador
  // Nota: beforeunload no puede mostrar modales personalizados de manera confiable
  // porque la p√°gina est√° a punto de descargarse. Sin embargo, prevenimos la recarga
  // y el popup personalizado se mostrar√° cuando el usuario intente recargar usando teclas
  window.addEventListener('beforeunload', function(e) {
    // Si el timer expir√≥, permitir la redirecci√≥n sin alert
    if (window.isTimerExpired) {
      return;
    }
    
    // Si estamos en el paso 5 (pago completado), permitir navegaci√≥n sin alerta
    if (isInStep5()) {
      return;
    }
    
    // Si ya confirmamos la navegaci√≥n o recarga, permitir
    // Tambi√©n permitir si la validaci√≥n de pago fall√≥ (redirecci√≥n autom√°tica)
    if (isNavigatingAway || isReloading || window.isPaymentValidationFailed) {
      return;
    }
    
    // Solo interceptar si estamos en el flujo de reserva
    if (isInBookingFlow()) {
      // Prevenir la recarga/cierre
      // El popup personalizado se mostrar√° cuando el usuario use F5/Ctrl+R
      // debido a que interceptamos esas teclas antes de que se active beforeunload
      e.preventDefault();
      e.returnValue = '¬øEst√°s seguro de que quieres recargar la p√°gina? Se perder√°n todos los datos ingresados.'; // Chrome requiere returnValue
      return e.returnValue; // Algunos navegadores requieren return
    }
  });
  
  // Limpiar datos cuando realmente se cierra/recarga la p√°gina
  window.addEventListener('unload', function(e) {
    if (isNavigatingAway || isReloading) {
      return;
    }
    
    if (isInBookingFlow()) {
      // Limpiar datos al salir
      clearAllBookingData();
    }
  });
  
  // Interceptar clic en el bot√≥n de recarga del navegador (si es posible)
  // Nota: Esto solo funciona si el navegador lo permite
  window.addEventListener('pageshow', function(e) {
    // Si la p√°gina se carg√≥ desde cach√© (back/forward), verificar si necesitamos limpiar
    if (e.persisted && isInBookingFlow()) {
      // La p√°gina se carg√≥ desde cach√©, verificar si debemos limpiar datos
      const savedState = sessionStorage.getItem('booking_should_clear');
      if (savedState === 'true') {
        clearAllBookingData();
        sessionStorage.removeItem('booking_should_clear');
      }
    }
  });
  
  // Interceptar clics en nav, footer, header y logo cuando hay un flujo activo
  function attachNavigationGuards() {
    const selectors = [
      '.nav a',
      '.footer a',
      'header a',
      '.logo a',
      'h1 a'
      // Nota: 'header h1' se maneja por separado m√°s abajo para evitar duplicados
    ];

    const links = document.querySelectorAll(selectors.join(','));

    links.forEach(link => {
      // Excluir el H1 del logo si no tiene enlace (se maneja por separado)
      if (link.tagName === 'H1' && !link.querySelector('a')) {
        return;
      }
      
      // Verificar si ya tiene un listener para evitar duplicados
      if (link.hasAttribute('data-booking-link-listener')) {
        return;
      }
      
      link.setAttribute('data-booking-link-listener', 'true');
      link.addEventListener('click', function(e) {
        // Si el timer expir√≥, permitir la navegaci√≥n sin alert
        if (window.isTimerExpired) {
          return;
        }
        
        const targetUrl = this.href || "{{ url_for('Index') }}";

        if (!isInBookingFlow() || isNavigatingAway || window.isPaymentValidationFailed) {
          return;
        }

        e.preventDefault();
        e.stopPropagation();

        (async () => {
          const confirmed = await showBookingConfirm('¬øEst√°s seguro de que quieres salir? Si contin√∫as, se cancelar√° tu reserva.', 'Confirmar salida');
          if (confirmed) {
            navigateSafely(targetUrl);
          }
        })();
      });
    });
    
    // Interceptar clic en H1 logo (si no tiene enlace, redirigir al inicio)
    // Verificar si ya tiene un listener para evitar duplicados
    const h1Logo = document.querySelector('header h1, h1.logo, .logo h1');
    if (h1Logo && !h1Logo.querySelector('a') && !h1Logo.hasAttribute('data-booking-listener')) {
      h1Logo.setAttribute('data-booking-listener', 'true');
      h1Logo.style.cursor = 'pointer';
      h1Logo.addEventListener('click', function(e) {
        // Si el timer expir√≥, permitir la navegaci√≥n sin alert
        if (window.isTimerExpired) {
          window.location.href = "{{ url_for('Index') }}";
          return;
        }
        
        if (!isInBookingFlow() || isNavigatingAway || window.isPaymentValidationFailed) {
          window.location.href = "{{ url_for('Index') }}";
          return;
        }

        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation(); // Prevenir que otros listeners se ejecuten

        (async () => {
          const confirmed = await showBookingConfirm('¬øEst√°s seguro de que quieres salir? Si contin√∫as, se cancelar√° tu reserva.', 'Confirmar salida');
          if (confirmed) {
            goToHome();
          }
        })();
      }, true); // Usar capture phase para interceptar antes que otros listeners
    }
  }

  // Agregar un estado inicial al historial
  window.addEventListener('DOMContentLoaded', () => {
    history.pushState(null, null, window.location.href);
    attachNavigationGuards();
  });
})();
</script>

{% endblock %}
