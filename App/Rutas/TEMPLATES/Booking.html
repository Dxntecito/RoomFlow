{% extends "Master.html" %}

{% block stiles %}
<link rel="stylesheet" href="{{ url_for('static', filename='CSS/Booking.css') }}">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Arimo:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='CSS/Booking_huespedes.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='CSS/pago.css') }}">


{% endblock %}

{% block content %}
<div id="booking_room_page">

  <!-- üîπ PASO 1: Selecci√≥n de habitaciones -->
  <div id="step1">
    <h2 class="booking_tittle">RESERVA DE HABITACIONES</h2>

    <form method="GET" action="{{ url_for('bookingroom.BookingRoom') }}">
      <div id="booking_date" class="green_round_div">
        <h3 class="Booking_web_subheaders" id="leftTittleG">Fechas de reserva</h3>
        <div class="booking_column">
          <label for="Start_booking_date" class="booking_label">Fecha de entrada</label>
          <input type="datetime-local"
                id="Start_booking_date"
                name="start"
                class="date_input"
                {% if start_dt is not none %}
                  value="{{ start_dt.strftime('%Y-%m-%dT%H:%M') }}"
                {% else %}
                  value=""
                {% endif %}>
        </div>

        <div id="divider"></div>

        <div class="booking_column">
          <label for="End_booking_date" class="booking_label">Fecha salida</label>
          <input type="datetime-local"
                id="End_booking_date"
                name="end"
                class="date_input"
                {% if end_dt is not none %}
                  value="{{ end_dt.strftime('%Y-%m-%dT%H:%M') }}"
                {% else %}
                  value=""
                {% endif %}>
        </div>


        <button type="submit">
          <img id="search_button_img" src="{{ url_for('static', filename='Img/search_button.png') }}" alt="search_icon">
        </button>
      </div>
    </form>

    <div id="Booking_Filters">
      <h2 class="Booking_web_subheaders" id="block_titles">Filtros</h2>
      <label for="floor_number" class="booking_label">Nro. de Piso</label>
      <select class="select_design" id="floor_number" name="floor_number">
        <option value="">-- Selecciona una opci√≥n --</option>
        {% for floor in floors %}
        <option value="{{ floor[0] }}">{{ floor[1] }}</option>
        {% endfor %}
      </select>

      <label for="room_category" class="booking_label">Categor√≠a</label>
      <select class="select_design" id="room_category" name="turno">
        <option value="">-- Selecciona una opci√≥n --</option>
        {% for category in categories %}
        <option value="{{ category[0] }}">{{ category[1] }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <h2 class="Booking_web_subheaders" id="block_titles">Habitaciones elegidas</h2>
      <div class="green_round_div_2" id="summary_booking">
        <div id="selected_rooms"></div>
        <div id="summary_footer">
          <p id="Total_sum">Total: S/. 0.00</p>
          <p><a href="#" class="booking_label" id="next_booking_link">‚Üí Siguiente</a></p>
        </div>
      </div>
    </div>

    <table id="booking_room_available" class="booking_label" border="1">
      <thead>
        <tr>
          <th>Piso</th>
          <th>N¬∞ Habitaci√≥n</th>
          <th>Categor√≠a</th>
          <th>Capacidad</th>
          <th>Precio</th>
          <th>Reservar</th>
        </tr>
      </thead>
      <tbody>
        {% for room in rooms %}
        <tr class="room-row" data-floor="{{ room[4] }}" data-category="{{ room[3] }}">
          {% for floor in floors %}
          {% if room[4] == floor[0] %}
          <td>Piso {{ floor[1] }}</td>
          {% endif %}
          {% endfor %}
          <td>{{ room[1] }}</td>
          {% for category in categories %}
          {% if room[3] == category[0] %}
          <td>{{ category[1] }}</td>
          <td>{{ category[4] }} Personas</td>
          {% endif %}
          {% endfor %}
          <td class="price" data-room-id="{{ room[0] }}">{{ room[5] }}</td>
          <td><input class="checkbox_booking" type="checkbox" name="booking_{{ room[0] }}" value="{{ room[0] }}"
                     id="checkbox_booking_{{ room[0] }}"></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

<!-- PASO 2: Registro de cliente -->
<div id="step2" style="display:none;">
  <h2>Registro del Cliente</h2>
  <form id="client_form" autocomplete="off">


  <div class="switch_container" style="display:flex; align-items:center; gap:10px; margin:8px 0;">
    <label class="switch_label">Natural</label>
    <label class="switch">
      <input type="checkbox" id="tipo_cliente_switch">
      <span class="slider round"></span>
    </label>
    <label class="switch_label">Jur√≠dica</label>
  </div>
  <label id="tipo_cliente_label">Persona Natural</label>
  <!-- ---------- Campos Persona Natural ---------- -->
  <div id="natural_fields">
    <label for="num_doc_natural">Tipo Documento</label>
    <select id="tipo_doc_natural">
      <option value="">-- Seleccione Tipo Documento --</option>
      {% for type_doc in types_doc %}
        {% if type_doc[1] != "RUC" %}
          <option value="{{ type_doc[0] }}" data-nombre="{{ type_doc[1] }}">{{ type_doc[1] }}</option>
        {% endif %}
      {% endfor %}
    </select>

    </select>
    <input type="text" id="num_doc_natural" maxlength="8" placeholder="Ej: 87654321">

    <label for="nombres">Nombres</label>
    <input type="text" id="nombres" placeholder="Nombres">

    <label for="ape_paterno">Apellido Paterno</label>
    <input type="text" id="ape_paterno" placeholder="Apellido paterno">

    <label for="ape_materno">Apellido Materno</label>
    <input type="text" id="ape_materno" placeholder="Apellido materno">

    <label for="telefono_natural">Tel√©fono</label>
    <input type="text" id="telefono_natural" placeholder="987654321">

    <label for="pais_select">Pa√≠s</label>
    <select id="pais_select">
      <option value="">-- Seleccione pa√≠s --</option>
      {% for country in countries %}
      <option value="{{ country[0] }}">{{ country[1] }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- ---------- Campos Persona Jur√≠dica (ocultos por defecto) ---------- -->
  <div id="juridica_fields" style="display:none;">
    <label for="num_doc_juridico">RUC (11 d√≠gitos)</label>
    <input type="text" id="num_doc_juridico" maxlength="11" placeholder="Ej: 20123456789">

    <label for="razon_social">Raz√≥n Social</label>
    <input type="text" id="razon_social" placeholder="Nombre de la empresa">

        <label for="tipo_empresa">Tipo de Empresa</label>
    <select id="tipo_empresa">
      <option value="">-- Seleccione Tipo de Empresa --</option>
      {% for type_emp in types_emp %}
      <option value="{{ type_emp[0] }}">{{ type_emp[1] }}</option>
      {% endfor %}
    </select>

    <label for="direccion_juridica">Direcci√≥n</label>
    <input type="text" id="direccion_juridica" placeholder="Direcci√≥n fiscal">

    <label for="telefono_juridico">Tel√©fono</label>
    <input type="text" id="telefono_juridico" placeholder="987654321" maxlength="9">

    <!-- <label for="tipo_empresa">Tipo de Empresa</label>
    <select id="tipo_empresa">
      <option value="">-- Seleccione tipo --</option>
      <option value="1">Individual</option>
      <option value="2">Sociedad An√≥nima</option>
      <option value="3">EIRL</option>
    </select> -->
    <label for="pais_select_j">Pa√≠s</label>
    <select id="pais_select_j">
      <option value="">-- Seleccione pa√≠s --</option>
      {% for country in countries %}
      <option value="{{ country[0] }}">{{ country[1] }}</option>
      {% endfor %}
      <!-- si tienes la lista desde el backend, reemplaza estas opciones dinamicamente -->
    </select>
  </div>

  <div class="button_group" style="margin-top:12px;">
    <button type="button" id="back_to_rooms">‚Üê Regresar</button>
    <button type="button" id="next_to_guests">Siguiente ‚Üí</button>
  </div>
</form>

</div>

  <!-- PASO 3: Registro de hu√©spedes -->
  <div id="step3" style="display:none;">
    <h2>Registro de Hu√©spedes por Habitaci√≥n</h2>
    <div id="habitaciones_container"></div>

    <div class="button_group">
      <button type="button" id="back_to_client">‚Üê Regresar</button>
      <button type="submit" id="payment_phase">Continuar al Pago</button>
      <button type="submit" id="finalizar_reserva" style="display:none">Finalizar Reserva</button>
    </div>
  </div>

  <!-- PASO 4: Facturaci√≥n / Pago
<div id="step4" style="display:none;">
  <h2>Facturaci√≥n y pago</h2>

  <section id="payment_method_section">
    <label class="booking_label">M√©todo de pago:</label>
    <div>
      <label><input type="radio" name="payment_method" value="card" checked> Tarjeta (cr√©dito/d√©bito)</label>
      <label style="margin-left:1rem;"><input type="radio" name="payment_method" value="wallet"> Billetera electr√≥nica</label>
    </div>
  </section>

  <form id="card_form" autocomplete="off">
    <h3>Datos de la tarjeta</h3>
    <div>
      <label class="booking_label">Titular</label>
      <input type="text" id="card_holder" placeholder="Nombre como en la tarjeta" required>
    </div>
    <div>
      <label class="booking_label">N√∫mero de tarjeta</label>
      <input type="text" id="card_number" placeholder="1234 5678 9012 3456" maxlength="19" inputmode="numeric" required>
    </div>
    <div style="display:flex; gap:10px;">
      <div style="flex:1;">
        <label class="booking_label">Expiraci√≥n (MM/AA)</label>
        <input type="text" id="card_exp" placeholder="MM/AA" maxlength="5" required>
      </div>
      <div style="width:120px;">
        <label class="booking_label">CVV</label>
        <input type="password" id="card_cvv" placeholder="123" maxlength="4" required>
      </div>
    </div>
  </form>

  <section id="payment_summary">
    <h3>Resumen de pago</h3>
    <div id="payment_items"></div>
    <p id="payment_total"><strong>Total:</strong> S/. <span id="payment_total_amount">0.00</span></p>
  </section>

  <div class="button_group">
    <button type="button" id="back_to_step3">‚Üê Volver</button>
    <button type="button" id="process_payment">Realizar pago</button>
  </div>
</div> -->

<!-- PASO 4: Facturaci√≥n / Pago (lo dejamos, pero lo ocultamos al guardar reserva) -->
<div id="step4" style="display:none;">
  <h2>Facturaci√≥n y pago</h2>

  <section id="payment_method_section">
    <label class="booking_label">M√©todo de pago:</label>
    <div>
      <label><input type="radio" name="payment_method" value="2" checked> Tarjeta (cr√©dito/d√©bito)</label>
      <label style="margin-left:1rem;"><input type="radio" name="payment_method" value="3"> Billetera electr√≥nica</label>
    </div>
  </section>

  <form id="card_form" autocomplete="off">
    <h3>Datos de la tarjeta</h3>
    <div>
      <label class="booking_label">Titular</label>
      <input type="text" id="card_holder" placeholder="Nombre como en la tarjeta" required>
    </div>
    <div>
      <label class="booking_label">N√∫mero de tarjeta</label>
      <input type="text" id="card_number" placeholder="1234 5678 9012 3456" maxlength="19" inputmode="numeric" required>
    </div>
    <div style="display:flex; gap:10px;">
      <div style="flex:1;">
        <label class="booking_label">Expiraci√≥n (MM/AA)</label>
        <input type="text" id="card_exp" placeholder="MM/AA" maxlength="5" required>
      </div>
      <div style="width:120px;">
        <label class="booking_label">CVV</label>
        <input type="password" id="card_cvv" placeholder="123" maxlength="4" required>
      </div>
    </div>
  </form>

  <section id="payment_summary">
    <h3>Resumen de pago</h3>
    <div id="payment_items"></div>
    <p id="payment_total"><strong>Total:</strong> S/. <span id="payment_total_amount">0.00</span></p>
  </section>

  <div class="button_group">
    <button type="button" id="back_to_step3">‚Üê Volver</button>
    <button type="button" id="process_payment">Realizar pago</button>
  </div>
</div>

<!-- PASO 5: Comprobante / Descarga -->
<div id="step5" style="display:none;">
  <h2>Pago completado ‚Äî Comprobante</h2>
  <p>Tu reserva se guard√≥ correctamente. Descarga tu comprobante aqu√≠:</p>

  <div style="display:flex; gap:12px; align-items:center;">
    <a id="download_comprobante_link" class="btn" href="#" target="_blank" download style="display:none;">Descargar comprobante (PDF)</a>
    <button id="open_comprobante_newtab" style="display:none;">Abrir comprobante en nueva pesta√±a</button>
    <p id="comprobante_status" style="margin:0 0 0 8px;color:#333;"></p>
  </div>

  <div style="margin-top:16px;">
    <button id="volver_home">Volver al inicio</button>
  </div>
</div>


</div>
<script src="{{ url_for('static', filename='JS/Booking.js') }}"></script>
<script>
  // --- Referencias generales ---
  const step1 = document.getElementById("step1");
  const step2 = document.getElementById("step2");
  const step3 = document.getElementById("step3");
  const floorSelect = document.getElementById("floor_number");
  const selectedContainer = document.getElementById("selected_rooms");
  const categorySelect = document.getElementById("room_category");
  const totalDisplay = document.getElementById("Total_sum");
  const nextLink = document.getElementById("next_booking_link");
  const backToRooms = document.getElementById("back_to_rooms");
  const nextToGuests = document.getElementById("next_to_guests");
  const backToClient = document.getElementById("back_to_client");
  const finalizarReserva = document.getElementById("finalizar_reserva");
  const habitacionesContainer = document.getElementById("habitaciones_container");
  

  // --- Variables de estado ---
  let total = 0;
  let selectedRooms = [];
  let clientData = {};

   // Diccionarios generados por Jinja: id -> nombre, id -> precio
    const roomNames = {
        {% for room in rooms %}
            "{{ room[0] }}": "{{ room[1] }}"{% if not loop.last %},{% endif %}
        {% endfor %}
    };
    const roomPrices = {
        {% for room in rooms %}
            "{{ room[0] }}": {{ room[5] }}{% if not loop.last %},{% endif %}
        {% endfor %}
    };
    
        // --- Filtrado de filas seg√∫n selects ---
    function filterRows() {
        const selFloor = floorSelect.value;      // valor string o ""
        const selCategory = categorySelect.value;

        // recorrer cada fila
        document.querySelectorAll('.room-row').forEach(row => {
            const rowFloor = row.dataset.floor;      // string
            const rowCategory = row.dataset.category;

            let show = true;
            if (selFloor && selFloor !== "" && selFloor !== rowFloor) show = false;
            if (selCategory && selCategory !== "" && selCategory !== rowCategory) show = false;

            const checkbox = row.querySelector('.checkbox_booking');

            if (show) {
                row.style.display = "";
            } else {
                // Si la fila se oculta y est√° marcada, desmarcarla y disparar change para limpiar selecci√≥n
                if (checkbox && checkbox.checked) {
                    checkbox.checked = false;
                    // dispatchEvent para que el manejador de checkbox limpie la UI y el total
                    checkbox.dispatchEvent(new Event('change'));
                }
                row.style.display = "none";
            }
        });
    }
     // Escuchar cambios en selects
    floorSelect.addEventListener('change', filterRows);
    categorySelect.addEventListener('change', filterRows);


    // Si tu tabla se actualiza din√°micamente (por ejemplo por AJAX) necesitas re-run bindCheckboxEvents()
    function bindCheckboxEvents() {
    document.querySelectorAll('.checkbox_booking').forEach(cb => {
      if (cb.dataset.bound === "true") return;
      cb.dataset.bound = "true";

      cb.addEventListener('change', function() {
        const roomId = this.value;
        const price = parseFloat(roomPrices[roomId]) || 0;

        if (this.checked) {
          if (!selectedRooms.includes(roomId)) selectedRooms.push(roomId);
          total += price;
          createSelectedRoomDiv(roomId);
        } else {
          selectedRooms = selectedRooms.filter(id => id !== roomId);
          total -= price;
          if (total < 0) total = 0;
          const el = document.getElementById("room_selected_" + roomId);
          if (el) el.remove();
        }
        updateTotalDisplay();
      });
    });
  }

  function createSelectedRoomDiv(roomId) {
    const roomName = roomNames[roomId];
    const price = parseFloat(roomPrices[roomId]) || 0;
    // Si ya existe, no duplicar
    if (document.getElementById("room_selected_" + roomId)) return;

    const div = document.createElement("div");
    div.className = "room_selected_style";
    div.id = "room_selected_" + roomId;
    div.innerHTML = `
      <p>Hab. ${roomName} ‚Äî S/. ${price.toFixed(2)}</p>
      <button type="button" class="remove_room">x</button>
    `;
    selectedContainer.appendChild(div);

    // evento X para quitar
    div.querySelector(".remove_room").addEventListener("click", () => {
      const cb = document.getElementById("checkbox_booking_" + roomId);
      if (cb) {
        cb.checked = false;
        cb.dispatchEvent(new Event('change'));
      } else {
        // si no hay checkbox (caso raro), solo eliminar y ajustar total
        div.remove();
        total -= price;
        if (total < 0) total = 0;
        updateTotalDisplay();
        selectedRooms = selectedRooms.filter(id => id !== roomId);
      }
    });
  }
    function updateTotalDisplay() {
    totalDisplay.textContent = "Total: S/. " + total.toFixed(2);
  }
    // Si quieres aplicar el filtro al cargar con valores por defecto:
    filterRows();

  // --- Datos de habitaciones generados con Jinja ---
const roomCapacities = {
  {% for room in rooms %}
    "{{ room[0] }}": {% for category in categories %}{% if room[3] == category[0] %}{{ category[4] }}{% endif %}{% endfor %}{% if not loop.last %},{% endif %}
  {% endfor %}
};

  // --- Selecci√≥n de habitaciones ---
  document.querySelectorAll('.checkbox_booking').forEach(cb => {
    cb.addEventListener('change', function() {
      const roomId = this.value;
      const roomName = roomNames[roomId];
      const price = parseFloat(roomPrices[roomId]) || 0;
      
      if (this.checked) {
        selectedRooms.push(roomId);
        total += price;

        const div = document.createElement("div");
        div.className = "room_selected_style";
        div.id = "room_selected_" + roomId;
        div.innerHTML = `
          <p>Hab. ${roomName} ‚Äî S/. ${price.toFixed(2)}</p>
          <button type="button" class="remove_room">x</button>
        `;
        selectedContainer.appendChild(div);

        div.querySelector(".remove_room").addEventListener("click", () => {
          cb.checked = false;
          cb.dispatchEvent(new Event('change'));
        });
      } else {
        selectedRooms = selectedRooms.filter(id => id !== roomId);
        total -= price;
        document.getElementById("room_selected_" + roomId)?.remove();
      }

      totalDisplay.textContent = "Total: S/. " + total.toFixed(2);
    });
  });

  // --- Paso 1 ‚Üí Paso 2 (Cliente) ---
  nextLink.addEventListener("click", e => {
    e.preventDefault();
    if (selectedRooms.length === 0) {
      alert("Seleccione al menos una habitaci√≥n antes de continuar.");
      return;
    }
    step1.style.display = "none";
    step2.style.display = "block";
  });

  // --- Paso 2 ‚Üí Paso 1 ---
  backToRooms.addEventListener("click", () => {
    step2.style.display = "none";
    step1.style.display = "block";
  });
  

  // --- Paso 3 ‚Üí Paso 2 ---
  backToClient.addEventListener("click", () => {
    step3.style.display = "none";
    step2.style.display = "block";
  });

  // referencias
  const tipoSwitch = document.getElementById("tipo_cliente_switch");
  const tipoLabel = document.getElementById("tipo_cliente_label");
  const naturalFields = document.getElementById("natural_fields");
  const juridicaFields = document.getElementById("juridica_fields");
  const nextToGuestsBtn = document.getElementById("next_to_guests");
  const backToRoomsBtn = document.getElementById("back_to_rooms");

  // inputs naturales
  const numDocNatural = document.getElementById("num_doc_natural");
  const nombres = document.getElementById("nombres");
  const apePaterno = document.getElementById("ape_paterno");
  const apeMaterno = document.getElementById("ape_materno");
  const telefonoNatural = document.getElementById("telefono_natural");
  const paisSelect = document.getElementById("pais_select");
  const startDateInput = document.getElementById("Start_booking_date");
  const endDateInput = document.getElementById("End_booking_date");
  const tipo_doc_natural_select = document.getElementById("tipo_doc_natural");
  // inputs juridicos
  const numDocJuridico = document.getElementById("num_doc_juridico");
  const paisjuridica = document.getElementById("pais_select_j");
  const razonSocial = document.getElementById("razon_social");
  const direccionJuridica = document.getElementById("direccion_juridica");
  const telefonojuridica = document.getElementById("telefono_juridico");
  const tipoempresa = document.getElementById("tipo_empresa");
  let tipo_validacion;
  // const tipoEmpresa = document.getElementById("tipo_empresa");

  // correo (opcional/global)
  const correoCliente = document.getElementById("correo_cliente");

  // estado de cliente que construir√°s

  // funci√≥n para alternar vistas seg√∫n switch
  function toggleClienteView() {
    const esJuridico = tipoSwitch.checked;
    if (esJuridico) {
      tipoLabel.textContent = "Persona Jur√≠dica";
      naturalFields.style.display = "none";
      juridicaFields.style.display = "block";
    } else {
      tipoLabel.textContent = "Persona Natural";
      naturalFields.style.display = "block";
      juridicaFields.style.display = "none";
    }
  }

  // limpiar campos al cambiar tipo (opcional, recomendable)
  function limpiarCampos() {
    // naturales
    numDocNatural.value = "";
    nombres.value = "";
    apePaterno.value = "";
    apeMaterno.value = "";
    telefonoNatural.value = "";
    paisSelect.value = "";

    // juridicos
    numDocJuridico.value = "";
    razonSocial.value = "";
    direccionJuridica.value = "";
    paisjuridica.value="";
    // tipoEmpresa.value = "";
  }

  // validar DNI (8 d√≠gitos) y RUC (11 d√≠gitos) - solo n√∫meros
  document.getElementById("tipo_doc_natural").addEventListener("change", function() {
  const selectedOption = this.options[this.selectedIndex];
  const tipoNombre = selectedOption.getAttribute("data-nombre");
  const inputNumDoc = document.getElementById("num_doc_natural");

  if (tipoNombre === "DNI") {
    inputNumDoc.maxLength = 8;
    inputNumDoc.placeholder = "Ej: 87654321";
    inputNumDoc.oninput = function () {
      this.value = this.value.replace(/\D/g, ""); // Solo n√∫meros
    };
    tipo_validacion = 1;
  } else if (tipoNombre === "Pasaporte") {
    inputNumDoc.maxLength = 12; // puedes ajustar seg√∫n el formato que uses
    inputNumDoc.placeholder = "Ej: ABC123456";
    tipo_validacion = 0;
  } else {
    inputNumDoc.maxLength = 20;
    inputNumDoc.placeholder = "Ingrese documento";
  }

  // Limpiamos el campo cuando se cambia el tipo
  inputNumDoc.value = "";
});
  function esDniValido(dni) {
    return /^[0-9]{8}$/.test(dni);
  }
  function esRucValido(ruc) {
    return /^[0-9]{11}$/.test(ruc);
  }

  function esPasaporteValido(pasaporte) {
  return /^[A-Za-z0-9]{6,12}$/.test(pasaporte);
}

const telefonoInput = document.getElementById("telefono_natural");

telefonoInput.addEventListener("input", function () {
  // Eliminar todo lo que no sea n√∫mero
  this.value = this.value.replace(/\D/g, "");

  // Forzar que empiece con 9
  if (this.value.length === 1 && this.value !== "9") {
    this.value = ""; // Si el primer d√≠gito no es 9, se borra
  }

  // Limitar a 9 d√≠gitos
  if (this.value.length > 9) {
    this.value = this.value.slice(0, 9);
  }
});


  // on switch change
  tipoSwitch.addEventListener("change", () => {
    toggleClienteView();
    // opcional: limpiar campos para evitar datos sucios entre vistas
    limpiarCampos();
  });

  // inicializar vista
  toggleClienteView();

  // bot√≥n volver (si lo usas)
  if (backToRoomsBtn) {
    backToRoomsBtn.addEventListener("click", () => {
      // tu l√≥gica para volver al paso anterior (ya exist√≠a)
      // por ejemplo:
      const step1 = document.getElementById("step1");
      const step2 = document.getElementById("step2");
      if (step2) step2.style.display = "none";
      if (step1) step1.style.display = "block";
    });
  }

  // bot√≥n siguiente: construir clientData y validar seg√∫n tipo
  if (nextToGuestsBtn) {
    nextToGuestsBtn.addEventListener("click", (e) => {
      e.preventDefault();

      const esJuridico = tipoSwitch.checked;

      if (!esJuridico) {
        // Persona Natural -> campos: num_doc, nombres, ape_paterno, ape_materno, telefono, pais
        const dniVal = numDocNatural.value.trim();
        const nombresVal = nombres.value.trim();
        const apePatVal = apePaterno.value.trim();
        const apeMatVal = apeMaterno.value.trim();
        const telefonoVal = telefonoNatural.value.trim();
        const paisVal = paisSelect.value;
        const tipo_doc_n =tipo_doc_natural_select.value;

        // validaciones
        if (!dniVal || !nombresVal || !apePatVal || !apeMatVal || !paisVal || !tipo_doc_n) {
          alert("Complete todos los campos obligatorios para Persona Natural (DNI, nombres, apellidos y pa√≠s).");
          return;
        }
        if (tipo_validacion == 1) {
            if (!esDniValido(dniVal)) {
            alert("DNI inv√°lido. Debe contener 8 d√≠gitos num√©ricos.");
            return;
          }
        }
        else{
           if (!esPasaporteValido(dniVal)) {
            alert("Pasaporte inv√°lido. Debe contener 12 d√≠gitos num√©ricos.");
            return;
          }
        }
        

        clientData = {
          tipo: "N",
          num_doc: dniVal,
          nombres: nombresVal,
          ape_paterno: apePatVal,
          ape_materno: apeMatVal,
          telefono: telefonoVal || null,
          pais_id: paisVal,
          tipo_doc_id: tipo_doc_n,
        };

      } else {
        // Persona Jur√≠dica -> campos: num_doc_juridico (RUC 11), razon_social, direccion, tipo_empresa
        const rucVal = numDocJuridico.value.trim();
        const razonVal = razonSocial.value.trim();
        const direccionVal = direccionJuridica.value.trim();
        const paisj = paisjuridica.value;
        const telefonoj = telefonojuridica.value.trim();
        const tipoempresaj = tipoempresa.value;
        // const tipoEmpVal = tipoEmpresa.value;

        // validaciones
        if (!rucVal || !razonVal || !direccionVal || !paisj || !telefonoj || !tipoempresaj ) {
          alert("Complete todos los campos obligatorios para Persona Jur√≠dica (RUC, raz√≥n social, direcci√≥n, tipo de empresa).");
          return;
        }
        if (!esRucValido(rucVal)) {
          alert("RUC inv√°lido. Debe contener 11 d√≠gitos num√©ricos.");
          return;
        }

        clientData = {
          tipo: "J",
          num_doc: rucVal,
          razon_social: razonVal,
          direccion: direccionVal,
          pais_id: paisj,
          telefono: telefonoj,
          tipoemp_id: tipoempresaj,
        };
      }

      // si llega aqu√≠, clientData est√° listo
      console.log("ClientData preparado:", clientData);

      // aqu√≠ sigue la l√≥gica de tu app: generar formularios de hu√©spedes y avanzar al siguiente paso
      // por ejemplo:
      // generarFormulariosHuespedes();  // si usas la funci√≥n que ya tienes
    generarFormulariosHuespedes();
      const step2 = document.getElementById("step2");
      const step3 = document.getElementById("step3");
      if (step2) step2.style.display = "none";
      if (step3) step3.style.display = "block";

      // guarda clientData en un scope global si lo necesitas:
      window.__CLIENT_DATA__ = clientData;
      
    });
  }

// --- Despu√©s de generar las habitaciones (en generarFormulariosHuespedes) ---
function bindYoMeHospedareControls() {
  // seleccionamos siempre los checkboxes actuales
  const checkboxes = document.querySelectorAll(".yoHospedare");

  checkboxes.forEach(cb => {
    // evitar a√±adir m√∫ltiples listeners si ya hay uno
    cb.removeEventListener('_yoHospedare_change_', cb._yoHospedareHandler); // noop si no existe

    const handler = (e) => {
      const target = e.target;
      const currentId = target.id; // ej "yoHospedare_3"
      // Si est√° marcado -> ocultar y deshabilitar los dem√°s
      if (target.checked) {
        checkboxes.forEach(other => {
          if (other === target) return; // saltar el propio
          // desmarcar por si acaso
          other.checked = false;
          // deshabilitar para que no se pueda activar
          other.disabled = true;
          // ocultar checkbox y su label asociado (si existe)
          other.style.display = "none";
          const lab = document.querySelector(`label[for="${other.id}"]`);
          if (lab) lab.style.display = "none";
        });
      } else {
        // Si se desmarca -> restaurar todos los dem√°s
        checkboxes.forEach(other => {
          if (other === target) return;
          other.disabled = false;
          // restaurar display (vacio para que recupere su estilo por defecto)
          other.style.display = "";
          const lab = document.querySelector(`label[for="${other.id}"]`);
          if (lab) lab.style.display = "";
        });
      }

      // adem√°s: ajustar campos de huespedes seg√∫n el checkbox activo
      // (mantengo tu l√≥gica original: si se marca, reducir la cantidad de hu√©spedes en esa habitaci√≥n)
      const roomId = target.dataset.room;
      const select = document.getElementById(`numPersonas_${roomId}`);
      if (target.checked) {
        // ocultar otros switches visualmente ya hecho; ahora regeneramos campos
        const num = parseInt(select.value) || 1;
        generarCamposHuespedes(roomId, Math.max(num - 1, 0));
      } else {
        generarCamposHuespedes(roomId);
      }
    };

    // Guardar referencia para poder remover listener en regeneraciones posteriores
    cb._yoHospedareHandler = handler;
    cb.addEventListener('change', handler);
  });
}

// Llama a bindYoMeHospedareControls() al final de generarFormulariosHuespedes()
// por ejemplo, modifica tu funci√≥n as√≠:

function generarFormulariosHuespedes() {
  habitacionesContainer.innerHTML = "";
  selectedRooms.forEach(roomId => {
    const capacidad = parseInt(roomCapacities[roomId]) || 1;
    const div = document.createElement("div");
    div.className = "habitacion_form";
    div.innerHTML = `
      <h3>Habitaci√≥n ${roomNames[roomId]}</h3>
      <label>Cantidad de personas:</label>
      <select class="numPersonas" id="numPersonas_${roomId}" data-room="${roomId}">
        ${Array.from({length: capacidad}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('')}
      </select>
      <div class="yo_container">
        <input type="checkbox" class="yoHospedare" data-room="${roomId}" id="yoHospedare_${roomId}">
        <label for="yoHospedare_${roomId}">Yo me hospedar√© aqu√≠</label>
      </div>
      <div class="contenedorHuespedes" id="huespedes_${roomId}"></div>
    `;
    habitacionesContainer.appendChild(div);

    const select = div.querySelector(".numPersonas");
    select.addEventListener("change", () => generarCamposHuespedes(roomId));
    generarCamposHuespedes(roomId);
  });

  // bindear comportamiento de "yoHospedare"
  bindYoMeHospedareControls();
}


  function generarCamposHuespedes(roomId, cantidadManual = null) {
    const contenedor = document.getElementById(`huespedes_${roomId}`);
    const cantidad = cantidadManual ?? parseInt(document.getElementById(`numPersonas_${roomId}`)?.value) ?? 1;
    if (!contenedor) return;
    contenedor.innerHTML = "";
    for (let i = 1; i <= cantidad; i++) {
      contenedor.innerHTML += `
        <div class="huesped_card">
          <h4>Hu√©sped ${i}</h4>
          <input class="nombre_huesped" placeholder="Nombre">
          <input class="apellido_huesped" placeholder="Apellido Paterno">
          <input class ="apellido_huesped_m" placeholder="Apellido Materno">
          <input class="doc_huesped" placeholder="N¬∞ Documento" maxlength="8">
        </div>
      `;
    }
  }
function recolectarDatosReserva() {
    const fechaEntradaRaw = startDateInput?.value || null;
    const fechaSalidaRaw = endDateInput?.value || null;

    let fecha_ingreso = null, hora_ingreso = null;
    let fecha_salida = null, hora_salida = null;

    if (fechaEntradaRaw) {
      if (fechaEntradaRaw.includes("T")) {
        const [fecha, hora] = fechaEntradaRaw.split("T");
        fecha_ingreso = fecha;
        hora_ingreso = hora ? (hora.length === 5 ? hora + ":00" : hora) : null;
      } else {
        fecha_ingreso = fechaEntradaRaw;
        hora_ingreso = null;
      }
    }
    if (fechaSalidaRaw) {
      if (fechaSalidaRaw.includes("T")) {
        const [fecha, hora] = fechaSalidaRaw.split("T");
        fecha_salida = fecha;
        hora_salida = hora ? (hora.length === 5 ? hora + ":00" : hora) : null;
      } else {
        fecha_salida = fechaSalidaRaw;
        hora_salida = null;
      }
    }

    const habitaciones = selectedRooms.map(roomId => {
      const huespedesDivs = document.querySelectorAll(`#huespedes_${roomId} .huesped_card`);
      const huespedes = Array.from(huespedesDivs).map(div => ({
        nombre: div.querySelector(".nombre_huesped")?.value || "",
        ape_paterno: div.querySelector(".apellido_huesped")?.value || "",
        ape_materno : div.querySelector(".apellido_huesped_m")?.value || "",
        documento: div.querySelector(".doc_huesped")?.value || ""
      }));
      const yoHospedare = document.getElementById(`yoHospedare_${roomId}`)?.checked || false;
      return {
        id_habitacion: roomId,
        nombre: roomNames[roomId],
        precio: roomPrices[roomId],
        huespedes: huespedes,
        yo_me_hospedo: yoHospedare
      };
    });

    return {
      cliente: clientData,
      habitaciones: habitaciones,
      total: total,
      fecha_reserva: new Date().toISOString(),
      fecha_ingreso: fecha_ingreso,
      hora_ingreso: hora_ingreso,
      fecha_salida: fecha_salida,
      hora_salida: hora_salida
    };
  }


// --- STEP4: Facturaci√≥n / Pago ---

const step3El = document.getElementById("step3");
const step4El = document.getElementById("step4");
const backToStep3Btn = document.getElementById("back_to_step3");
const processPaymentBtn = document.getElementById("process_payment");
const paymentItemsDiv = document.getElementById("payment_items");
const paymentTotalAmount = document.getElementById("payment_total_amount");
const cardForm = document.getElementById("card_form");
const paymentMethodInputs = document.getElementsByName("payment_method");



// Volver a step3
backToStep3Btn?.addEventListener("click", () => {
  if (step4El) step4El.style.display = "none";
  if (step3El) step3El.style.display = "block";
});
document.getElementById("payment_phase")?.addEventListener("click", (e) => {
  e.preventDefault();
  // valida que haya habitaciones seleccionadas
  if (!selectedRooms || selectedRooms.length === 0) {
    alert("Seleccione al menos una habitaci√≥n antes de proceder al pago.");
    return;
  }
  // ocultar paso 3, mostrar paso 4
  if (step3El) step3El.style.display = "none";
  if (step4El) {
    populatePaymentSummary();
    step4El.style.display = "block";
  }
});

// Si el usuario cambia el m√©todo de pago, ocultar/mostrar formularios
Array.from(paymentMethodInputs).forEach(r => {
  r.addEventListener("change", () => {
    const method = document.querySelector('input[name="payment_method"]:checked')?.value;
    if (method === "card") {
      cardForm.style.display = "block";
    } else {
      // por ahora no implementado -> ocultar formulario de tarjeta
      cardForm.style.display = "none";
    }
  });
});

// Rellena el resumen con las habitaciones seleccionadas y el total
function populatePaymentSummary() {
  paymentItemsDiv.innerHTML = "";
  let localTotal = 0;

  if (!selectedRooms || selectedRooms.length === 0) {
    paymentItemsDiv.innerHTML = "<p>No hay habitaciones seleccionadas.</p>";
    paymentTotalAmount.textContent = "0.00";
    return;
  }

  selectedRooms.forEach(id => {
    const name = (typeof roomNames !== 'undefined' && roomNames[id]) ? roomNames[id] : id;
    const price = (typeof roomPrices !== 'undefined' && roomPrices[id]) ? parseFloat(roomPrices[id]) : 0;
    localTotal += price;
    const item = document.createElement("div");
    item.className = "payment_item";
    item.innerHTML = `<span>Habitaci√≥n ${name}</span> <span>S/. ${price.toFixed(2)}</span>`;
    paymentItemsDiv.appendChild(item);
  });

  // si la variable global total existe, preferimos usarla (por si hay descuentos o c√°lculo adicional)
  const finalTotal = (typeof total !== 'undefined' && !isNaN(total)) ? parseFloat(total) : localTotal;
  paymentTotalAmount.textContent = finalTotal.toFixed(2);
}

// --- HANDLER ORDENADO: pago -> guardar reserva -> crear transaccion -> generar comprobante ---
// Asume que existen variables globales: selectedRooms (array de ids), roomNames (id->name),
// roomPrices (id->price), total (opcional, n√∫mero)

document.addEventListener("DOMContentLoaded", () => {

  // Referencias DOM
  const processPaymentBtn = document.getElementById("process_payment");
  const finalizarReservaBtn = document.getElementById("finalizar_reserva");
  const step3El = document.getElementById("step3");
  const step4El = document.getElementById("step4");
  const step5El = document.getElementById("step5");
  const paymentItemsDiv = document.getElementById("payment_items");
  const paymentTotalAmount = document.getElementById("payment_total_amount");
  const downloadLink = document.getElementById("download_comprobante_link") || document.createElement("a");
  const openNewTabBtn = document.getElementById("open_comprobante_newtab");
  const comprobanteStatus = document.getElementById("comprobante_status");
  const volverHome = document.getElementById("volver_home");

  // Helper: calcular total desde selectedRooms/roomPrices si `total` no existe
  function computeFinalTotal() {
    if (typeof total !== 'undefined' && !isNaN(total)) return parseFloat(total);
    let sum = 0;
    if (Array.isArray(selectedRooms)) {
      selectedRooms.forEach(id => {
        const p = (roomPrices && roomPrices[id]) ? parseFloat(roomPrices[id]) : 0;
        sum += (isNaN(p) ? 0 : p);
      });
    }
    return sum;
  }

  // Helper: descarga blob como archivo
  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // Mostrar resumen de pago (llenado sencillo)
  function populatePaymentSummary() {
    paymentItemsDiv.innerHTML = "";
    let localTotal = 0;
    if (!Array.isArray(selectedRooms) || selectedRooms.length === 0) {
      paymentItemsDiv.innerHTML = "<p>No hay habitaciones seleccionadas.</p>";
      paymentTotalAmount.textContent = "0.00";
      return;
    }
    selectedRooms.forEach(id => {
      const name = (typeof roomNames !== 'undefined' && roomNames[id]) ? roomNames[id] : id;
      const price = (typeof roomPrices !== 'undefined' && roomPrices[id]) ? parseFloat(roomPrices[id]) : 0;
      localTotal += isNaN(price) ? 0 : price;
      const item = document.createElement("div");
      item.className = "payment_item";
      item.innerHTML = `<span>Habitaci√≥n ${name}</span> <span>S/. ${ (isNaN(price) ? 0 : price).toFixed(2) }</span>`;
      paymentItemsDiv.appendChild(item);
    });
    const final = computeFinalTotal();
    paymentTotalAmount.textContent = Number(final || localTotal).toFixed(2);
  }

  // UI: cambio de m√©todo de pago (muestra/oculta form tarjeta)
  Array.from(document.getElementsByName("payment_method") || []).forEach(r => {
    r.addEventListener("change", () => {
      const method = document.querySelector('input[name="payment_method"]:checked')?.value;
      const cardForm = document.getElementById("card_form");
      if (cardForm) cardForm.style.display = (method === "card") ? "block" : "none";
    });
  });

  // Al pulsar "Realizar pago" (desde step3) mostramos resumen y step4
  document.getElementById("payment_phase")?.addEventListener("click", (e) => {
    e.preventDefault();
    if (!selectedRooms || selectedRooms.length === 0) {
      alert("Seleccione al menos una habitaci√≥n antes de proceder al pago.");
      return;
    }
    if (step3El) step3El.style.display = "none";
    if (step4El) {
      populatePaymentSummary();
      step4El.style.display = "block";
    }
  });

  // --- processPaymentBtn: valida tarjeta (si aplica), prepara dataReserva y habilita finalizar ---
  processPaymentBtn?.addEventListener("click", async () => {
    console.group("%c[PAGO] Iniciando validaci√≥n y pre-procesamiento", "color: teal; font-weight: bold;");
    const method = document.querySelector('input[name="payment_method"]:checked')?.value || 'card';

    // Validaciones de tarjeta si m√©todo card
    if (method === 'card') {
      const holder = document.getElementById("card_holder")?.value.trim();
      const number = (document.getElementById("card_number")?.value || "").replace(/\s+/g, '');
      const exp = document.getElementById("card_exp")?.value.trim();
      const cvv = document.getElementById("card_cvv")?.value.trim();

      console.log("[PAGO] M√©todo card seleccionado. Validando campos de tarjeta...");
      if (!holder || !number || !exp || !cvv) {
        alert("Complete todos los datos de la tarjeta.");
        console.groupEnd();
        return;
      }
      if (!/^\d{13,19}$/.test(number)) { alert("N√∫mero de tarjeta inv√°lido."); console.groupEnd(); return; }
      if (!/^\d{2}\/\d{2}$/.test(exp)) { alert("Fecha de expiraci√≥n inv√°lida. Formato MM/AA."); console.groupEnd(); return; }
      if (!/^\d{3,4}$/.test(cvv)) { alert("CVV inv√°lido."); console.groupEnd(); return; }
    }

    // Mostrar resumen actualizado
    populatePaymentSummary();
    alert("Pago validado (simulado). A continuaci√≥n podr√° finalizar la reserva.");
    if (finalizarReservaBtn) {
    console.log("[PAGO] Ejecutando autom√°ticamente click en Finalizar Reserva...");
    finalizarReservaBtn.click();
  } else {
    console.warn("[PAGO] No se encontr√≥ el bot√≥n finalizarReservaBtn en el DOM.");
  }

  console.groupEnd();
  });


  // --- finalizarReservaBtn: flujo completo (guardar reserva -> guardar transaccion -> generar comprobante) ---
  if (finalizarReservaBtn) {
    finalizarReservaBtn.addEventListener("click", async () => {
      finalizarReservaBtn.disabled = true;
      finalizarReservaBtn.textContent = "Guardando reserva...";
      console.group("%c[FINALIZAR] Inicio del flujo guardar_reserva -> transaccion -> comprobante", "color: blue; font-weight: bold;");

      // RECOLECTAR datos de reserva (usa tu funci√≥n existente)
      let dataReserva;
      try {
        if (typeof recolectarDatosReserva !== 'function') throw new Error("recolectarDatosReserva() no encontrada");
        dataReserva = recolectarDatosReserva();
        console.log("[FINALIZAR] dataReserva:", dataReserva);
      } catch (err) {
        console.error("[FINALIZAR] Error construyendo dataReserva:", err);
        alert("No se pudieron recolectar los datos de la reserva. Revisa la consola.");
        finalizarReservaBtn.disabled = false;
        finalizarReservaBtn.textContent = "Finalizar Reserva";
        console.groupEnd();
        return;
      }

      // 1) Guardar reserva
      let reservaId = null;
      try {
        console.log("[FINALIZAR] Enviando request a /Rutas/TEMPLATES/guardar_reserva ...");
        const resp = await fetch("/Rutas/TEMPLATES/guardar_reserva", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dataReserva)
        });

        const rawText = await resp.text();
        console.log("[FINALIZAR] Response HTTP:", resp.status, resp.ok);
        console.log("[FINALIZAR] Response RAW:", rawText);

        let result;
        try { result = JSON.parse(rawText); console.log("[FINALIZAR] JSON parseado:", result); }
        catch (e) { console.error("[FINALIZAR] No se pudo parsear JSON:", e); alert("Respuesta inesperada del servidor. Revisa la consola."); throw e; }

        if (resp.ok && result && result.success && result.reserva_id) {
          reservaId = result.reserva_id;
          console.log("[FINALIZAR] Reserva guardada OK. ID:", reservaId);
        } else {
          console.error("[FINALIZAR] El backend devolvi√≥ un formato inesperado:", result);
          alert("Ocurri√≥ un problema al guardar la reserva. Revisa la consola.");
          throw new Error("Formato de respuesta inv√°lido al guardar reserva");
        }
      } catch (errSave) {
        console.error("[FINALIZAR] Error guardando reserva:", errSave);
        finalizarReservaBtn.disabled = false;
        finalizarReservaBtn.textContent = "Finalizar Reserva";
        console.groupEnd();
        return;
      }

       const selectedPaymentRadio = document.querySelector('input[name="payment_method"]:checked');
      if (!selectedPaymentRadio) {
        alert("Por favor, selecciona un m√©todo de pago antes de continuar.");
        console.warn("‚ö†Ô∏è No se seleccion√≥ ning√∫n m√©todo de pago.");
        return;
      }

      const selectedPaymentMethod = parseInt(selectedPaymentRadio.value); // 2 = Tarjeta, 3 = Billetera
      const metodoPago = document.querySelector('input[name="payment_method"]:checked')?.value || 'card';
      const metodoPagoId = (metodoPago === 'card') ? 1 : 2; // <-- adapta ids de METODO_PAGO en tu BD
      const FinalTotal = computeFinalTotal();

      console.group("üì¶ Datos enviados a /Rutas/guardar_transaccion");
      console.log("reservaId:", reservaId);
      console.log("metodo_pago_id:", selectedPaymentMethod);
      console.log("FinalTotal:", FinalTotal);
      console.log("estado:", 1);
      console.groupEnd();
      // 2) Guardar transacci√≥n (si la reserva se guard√≥)
      try {
        // toma valores: m√©todo de pago y monto final
        // --- Obtener m√©todo de pago seleccionado del grupo de radios ---
      


        
        console.log("[FINALIZAR] Enviando transacci√≥n:", { reservaId, metodoPago, metodoPagoId, FinalTotal });

        const transResp = await fetch("/Rutas/guardar_transaccion", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            reservaId: reservaId,
            paymentMethodInputs: selectedPaymentMethod, // el controlador sabe mapear strings a ids
            finalTotal: FinalTotal,
            estado: 1
          })
        });

        const transText = await transResp.text();
        console.log("[FINALIZAR] transResp HTTP:", transResp.status, transResp.ok);
        console.log("[FINALIZAR] transResp RAW:", transText);

        let transResult;
        try { transResult = JSON.parse(transText); console.log("[FINALIZAR] transResult:", transResult); }
        catch (e) { console.error("[FINALIZAR] No se parse√≥ transResult:", e); throw e; }

        if (!(transResp.ok && transResult && (transResult.transaccion_id || transResult.success))) {
          console.warn("[FINALIZAR] La creaci√≥n de la transacci√≥n devolvi√≥ error o formato inesperado:", transResult);
          // no abortamos el flujo ‚Äî dependiendo de tu l√≥gica puedes abortar aqu√≠
          alert("Advertencia: No se pudo guardar la transacci√≥n correctamente.");
        } else {
          console.log("[FINALIZAR] Transacci√≥n registrada OK:", transResult);
        }

      } catch (errTrans) {
        console.error("[FINALIZAR] Error guardando transacci√≥n:", errTrans);
        alert("Error al guardar la transacci√≥n. Revisa la consola.");
        // Continuamos para al menos generar el comprobante de la reserva
      }

      // 3) Generar comprobante (PDF) y mostrar paso 5
      try {
        if (step4El) step4El.style.display = "none";
        if (step5El) step5El.style.display = "block";
        if (comprobanteStatus) comprobanteStatus.textContent = "Generando comprobante...";

        console.log("[FINALIZAR] Solicitando PDF a /Rutas/crear_comprobante/" + encodeURIComponent(reservaId));
        const pdfResp = await fetch(`/Rutas/crear_comprobante/${encodeURIComponent(reservaId)}`, {
          method: "GET",
          headers: { "Accept": "application/pdf" }
        });

        if (!pdfResp.ok) {
          const txt = await pdfResp.text();
          console.error("[FINALIZAR] Error al generar PDF. Status:", pdfResp.status, "Body:", txt);
          throw new Error("No se pudo generar el comprobante PDF");
        }

        const pdfBlob = await pdfResp.blob();
        const filename = `Comprobante_${reservaId}.pdf`;
        downloadBlob(pdfBlob, filename);

        if (comprobanteStatus) comprobanteStatus.textContent = "Comprobante generado correctamente.";
        console.log("[FINALIZAR] Comprobante generado y descargado:", filename);

      } catch (errPdf) {
        console.error("[FINALIZAR] Error generando comprobante:", errPdf);
        if (comprobanteStatus) comprobanteStatus.textContent = "Error generando comprobante. Intente descargar luego.";
        alert("Se produjo un error al generar el comprobante. Revisa la consola.");
      }

      // Final: re-habilitar bot√≥n y mostrar mensaje
      finalizarReservaBtn.disabled = false;
      finalizarReservaBtn.textContent = "Finalizar Reserva";
      alert("Proceso finalizado. Revisa el comprobante descargado o la consola para detalles.");
      console.groupEnd();
    });
  }

});

</script>

{% endblock %}
